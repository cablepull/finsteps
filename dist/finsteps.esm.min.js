var O=class{extractIdFromPatterns(t,e){for(let s of e){let a=t.match(s);if(a&&a[1])return a[1]}return null}getElementClassName(t){return typeof t.className=="string"?t.className:t.className.baseVal}hasTargetableClass(t){let e=this.getElementClassName(t);return this.getTargetableClasses().some(a=>e.includes(a))}escapeSelector(t){return typeof CSS<"u"&&typeof CSS.escape=="function"?CSS.escape(t):t.replace(/[^a-zA-Z0-9_-]/g,"\\$&")}};var U=class extends O{getDiagramType(){return"flowchart"}getTargetableClasses(){return["node"]}getTargetableTags(){return["g"]}extractNodeIds(t){let e=new Map,s=[/^[a-zA-Z0-9-]+-([A-Za-z0-9_]+)-\d+$/,/^[a-zA-Z0-9-]+-\d+-([A-Za-z0-9_]+)$/,/^node-([A-Za-z0-9_]+)$/,/^flowchart-([A-Za-z0-9_]+)-/];for(let a of Array.from(t.querySelectorAll("[id]"))){let n=a.getAttribute("id");if(!n)continue;let c=this.extractIdFromPatterns(n,s);if(c&&!e.has(c)){let i=a,l=null;for(;i&&i!==t;){if(i instanceof SVGElement&&i.tagName==="g"){let o=this.getElementClassName(i);if(o&&o.includes("node")){l=i;break}}i=i.parentElement}l?e.set(c,l):a.tagName==="g"&&this.hasTargetableClass(a)&&e.set(c,a)}}return e}getTargetSelectors(t){let e=this.escapeSelector(t);return[`g.node[data-id="${e}"]`,`g[class*="node"][data-id="${e}"]`,`[data-id="${e}"]`]}findAdjacentElements(t,e){if(!t.getAttribute("data-id"))return[];let a;try{let o=t.getBBox(),u=t.getAttribute("transform");if(u&&u.includes("translate")){let d=u.match(/translate\s*\(\s*([-\d.]+)\s*[, ]\s*([-\d.]+)\s*\)/);if(d){let m=parseFloat(d[1]),p=parseFloat(d[2]);a=new DOMRect(o.x+m,o.y+p,o.width,o.height)}else a=o}else a=o}catch{return[]}let n=a.x+a.width/2,c=a.y+a.height/2,i=Array.from(e.querySelectorAll('path.edge, path[class*="edge"], g.edge path, path[id*="edge"]')),l=new Set;for(let o of i)try{let u=o.getBBox(),d=u.x+u.width/2,m=u.y+u.height/2,p=Math.max(a.width,a.height)*1.5,S=Math.sqrt(Math.pow(d-n,2)+Math.pow(m-c,2)),N=u.x<a.x+a.width&&u.x+u.width>a.x&&u.y<a.y+a.height&&u.y+u.height>a.y,x=o.getAttribute("d"),$=!1;if(x){let D=x.match(/[ML]\s*([-\d.]+)\s+([-\d.]+)/g);if(D)for(let k of D){let g=k.match(/[ML]\s*([-\d.]+)\s+([-\d.]+)/);if(g){let h=parseFloat(g[1]),f=parseFloat(g[2]);if(Math.sqrt(Math.pow(h-n,2)+Math.pow(f-c,2))<p){$=!0;break}}}}if(N||$||S<p){let D=Array.from(e.querySelectorAll("g.node[data-id]"));for(let k of D)if(k!==t&&!l.has(k))try{let g=k.getBBox(),h=k.getAttribute("transform"),f=g;if(h&&h.includes("translate")){let R=h.match(/translate\s*\(\s*([-\d.]+)\s*[, ]\s*([-\d.]+)\s*\)/);if(R){let P=parseFloat(R[1]),V=parseFloat(R[2]);f=new DOMRect(g.x+P,g.y+V,g.width,g.height)}}let T=f.x+f.width/2,E=f.y+f.height/2,v=Math.sqrt(Math.pow(T-d,2)+Math.pow(E-m,2));(f.x<u.x+u.width&&f.x+f.width>u.x&&f.y<u.y+u.height&&f.y+f.height>u.y||v<p)&&l.add(k)}catch{continue}}}catch{continue}return Array.from(l)}};var be={linear:r=>r,ease:r=>r<.5?2*r*r:-1+(4-2*r)*r,easeIn:r=>r*r,easeOut:r=>r*(2-r),easeInOut:r=>r<.5?2*r*r:-1+(4-2*r)*r,cubicIn:r=>r*r*r,cubicOut:r=>--r*r*r+1,cubicInOut:r=>r<.5?4*r*r*r:(r-1)*(2*r-2)*(2*r-2)+1,quadIn:r=>r*r,quadOut:r=>r*(2-r),quadInOut:r=>r<.5?2*r*r:-1+(4-2*r)*r,quartIn:r=>r*r*r*r,quartOut:r=>1- --r*r*r*r,quartInOut:r=>r<.5?8*r*r*r*r:1-8*--r*r*r*r,quintIn:r=>r*r*r*r*r,quintOut:r=>1+--r*r*r*r*r,quintInOut:r=>r<.5?16*r*r*r*r*r:1+16*--r*r*r*r*r,sineIn:r=>1-Math.cos(r*Math.PI/2),sineOut:r=>Math.sin(r*Math.PI/2),sineInOut:r=>-(Math.cos(Math.PI*r)-1)/2,expoIn:r=>r===0?0:Math.pow(2,10*(r-1)),expoOut:r=>r===1?1:1-Math.pow(2,-10*r),expoInOut:r=>r===0?0:r===1?1:r<.5?Math.pow(2,20*r-10)/2:(2-Math.pow(2,-20*r+10))/2,circIn:r=>1-Math.sqrt(1-r*r),circOut:r=>Math.sqrt(1- --r*r),circInOut:r=>r<.5?(1-Math.sqrt(1-4*r*r))/2:(Math.sqrt(1-4*(r-1)*(r-1))+1)/2,backIn:r=>2.70158*r*r*r-1.70158*r*r,backOut:r=>1+2.70158*Math.pow(r-1,3)+1.70158*Math.pow(r-1,2),backInOut:r=>{let e=2.5949095;return r<.5?Math.pow(2*r,2)*((e+1)*2*r-e)/2:(Math.pow(2*r-2,2)*((e+1)*(r*2-2)+e)+2)/2}};function Me(r){return be[r]||be.easeOut}var xe=r=>{let t=r.viewBox?.baseVal;return t&&t.width&&t.height?`${t.x} ${t.y} ${t.width} ${t.height}`:r.getAttribute("viewBox")};function Be(r,t,e){return e.findAdjacentElements(r,t)}var ge=(r,t=40)=>{let e=r.getAttribute("data-initial-viewbox");if(e)return e;let s=null;for(let D of Array.from(r.children))if(D instanceof SVGGElement){s=D;break}let a=1/0,n=1/0,c=-1/0,i=-1/0;if(s)try{let D=s.getBBox();a=D.x,n=D.y,c=D.x+D.width,i=D.y+D.height}catch{}let l=c-a,o=i-n,u=xe(r),d={width:0,height:0};if(u){let D=u.split(" ").map(Number);D.length===4&&(d={width:D[2],height:D[3]})}let m={width:0,height:0};if(e){let D=e.split(" ").map(Number);D.length===4&&(m={width:D[2],height:D[3]})}if(!isFinite(a)||!isFinite(n)||!isFinite(c)||!isFinite(i)||l<10||o<10||d.width>0&&l<d.width*.1||m.width>0&&l<m.width*.5){let D=[];for(let k of Array.from(r.children))k instanceof SVGGraphicsElement&&D.push(k);D.length===0&&D.push(...Array.from(r.querySelectorAll("g, rect, circle, ellipse, line, polyline, polygon, path, text"))),a=1/0,n=1/0,c=-1/0,i=-1/0;for(let k of D)try{let g=k.getBBox();isFinite(g.x)&&isFinite(g.y)&&isFinite(g.width)&&isFinite(g.height)&&g.width>0&&g.height>0&&(a=Math.min(a,g.x),n=Math.min(n,g.y),c=Math.max(c,g.x+g.width),i=Math.max(i,g.y+g.height))}catch{continue}}let S=c-a,N=i-n,x=m.width>0&&S<m.width*.7;if(!isFinite(a)||!isFinite(n)||!isFinite(c)||!isFinite(i)||S<10||N<10||d.width>0&&S<d.width*.1||x){if(e&&m.width>0&&m.height>0)return e;if(u)return u;let D=r.getAttribute("width"),k=r.getAttribute("height");if(D&&k){let g=parseFloat(D)||1e3,h=parseFloat(k)||1e3;return`0 0 ${g} ${h}`}return null}let $={x:a-t,y:n-t,width:S+t*2,height:N+t*2};return`${$.x} ${$.y} ${$.width} ${$.height}`};function $e(r){if(!r)return null;let t=r.split(" ").map(Number);return t.length!==4||t.some(isNaN)?null:{x:t[0],y:t[1],width:t[2],height:t[3]}}function Oe(r,t,e,s,a){return new Promise(n=>{if(!t){r.setAttribute("viewBox",`${e.x} ${e.y} ${e.width} ${e.height}`),n();return}let c=performance.now(),i=l=>{let o=l-c,u=Math.min(o/s,1),d=a(u),m={x:t.x+(e.x-t.x)*d,y:t.y+(e.y-t.y)*d,width:t.width+(e.width-t.width)*d,height:t.height+(e.height-t.height)*d};r.setAttribute("viewBox",`${m.x} ${m.y} ${m.width} ${m.height}`),u<1?requestAnimationFrame(i):(r.setAttribute("viewBox",`${e.x} ${e.y} ${e.width} ${e.height}`),n())};requestAnimationFrame(i)})}var we=r=>{let t=r.getRoot(),e=r.getContainer(),s=xe(t),a=!1,n=0,c=0,i=(m,p)=>{let S=t.viewBox?.baseVal;if(!S||!S.width||!S.height)return;let N={x:S.x,y:S.y,width:S.width,height:S.height},x=t.clientWidth||S.width,$=t.clientHeight||S.height,D=N.width/x,k=N.height/$,g=N.x-m*D,h=N.y-p*k;t.setAttribute("viewBox",`${g} ${h} ${N.width} ${N.height}`)},l=m=>{m.button===0&&(m.target?.closest("button")||m.target?.closest(".nav-btn")||m.target?.closest(".dataid-chip")||m.target?.closest("a")||(a=!0,n=m.clientX,c=m.clientY,e.style.cursor="grabbing",e.style.userSelect="none",m.preventDefault()))},o=m=>{if(!a)return;let p=m.clientX-n,S=m.clientY-c;i(p,S),n=m.clientX,c=m.clientY,m.preventDefault()},u=()=>{a&&(a=!1,e.style.cursor="grab",e.style.userSelect="")},d=()=>{a&&(a=!1,e.style.cursor="grab",e.style.userSelect="")};return e.style.cursor="grab",e.addEventListener("mousedown",l),document.addEventListener("mousemove",o),document.addEventListener("mouseup",u),e.addEventListener("mouseleave",d),{fit(m,p){if(m instanceof SVGGraphicsElement)try{let S=m.getBBox(),N=m instanceof SVGElement?m.getAttribute("transform"):null,x=S;if(N&&N.includes("translate"))try{let P=N.match(/translate\s*\(\s*([-\d.]+)\s*[, ]\s*([-\d.]+)\s*\)/);if(P){let V=parseFloat(P[1]),M=parseFloat(P[2]);x=new DOMRect(S.x+V,S.y+M,S.width,S.height)}}catch{}let $=p?.padding??16,D=40;x.height<D&&(x=new DOMRect(x.x,x.y-D/2,x.width||D,D)),x.width<D&&(x=new DOMRect(x.x-D/2,x.y,D,x.height||D));let k=r.getStrategy?.()||new U,g=Be(m,t,k),h=x;for(let P of g)try{let V=P.getBBox(),M=P.getAttribute("transform"),I=V;if(M&&M.includes("translate")){let A=M.match(/translate\s*\(\s*([-\d.]+)\s*[, ]\s*([-\d.]+)\s*\)/);if(A){let G=parseFloat(A[1]),q=parseFloat(A[2]);I=new DOMRect(V.x+G,V.y+q,V.width,V.height)}}let w=Math.min(h.x,I.x),B=Math.min(h.y,I.y),b=Math.max(h.x+h.width,I.x+I.width),C=Math.max(h.y+h.height,I.y+I.height);h=new DOMRect(w,B,b-w,C-B)}catch{continue}if(x=h,!isFinite(x.width)||!isFinite(x.height)||x.width<=0||x.height<=0){let P=m.parentElement;if(P instanceof SVGGraphicsElement){let V=P.getBBox();if(isFinite(V.width)&&isFinite(V.height)&&V.width>0&&V.height>0){let M={x:V.x-$,y:V.y-$,width:V.width+$*2,height:V.height+$*2};t.setAttribute("viewBox",`${M.x} ${M.y} ${M.width} ${M.height}`);return}}return}let f=null;try{let P=Array.from(t.children).find(V=>V instanceof SVGGElement);P&&(f=P.getBBox())}catch{}if(f&&(x.x<f.x||x.y<f.y||x.x+x.width>f.x+f.width||x.y+x.height>f.y+f.height)){let P=Math.min(h.x,f.x),V=Math.min(h.y,f.y),M=Math.max(h.x+h.width,f.x+f.width),I=Math.max(h.y+h.height,f.y+f.height);h=new DOMRect(P,V,M-P,I-V)}let T=h,E={x:T.x-$,y:T.y-$,width:T.width+$*2,height:T.height+$*2},v=`${E.x} ${E.y} ${E.width} ${E.height}`,L=p?.duration??0,R=p?.easing??"easeOut";if(L<=0)t.setAttribute("viewBox",v);else{let P=$e(t.getAttribute("viewBox")),V=E,M=Me(R);return Oe(t,P,V,L,M)}}catch(S){console.warn("Failed to get bounding box for camera.fit:",S)}},reset(){let m=ge(t);m?t.setAttribute("viewBox",m):s&&t.setAttribute("viewBox",s)},zoom(m,p){let S=t.viewBox?.baseVal;if(!S||!S.width||!S.height)return;let N={x:S.x,y:S.y,width:S.width,height:S.height},x=p??{x:N.x+N.width/2,y:N.y+N.height/2},$=N.width/m,D=N.height/m,k=x.x-$/2,g=x.y-D/2;t.setAttribute("viewBox",`${k} ${g} ${$} ${D}`)},pan(m,p){let S=t.viewBox?.baseVal;if(!S||!S.width||!S.height)return;let N={x:S.x,y:S.y,width:S.width,height:S.height},x=t.clientWidth||S.width,$=t.clientHeight||S.height,D=N.width/x,k=N.height/$,g=N.x+m*D,h=N.y+p*k;t.setAttribute("viewBox",`${g} ${h} ${N.width} ${N.height}`)},fitAll(m=40){let p=ge(t,m);p&&t.setAttribute("viewBox",p)},destroy(){e.removeEventListener("mousedown",l),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",u),e.removeEventListener("mouseleave",d),e.style.cursor="",e.style.userSelect="";let m=ge(t);m?t.setAttribute("viewBox",m):s&&t.setAttribute("viewBox",s)}}};var De=()=>{let r=document.createElement("div");r.className="finsteps-overlay",r.style.position="fixed",r.style.top="0",r.style.left="0",r.style.width="0",r.style.height="0",r.style.pointerEvents="none",document.body.appendChild(r);let t=new Map,e=()=>{for(let n of t.values()){let c=n.target.getBoundingClientRect(),i=n.element.getBoundingClientRect(),l=Math.max(8,c.top-i.height-8),o=Math.max(8,c.left+c.width/2-i.width/2);n.element.style.top=`${l}px`,n.element.style.left=`${o}px`}},s=()=>e(),a=()=>e();return window.addEventListener("scroll",s,!0),window.addEventListener("resize",a),{showBubble({id:n="default",target:c,text:i}){let l=t.get(n);if(!l){let o=document.createElement("div");o.className="finsteps-bubble",o.style.position="fixed",o.style.padding="8px 12px",o.style.borderRadius="8px",o.style.background="rgba(15, 23, 42, 0.95)",o.style.color="#fff",o.style.font="14px/1.4 sans-serif",o.style.maxWidth="240px",o.style.pointerEvents="none",r.appendChild(o),l={id:n,element:o,target:c},t.set(n,l)}l.target=c,l.element.textContent=i,requestAnimationFrame(e)},hideBubble(n="default"){let c=t.get(n);c&&(c.element.remove(),t.delete(n))},destroy(){window.removeEventListener("scroll",s,!0),window.removeEventListener("resize",a);for(let n of t.values())n.element.remove();t.clear(),r.remove()}}};var W=class extends Error{constructor(t,e){super(t),this.name="MPFError",this.code=e}},fe=class extends W{constructor(t,e="MPF_PARSE_ERROR"){super(t,e),this.name="ParseError"}},J=class extends W{constructor(t,e="MPF_ACTION_INVALID_ARGS"){super(t,e),this.name="ActionError"}};var ve=r=>typeof CSS<"u"&&typeof CSS.escape=="function"?CSS.escape(r):r.replace(/[^a-zA-Z0-9_-]/g,"\\$&"),H=(r,t)=>{if(!t)return null;if(t.element)return t.element;let e=r.getRoot(),s=null;if(t.selector)s=e.querySelector(t.selector),!s&&typeof document<"u"&&(s=document.querySelector(t.selector));else if(t.id)s=e.querySelector(`#${ve(t.id)}`);else if(t.dataId){let a=r.getStrategy?.()||new U,n=a.getTargetSelectors(t.dataId),c={location:"targetResolver.ts:35",message:"resolving target by dataId",data:{dataId:t.dataId,diagramType:a.getDiagramType(),selectors:n},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"C"},i=a.getDiagramType();(i==="c4Component"||t.dataId&&["controller","service","repo","api","db"].includes(t.dataId))&&console.log("[TargetResolver]",c.message,c.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)}).catch(()=>{});for(let l of n)if(s=e.querySelector(l),s){let o={location:"targetResolver.ts:46",message:"target found",data:{dataId:t.dataId,diagramType:i,selector:l,elementTag:s.tagName},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"C"};(i==="c4Component"||t.dataId&&["controller","service","repo","api","db"].includes(t.dataId))&&console.log("[TargetResolver]",o.message,o.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}).catch(()=>{});break}if(!s&&e instanceof Element&&e.getAttribute("data-id")===t.dataId){s=e;let l={location:"targetResolver.ts:62",message:"target found on root element",data:{dataId:t.dataId,diagramType:i,elementTag:s.tagName},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"C"};(i==="c4Component"||i==="c4Container"||i==="c4Context"||t.dataId&&["controller","service","repo","api","db","webapp","web","user"].includes(t.dataId))&&(console.log("[TargetResolver]",l.message,l.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)}).catch(()=>{}))}if(!s){let l=Array.from(e.querySelectorAll("[data-id]")).map(u=>u.getAttribute("data-id")).filter(u=>u),o={location:"targetResolver.ts:56",message:"target NOT found",data:{dataId:t.dataId,diagramType:i,selectors:n,availableDataIds:l.slice(0,20)},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"C"};(i==="c4Component"||t.dataId&&["controller","service","repo","api","db"].includes(t.dataId))&&console.log("[TargetResolver]",o.message,o.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}).catch(()=>{})}}if(!s)return null;if(!(s instanceof SVGGraphicsElement)||s.tagName==="text"||s instanceof SVGElement&&(typeof s.className=="string"&&s.className.includes("flowchart-label")||typeof s.className!="string"&&s.className.baseVal.includes("flowchart-label"))){let a=s;for(;a;){let n=a.parentElement;if(!n||n===e)break;if(n instanceof SVGGraphicsElement){if(n.tagName==="g"){if((n instanceof SVGElement?typeof n.className=="string"?n.className:n.className.baseVal:"").includes("node")&&n!==e&&n.getAttribute("data-id")===t?.dataId)return n;let i=n.parentElement;if(i===e||i&&i.tagName==="svg"){a=n;continue}}if(n===e)break}a=n}if(a instanceof SVGGraphicsElement&&a!==e){let n=a.parentElement;if(n&&n.tagName!=="svg")return a}}if(s instanceof SVGGraphicsElement&&s.tagName!=="g"){let a=s.parentElement;if(a instanceof SVGGraphicsElement&&a.tagName==="g"&&(a instanceof SVGElement?typeof a.className=="string"?a.className:a.className.baseVal:"").includes("node")&&a.getAttribute("data-id")===t?.dataId)return a}if(s instanceof SVGGraphicsElement&&s.tagName==="g"){let a=s.parentElement;if(a===e||a&&a.tagName==="svg"){let n=s.getAttribute("data-id"),c=s instanceof SVGElement?typeof s.className=="string"?s.className:s.className.baseVal:"";if(n!==t?.dataId||!c.includes("node")){let i=t?.dataId?ve(t.dataId):"",l=e.querySelector(`g.node[data-id="${i}"]`);if(l instanceof SVGGraphicsElement)return l}}}return s};function Ae(r){let t=r.trim(),e=t.split(`
`)[0].trim().toLowerCase();if(e.startsWith("flowchart"))return"flowchart";if(e.startsWith("sequenceDiagram")||e.startsWith("sequencediagram"))return"sequenceDiagram";if(e.startsWith("classDiagram")||e.startsWith("classdiagram"))return"classDiagram";if(e.startsWith("stateDiagram-v2")||e.startsWith("statediagram-v2"))return"stateDiagram-v2";if(e.startsWith("stateDiagram")||e.startsWith("statediagram"))return"stateDiagram";if(e.startsWith("erDiagram")||e.startsWith("erdiagram"))return"erDiagram";if(e.startsWith("gantt"))return"gantt";if(e.startsWith("pie"))return"pie";if(e.startsWith("journey"))return"journey";if(e.startsWith("gitGraph")||e.startsWith("gitgraph"))return"gitGraph";if(e.startsWith("timeline"))return"timeline";if(e.startsWith("quadrantChart")||e.startsWith("quadrantchart"))return"quadrantChart";if(e.startsWith("requirement"))return"requirement";if(e.startsWith("C4Context")||e.startsWith("c4context"))return"c4Context";if(e.startsWith("C4Container")||e.startsWith("c4container"))return"c4Container";if(e.includes("c4component")||e.includes("C4Component")){let s={location:"diagramTypeDetector.ts:79",message:"checking C4Component",data:{firstLine:e,startsWithC4Component:e.startsWith("C4Component"),startsWithC4component:e.startsWith("c4component")},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"C"};console.log("[DiagramTypeDetector]",s.message,s.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}).catch(()=>{})}return e.startsWith("C4Component")||e.startsWith("c4component")?"c4Component":e.startsWith("block-beta")||e.startsWith("blockBeta")||e.startsWith("blockbeta")||e.startsWith("blockDiagram")||e.startsWith("blockdiagram")?"block":t.includes("graph")||t.includes("-->")||t.includes("---")?"flowchart":"unknown"}var ye=class{constructor(){this.strategies=new Map;this.defaultStrategy=null}register(t,e){this.strategies.set(t,e)}get(t){return this.strategies.get(t)}getOrDefault(t){let e=this.strategies.get(t);if(e)return e;if(this.defaultStrategy)return this.defaultStrategy;throw new Error(`No strategy found for diagram type: ${t} and no default strategy set`)}setDefault(t){this.defaultStrategy=t}has(t){return this.strategies.has(t)}getRegisteredTypes(){return Array.from(this.strategies.keys())}},j=new ye;var ee=class extends O{getDiagramType(){return"gantt"}getTargetableClasses(){return["task","milestone","section"]}getTargetableTags(){return["g","rect","polygon"]}extractNodeIds(t){let e=new Map,s=[/^[a-zA-Z0-9-]+-([A-Za-z0-9_]+)-\d+$/,/^gantt-([A-Za-z0-9_]+)-/,/^task-([A-Za-z0-9_]+)/,/^([A-Za-z0-9_]+)$/];for(let a of Array.from(t.querySelectorAll("[id]"))){let n=a.getAttribute("id");if(!n)continue;let c=this.extractIdFromPatterns(n,s);if(!c){let i=this.getElementClassName(a);i&&(i.includes("task")||i.includes("milestone"))&&!n.endsWith("-text")&&!n.endsWith("-Text")&&(c=n)}if(c&&!e.has(c)){let i=a,l=null;for(;i&&i!==t;){if(i instanceof SVGElement&&i.tagName==="g"){let o=this.getElementClassName(i);if(o&&(o.includes("task")||o.includes("milestone")||o.includes("section"))){l=i;break}}i=i.parentElement}if(l)e.set(c,l);else if(a.tagName==="g"&&this.hasTargetableClass(a))e.set(c,a);else if(a.tagName==="rect"){let o=this.getElementClassName(a);o&&(o.includes("task")||o.includes("milestone"))&&e.set(c,a)}else if(a.tagName==="polygon"){let o=this.getElementClassName(a);o&&o.includes("milestone")&&e.set(c,a)}}}return e}getTargetSelectors(t){let e=this.escapeSelector(t);return[`g.task[data-id="${e}"]`,`g.milestone[data-id="${e}"]`,`g[class*="task"][data-id="${e}"]`,`g[class*="milestone"][data-id="${e}"]`,`g[class*="section"][data-id="${e}"]`,`rect.task[data-id="${e}"]`,`rect[class*="task"][data-id="${e}"]`,`polygon.milestone[data-id="${e}"]`,`polygon[class*="milestone"][data-id="${e}"]`,`[data-id="${e}"]`]}findAdjacentElements(t,e){if(!t.getAttribute("data-id"))return[];let a=this.getElementClassName(t);if(a&&a.includes("milestone"))return Array.from(e.querySelectorAll("[data-id]")).filter(u=>u!==t&&u instanceof SVGGraphicsElement);let c=null,i=t;for(;i&&i!==e;){if(i.tagName==="g"&&i instanceof SVGElement){let o=i,u=this.getElementClassName(o);if(u&&u.includes("section")){c=o;break}}i=i.parentElement}return c?Array.from(c.querySelectorAll('[data-id], g[class*="task"][data-id], polygon[class*="milestone"][data-id]')).filter(o=>o!==t):Array.from(e.querySelectorAll('[data-id], g[class*="task"][data-id], polygon[class*="milestone"][data-id]')).filter(u=>u!==t)}};var te=class extends O{getDiagramType(){return"sequenceDiagram"}getTargetableClasses(){return["participant","message","activation","note"]}getTargetableTags(){return["g","rect","text"]}extractNodeIds(t){let e=new Map,s=[/^participant-([A-Za-z0-9_]+)-\d+$/,/^actor-([A-Za-z0-9_]+)-\d+$/,/^message-([A-Za-z0-9_]+)-\d+$/,/^activation-([A-Za-z0-9_]+)-\d+$/,/^note-([A-Za-z0-9_]+)-\d+$/,/^([A-Za-z0-9_]+)-\d+$/];for(let a of Array.from(t.querySelectorAll("[id]"))){let n=a.getAttribute("id");if(!n)continue;let c=this.extractIdFromPatterns(n,s);if(c&&!e.has(c)){let i=a,l=null;for(;i&&i!==t;){if(i instanceof SVGElement&&i.tagName==="g"){let o=this.getElementClassName(i);if(o&&(o.includes("participant")||o.includes("actor")||o.includes("message")||o.includes("activation")||o.includes("note"))){l=i;break}}i=i.parentElement}l?e.set(c,l):a.tagName==="g"&&this.hasTargetableClass(a)&&e.set(c,a)}}return e}getTargetSelectors(t){let e=this.escapeSelector(t);return[`g.participant[data-id="${e}"]`,`g.actor[data-id="${e}"]`,`g.message[data-id="${e}"]`,`g.activation[data-id="${e}"]`,`g.note[data-id="${e}"]`,`line[data-id="${e}"]`,`text[data-id="${e}"]`,`g[class*="participant"][data-id="${e}"]`,`g[class*="actor"][data-id="${e}"]`,`g[class*="message"][data-id="${e}"]`,`g[class*="activation"][data-id="${e}"]`,`g[class*="note"][data-id="${e}"]`,`[data-id="${e}"]`]}findAdjacentElements(t,e){if(!t.getAttribute("data-id"))return[];let a=this.getElementClassName(t);if(a&&(a.includes("participant")||a.includes("actor"))){let n=Array.from(e.querySelectorAll('g[class*="message"][data-id]')),c=[];for(let i of n)try{let l=t.getBBox(),o=i.getBBox();o.x<l.x+l.width&&o.x+o.width>l.x&&o.y<l.y+l.height&&o.y+o.height>l.y&&c.push(i)}catch{continue}return c}if(a&&a.includes("message")){let n=Array.from(e.querySelectorAll('g[class*="participant"][data-id], g[class*="actor"][data-id]')),c=[];try{let i=t.getBBox();for(let l of n)try{let o=l.getBBox();i.x<o.x+o.width&&i.x+i.width>o.x&&i.y<o.y+o.height&&i.y+i.height>o.y&&c.push(l)}catch{continue}}catch{return[]}return c}if(a&&a.includes("activation")){let n=t.parentElement;for(;n&&n!==e;){if(n instanceof SVGGraphicsElement){let c=this.getElementClassName(n);if(c&&(c.includes("participant")||c.includes("actor")))return[n]}n=n.parentElement}}return[]}};var se=class extends O{getDiagramType(){return"classDiagram"}getTargetableClasses(){return["class","classBox","relation","edge"]}getTargetableTags(){return["g","rect","path"]}extractNodeIds(t){let e=new Map,s=[/^class-([A-Za-z0-9_]+)-\d+$/,/^classBox-([A-Za-z0-9_]+)-\d+$/,/^relation-([A-Za-z0-9_]+)-\d+$/,/^edge-([A-Za-z0-9_]+)-\d+$/,/^([A-Za-z0-9_]+)-\d+$/];for(let a of Array.from(t.querySelectorAll("[id]"))){let n=a.getAttribute("id");if(!n)continue;let c=this.extractIdFromPatterns(n,s);if(c&&!e.has(c)){let i=a,l=null;for(;i&&i!==t;){if(i instanceof SVGElement&&i.tagName==="g"){let o=this.getElementClassName(i);if(o&&(o.includes("class")||o.includes("classBox")||o.includes("relation")||o.includes("edge"))){l=i;break}}i=i.parentElement}l?e.set(c,l):a.tagName==="g"&&this.hasTargetableClass(a)&&e.set(c,a)}}return e}getTargetSelectors(t){let e=this.escapeSelector(t);return[`g.class[data-id="${e}"]`,`g.classBox[data-id="${e}"]`,`g.relation[data-id="${e}"]`,`g.edge[data-id="${e}"]`,`g[class*="class"][data-id="${e}"]`,`g[class*="relation"][data-id="${e}"]`,`g[class*="edge"][data-id="${e}"]`,`[data-id="${e}"]`]}findAdjacentElements(t,e){if(!t.getAttribute("data-id"))return[];let a=this.getElementClassName(t);if(a&&(a.includes("class")||a.includes("classBox"))){let n=Array.from(e.querySelectorAll('g[class*="relation"][data-id], g[class*="edge"][data-id], path[class*="edge"]')),c=[];try{let i=t.getBBox();for(let l of n)try{let o=l.getBBox();if(o.x<i.x+i.width&&o.x+o.width>i.x&&o.y<i.y+i.height&&o.y+o.height>i.y){let d=Array.from(e.querySelectorAll('g[class*="class"][data-id], g[class*="classBox"][data-id]'));for(let m of d)if(m!==t&&!c.includes(m))try{let p=m.getBBox();o.x<p.x+p.width&&o.x+o.width>p.x&&o.y<p.y+p.height&&o.y+o.height>p.y&&c.push(m)}catch{continue}}}catch{continue}}catch{return[]}return c}if(a&&(a.includes("relation")||a.includes("edge"))){let n=Array.from(e.querySelectorAll('g[class*="class"][data-id], g[class*="classBox"][data-id]')),c=[];try{let i=t.getBBox();for(let l of n)try{let o=l.getBBox();i.x<o.x+o.width&&i.x+i.width>o.x&&i.y<o.y+o.height&&i.y+i.height>o.y&&c.push(l)}catch{continue}}catch{return[]}return c}return[]}};var X=class extends O{getDiagramType(){return"stateDiagram"}getTargetableClasses(){return["state","stateNode","transition","edge"]}getTargetableTags(){return["g","rect","ellipse","path"]}extractNodeIds(t){let e=new Map,s=[/^stateDiagram-([A-Za-z0-9_]+)-\d+$/,/^state-([A-Za-z0-9_]+)-\d+$/,/^stateNode-([A-Za-z0-9_]+)-\d+$/,/^node-([A-Za-z0-9_]+)-\d+$/,/^stateDiagram-([A-Za-z0-9_]+)$/,/^state-([A-Za-z0-9_]+)$/,/^([A-Za-z0-9_]+)-\d+$/,/^([A-Za-z0-9_]+)$/],a=t.querySelectorAll('g[class*="state"], g[class*="node"]');for(let c=0;c<a.length;c++){let i=a[c];if(!this.getElementClassName(i))continue;let o=i.querySelectorAll("text");for(let u=0;u<o.length;u++){let d=o[u],m=d.textContent?.trim();if(m&&/^[A-Za-z][A-Za-z0-9_]*$/.test(m)){let p=i;d.parentElement&&d.parentElement instanceof SVGElement&&(p=d.parentElement);let S=this.getElementClassName(p);S&&!S.includes("edgeLabel")&&!S.includes("label")&&(e.has(m)||e.set(m,i))}}}let n=[];for(let c of Array.from(t.querySelectorAll("[id]"))){let i=c.getAttribute("id");if(!i)continue;n.push(i);let l=this.extractIdFromPatterns(i,s);if(l&&!e.has(l)){let o=c,u=null;for(;o&&o!==t;){if(o instanceof SVGElement&&o.tagName==="g"){let d=this.getElementClassName(o);if(d&&(d.includes("state")||d.includes("node")||d.includes("transition")||d.includes("edge"))){u=o;break}}o=o.parentElement}u?e.set(l,u):c.tagName==="g"&&this.hasTargetableClass(c)&&e.set(l,c)}}return e}getTargetSelectors(t){let e=this.escapeSelector(t);return[`g.state[data-id="${e}"]`,`g.stateNode[data-id="${e}"]`,`g.node[data-id="${e}"]`,`g.transition[data-id="${e}"]`,`g.edge[data-id="${e}"]`,`g[class*="state"][data-id="${e}"]`,`g[class*="node"][data-id="${e}"]`,`g[class*="transition"][data-id="${e}"]`,`g[class*="edge"][data-id="${e}"]`,`[data-id="${e}"]`]}findAdjacentElements(t,e){if(!t.getAttribute("data-id"))return[];let a=this.getElementClassName(t);if(a&&(a.includes("state")||a.includes("stateNode"))){let n=Array.from(e.querySelectorAll('g[class*="transition"][data-id], g[class*="edge"][data-id], path[class*="edge"]')),c=[];try{let i=t.getBBox();for(let l of n)try{let o=l.getBBox();if(o.x<i.x+i.width&&o.x+o.width>i.x&&o.y<i.y+i.height&&o.y+o.height>i.y){let d=Array.from(e.querySelectorAll('g[class*="state"][data-id], g[class*="stateNode"][data-id]'));for(let m of d)if(m!==t&&!c.includes(m))try{let p=m.getBBox();o.x<p.x+p.width&&o.x+o.width>p.x&&o.y<p.y+p.height&&o.y+o.height>p.y&&c.push(m)}catch{continue}}}catch{continue}}catch{return[]}return c}if(a&&(a.includes("transition")||a.includes("edge"))){let n=Array.from(e.querySelectorAll('g[class*="state"][data-id], g[class*="stateNode"][data-id]')),c=[];try{let i=t.getBBox();for(let l of n)try{let o=l.getBBox();i.x<o.x+o.width&&i.x+i.width>o.x&&i.y<o.y+o.height&&i.y+i.height>o.y&&c.push(l)}catch{continue}}catch{return[]}return c}return[]}};var ae=class extends O{getDiagramType(){return"erDiagram"}getTargetableClasses(){return["entity","relationship","attribute","edge"]}getTargetableTags(){return["g","rect","path"]}extractNodeIds(t){let e=new Map,s=[/^entity-([A-Za-z0-9_]+)-\d+$/,/^relationship-([A-Za-z0-9_]+)-\d+$/,/^attribute-([A-Za-z0-9_]+)-\d+$/,/^edge-([A-Za-z0-9_]+)-\d+$/,/^([A-Za-z0-9_]+)-\d+$/];for(let a of Array.from(t.querySelectorAll("[id]"))){let n=a.getAttribute("id");if(!n)continue;let c=this.extractIdFromPatterns(n,s);if(c&&!e.has(c)){let i=a,l=null;for(;i&&i!==t;){if(i instanceof SVGElement&&i.tagName==="g"){let o=this.getElementClassName(i);if(o&&(o.includes("entity")||o.includes("relationship")||o.includes("attribute")||o.includes("edge"))){l=i;break}}i=i.parentElement}l?e.set(c,l):a.tagName==="g"&&this.hasTargetableClass(a)&&e.set(c,a)}}return e}getTargetSelectors(t){let e=this.escapeSelector(t);return[`g.entity[data-id="${e}"]`,`g.relationship[data-id="${e}"]`,`g.attribute[data-id="${e}"]`,`g.edge[data-id="${e}"]`,`g[class*="entity"][data-id="${e}"]`,`g[class*="relationship"][data-id="${e}"]`,`g[class*="attribute"][data-id="${e}"]`,`g[class*="edge"][data-id="${e}"]`,`[data-id="${e}"]`]}findAdjacentElements(t,e){if(!t.getAttribute("data-id"))return[];let a=this.getElementClassName(t);if(a&&a.includes("entity")){let n=Array.from(e.querySelectorAll('g[class*="relationship"][data-id], g[class*="edge"][data-id], path[class*="edge"]')),c=[];try{let i=t.getBBox();for(let l of n)try{let o=l.getBBox();if(o.x<i.x+i.width&&o.x+o.width>i.x&&o.y<i.y+i.height&&o.y+o.height>i.y){let d=Array.from(e.querySelectorAll('g[class*="entity"][data-id]'));for(let m of d)if(m!==t&&!c.includes(m))try{let p=m.getBBox();o.x<p.x+p.width&&o.x+o.width>p.x&&o.y<p.y+p.height&&o.y+o.height>p.y&&c.push(m)}catch{continue}}}catch{continue}}catch{return[]}return c}if(a&&(a.includes("relationship")||a.includes("edge"))){let n=Array.from(e.querySelectorAll('g[class*="entity"][data-id]')),c=[];try{let i=t.getBBox();for(let l of n)try{let o=l.getBBox();i.x<o.x+o.width&&i.x+i.width>o.x&&i.y<o.y+o.height&&i.y+i.height>o.y&&c.push(l)}catch{continue}}catch{return[]}return c}return[]}};var ne=class extends O{getDiagramType(){return"pie"}getTargetableClasses(){return["slice","pie"]}getTargetableTags(){return["g","path","text"]}extractNodeIds(t){let e=new Map,s=[/^slice-([A-Za-z0-9_]+)-\d+$/,/^pie-([A-Za-z0-9_]+)-\d+$/,/^([A-Za-z0-9_]+)-\d+$/];for(let a of Array.from(t.querySelectorAll("[id]"))){let n=a.getAttribute("id");if(!n)continue;let c=this.extractIdFromPatterns(n,s);if(c&&!e.has(c)){let i=a,l=null;for(;i&&i!==t;){if(i instanceof SVGElement&&i.tagName==="g"){let o=this.getElementClassName(i);if(o&&(o.includes("slice")||o.includes("pie"))){l=i;break}}i=i.parentElement}l?e.set(c,l):(a.tagName==="g"&&this.hasTargetableClass(a)||a.tagName==="path"&&this.hasTargetableClass(a))&&e.set(c,a)}}return e}getTargetSelectors(t){let e=this.escapeSelector(t);return[`g.slice[data-id="${e}"]`,`g.pie[data-id="${e}"]`,`path.slice[data-id="${e}"]`,`path.pie[data-id="${e}"]`,`g[class*="slice"][data-id="${e}"]`,`g[class*="pie"][data-id="${e}"]`,`path[class*="slice"][data-id="${e}"]`,`path[class*="pie"][data-id="${e}"]`,`[data-id="${e}"]`]}findAdjacentElements(t,e){return[]}};var re=class extends O{getDiagramType(){return"journey"}getTargetableClasses(){return["step","task","section"]}getTargetableTags(){return["g","rect","text"]}extractNodeIds(t){let e=new Map,s=[/^step-([A-Za-z0-9_]+)-\d+$/,/^task-([A-Za-z0-9_]+)-\d+$/,/^section-([A-Za-z0-9_]+)-\d+$/,/^([A-Za-z0-9_]+)-\d+$/];for(let a of Array.from(t.querySelectorAll("[id]"))){let n=a.getAttribute("id");if(!n)continue;let c=this.extractIdFromPatterns(n,s);if(c&&!e.has(c)){let i=a,l=null;for(;i&&i!==t;){if(i instanceof SVGElement&&i.tagName==="g"){let o=this.getElementClassName(i);if(o&&(o.includes("step")||o.includes("task")||o.includes("section"))){l=i;break}}i=i.parentElement}l?e.set(c,l):a.tagName==="g"&&this.hasTargetableClass(a)&&e.set(c,a)}}return e}getTargetSelectors(t){let e=this.escapeSelector(t);return[`g.step[data-id="${e}"]`,`g.task[data-id="${e}"]`,`g.section[data-id="${e}"]`,`g[class*="step"][data-id="${e}"]`,`g[class*="task"][data-id="${e}"]`,`g[class*="section"][data-id="${e}"]`,`[data-id="${e}"]`]}findAdjacentElements(t,e){if(!t.getAttribute("data-id"))return[];let a=Array.from(e.querySelectorAll('g[class*="step"][data-id], g[class*="task"][data-id]')),n=a.indexOf(t);if(n===-1)return[];let c=[];return n>0&&c.push(a[n-1]),n<a.length-1&&c.push(a[n+1]),c}};var ie=class extends O{getDiagramType(){return"gitGraph"}getTargetableClasses(){return["commit","branch","merge"]}getTargetableTags(){return["g","circle","path","text"]}extractNodeIds(t){let e=new Map,s=[/^commit-([A-Za-z0-9_]+)-\d+$/,/^branch-([A-Za-z0-9_]+)-\d+$/,/^merge-([A-Za-z0-9_]+)-\d+$/,/^([A-Za-z0-9_]+)-\d+$/];for(let a of Array.from(t.querySelectorAll("[id]"))){let n=a.getAttribute("id");if(!n)continue;let c=this.extractIdFromPatterns(n,s);if(c&&!e.has(c)){let i=a,l=null;for(;i&&i!==t;){if(i instanceof SVGElement&&i.tagName==="g"){let o=this.getElementClassName(i);if(o&&(o.includes("commit")||o.includes("branch")||o.includes("merge"))){l=i;break}}i=i.parentElement}l?e.set(c,l):(a.tagName==="g"&&this.hasTargetableClass(a)||a.tagName==="circle"&&this.hasTargetableClass(a))&&e.set(c,a)}}return e}getTargetSelectors(t){let e=this.escapeSelector(t);return[`g.commit[data-id="${e}"]`,`g.branch[data-id="${e}"]`,`g.merge[data-id="${e}"]`,`circle.commit[data-id="${e}"]`,`circle.branch[data-id="${e}"]`,`g[class*="commit"][data-id="${e}"]`,`g[class*="branch"][data-id="${e}"]`,`g[class*="merge"][data-id="${e}"]`,`circle[class*="commit"][data-id="${e}"]`,`circle[class*="branch"][data-id="${e}"]`,`[data-id="${e}"]`]}findAdjacentElements(t,e){if(!t.getAttribute("data-id"))return[];let a=this.getElementClassName(t);if(a&&a.includes("commit")){let n=Array.from(e.querySelectorAll('g[class*="branch"][data-id], path[class*="branch"], path[class*="edge"]')),c=[];try{let i=t.getBBox();for(let l of n)try{let o=l.getBBox();if(o.x<i.x+i.width&&o.x+o.width>i.x&&o.y<i.y+i.height&&o.y+o.height>i.y){let d=Array.from(e.querySelectorAll('g[class*="commit"][data-id], circle[class*="commit"][data-id]'));for(let m of d)if(m!==t&&!c.includes(m))try{let p=m.getBBox();o.x<p.x+p.width&&o.x+p.width>p.x&&o.y<p.y+p.height&&o.y+p.height>p.y&&c.push(m)}catch{continue}}}catch{continue}}catch{return[]}return c}if(a&&a.includes("branch")){let n=Array.from(e.querySelectorAll('g[class*="commit"][data-id], circle[class*="commit"][data-id]')),c=[];try{let i=t.getBBox();for(let l of n)try{let o=l.getBBox();i.x<o.x+o.width&&i.x+i.width>o.x&&i.y<o.y+o.height&&i.y+o.height>o.y&&c.push(l)}catch{continue}}catch{return[]}return c}return[]}};var oe=class extends O{getDiagramType(){return"timeline"}getTargetableClasses(){return["section","event","timeline"]}getTargetableTags(){return["g","rect","text"]}extractNodeIds(t){let e=new Map,s=[/^section-([A-Za-z0-9_]+)-\d+$/,/^event-([A-Za-z0-9_]+)-\d+$/,/^timeline-([A-Za-z0-9_]+)-\d+$/,/^([A-Za-z0-9_]+)-\d+$/];for(let a of Array.from(t.querySelectorAll("[id]"))){let n=a.getAttribute("id");if(!n)continue;let c=this.extractIdFromPatterns(n,s);if(c&&!e.has(c)){let i=a,l=null;for(;i&&i!==t;){if(i instanceof SVGElement&&i.tagName==="g"){let o=this.getElementClassName(i);if(o&&(o.includes("section")||o.includes("event")||o.includes("timeline"))){l=i;break}}i=i.parentElement}l?e.set(c,l):a.tagName==="g"&&this.hasTargetableClass(a)&&e.set(c,a)}}return e}getTargetSelectors(t){let e=this.escapeSelector(t);return[`g.section[data-id="${e}"]`,`g.event[data-id="${e}"]`,`g.timeline[data-id="${e}"]`,`g[class*="section"][data-id="${e}"]`,`g[class*="event"][data-id="${e}"]`,`g[class*="timeline"][data-id="${e}"]`,`[data-id="${e}"]`]}findAdjacentElements(t,e){if(!t.getAttribute("data-id"))return[];let a=this.getElementClassName(t);if(a&&a.includes("section"))return Array.from(t.querySelectorAll('g[class*="event"][data-id]'));if(a&&a.includes("event")){let n=t.parentElement;for(;n&&n!==e;){let i=this.getElementClassName(n);if(i&&i.includes("section"))return Array.from(n.querySelectorAll('g[class*="event"][data-id]')).filter(o=>o!==t);n=n.parentElement}return Array.from(e.querySelectorAll('g[class*="event"][data-id]')).filter(i=>i!==t)}return[]}};var ce=class extends O{getDiagramType(){return"quadrantChart"}getTargetableClasses(){return["quadrant","point","data"]}getTargetableTags(){return["g","circle","rect","text"]}extractNodeIds(t){let e=new Map,s=[/^quadrant-([A-Za-z0-9_]+)-\d+$/,/^point-([A-Za-z0-9_]+)-\d+$/,/^data-([A-Za-z0-9_]+)-\d+$/,/^([A-Za-z0-9_]+)-\d+$/];for(let a of Array.from(t.querySelectorAll("[id]"))){let n=a.getAttribute("id");if(!n)continue;let c=this.extractIdFromPatterns(n,s);if(c&&!e.has(c)){let i=a,l=null;for(;i&&i!==t;){if(i instanceof SVGElement&&i.tagName==="g"){let o=this.getElementClassName(i);if(o&&(o.includes("quadrant")||o.includes("point")||o.includes("data"))){l=i;break}}i=i.parentElement}l?e.set(c,l):(a.tagName==="g"&&this.hasTargetableClass(a)||a.tagName==="circle"&&this.hasTargetableClass(a))&&e.set(c,a)}}return e}getTargetSelectors(t){let e=this.escapeSelector(t);return[`g.quadrant[data-id="${e}"]`,`g.point[data-id="${e}"]`,`g.data[data-id="${e}"]`,`circle.quadrant[data-id="${e}"]`,`circle.point[data-id="${e}"]`,`circle.data[data-id="${e}"]`,`g[class*="quadrant"][data-id="${e}"]`,`g[class*="point"][data-id="${e}"]`,`g[class*="data"][data-id="${e}"]`,`[data-id="${e}"]`]}findAdjacentElements(t,e){if(!t.getAttribute("data-id"))return[];let a=this.getElementClassName(t);if(a&&(a.includes("point")||a.includes("data")))try{let n=t.getBBox(),c=n.x+n.width/2,i=n.y+n.height/2,l=Array.from(e.querySelectorAll('g[class*="quadrant"]'));for(let o of l)try{let u=o.getBBox();if(c>=u.x&&c<=u.x+u.width&&i>=u.y&&i<=u.y+u.height)return Array.from(o.querySelectorAll('g[class*="point"][data-id], circle[class*="point"][data-id], g[class*="data"][data-id], circle[class*="data"][data-id]')).filter(m=>m!==t)}catch{continue}}catch{return Array.from(e.querySelectorAll('g[class*="point"][data-id], circle[class*="point"][data-id], g[class*="data"][data-id], circle[class*="data"][data-id]')).filter(c=>c!==t)}return a&&a.includes("quadrant")?Array.from(t.querySelectorAll('g[class*="point"][data-id], circle[class*="point"][data-id], g[class*="data"][data-id], circle[class*="data"][data-id]')):[]}};var le=class extends O{getDiagramType(){return"requirement"}getTargetableClasses(){return["requirement","function","relationship"]}getTargetableTags(){return["g","rect","path"]}extractNodeIds(t){let e=new Map,s=[/^requirement-([A-Za-z0-9_]+)-\d+$/,/^function-([A-Za-z0-9_]+)-\d+$/,/^relationship-([A-Za-z0-9_]+)-\d+$/,/^([A-Za-z0-9_]+)-\d+$/];for(let a of Array.from(t.querySelectorAll("[id]"))){let n=a.getAttribute("id");if(!n)continue;let c=this.extractIdFromPatterns(n,s);if(c&&!e.has(c)){let i=a,l=null;for(;i&&i!==t;){if(i instanceof SVGElement&&i.tagName==="g"){let o=this.getElementClassName(i);if(o&&(o.includes("requirement")||o.includes("function")||o.includes("relationship"))){l=i;break}}i=i.parentElement}l?e.set(c,l):a.tagName==="g"&&this.hasTargetableClass(a)&&e.set(c,a)}}return e}getTargetSelectors(t){let e=this.escapeSelector(t);return[`g.requirement[data-id="${e}"]`,`g.function[data-id="${e}"]`,`g.relationship[data-id="${e}"]`,`g[class*="requirement"][data-id="${e}"]`,`g[class*="function"][data-id="${e}"]`,`g[class*="relationship"][data-id="${e}"]`,`[data-id="${e}"]`]}findAdjacentElements(t,e){if(!t.getAttribute("data-id"))return[];let a=this.getElementClassName(t);if(a&&(a.includes("requirement")||a.includes("function"))){let n=Array.from(e.querySelectorAll('g[class*="relationship"][data-id], path[class*="relationship"]')),c=[];try{let i=t.getBBox();for(let l of n)try{let o=l.getBBox();if(o.x<i.x+i.width&&o.x+o.width>i.x&&o.y<i.y+i.height&&o.y+o.height>i.y){let d=Array.from(e.querySelectorAll('g[class*="requirement"][data-id], g[class*="function"][data-id]'));for(let m of d)if(m!==t&&!c.includes(m))try{let p=m.getBBox();o.x<p.x+p.width&&o.x+o.width>p.x&&o.y<p.y+p.height&&o.y+o.height>p.y&&c.push(m)}catch{continue}}}catch{continue}}catch{return[]}return c}return[]}};var Y=class extends O{constructor(t){super(),this.diagramType=t}getDiagramType(){return this.diagramType}getTargetableClasses(){return["c4","element","relationship","boundary"]}getTargetableTags(){return["g","rect","path","text"]}extractNodeIds(t){let e=new Map,s={location:"c4Strategy.ts:29",message:"extractNodeIds entry",data:{diagramType:this.diagramType,totalElements:t.querySelectorAll("[id]").length},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"};this.diagramType==="c4Component"&&console.log("[C4Strategy]",s.message,s.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}).catch(()=>{});let a=[/^c4-([A-Za-z0-9_]+)-\d+$/,/^element-([A-Za-z0-9_]+)-\d+$/,/^relationship-([A-Za-z0-9_]+)-\d+$/,/^boundary-([A-Za-z0-9_]+)-\d+$/,/^([A-Za-z0-9_]+)-\d+$/,/^([A-Za-z0-9_]+)$/],n=[],c=Array.from(t.querySelectorAll("[id]"));if(this.diagramType==="c4Component"){let i=c.map(d=>({id:d.getAttribute("id"),tagName:d.tagName,className:this.getElementClassName(d),parentTagName:d.parentElement?.tagName,parentClassName:d.parentElement instanceof SVGElement?this.getElementClassName(d.parentElement):""})),o=Array.from(t.querySelectorAll("g")).filter(d=>{let m=this.getElementClassName(d);return m&&(m.includes("c4")||m.includes("element")||m.includes("component")||m.includes("container")||m.includes("boundary"))}).slice(0,20).map(d=>({tagName:d.tagName,className:this.getElementClassName(d),id:d.id,textContent:d.textContent?.trim().slice(0,50)})),u={location:"c4Strategy.ts:52",message:"all IDs found",data:{totalIds:c.length,allIds:i,groupsWithClasses:o},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"};console.log("[C4Strategy]",u.message,u.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u)}).catch(()=>{})}for(let i of c){let l=i.getAttribute("id");if(!l)continue;n.push(l);let o=this.extractIdFromPatterns(l,a);if(this.diagramType==="c4Component"&&o&&["controller","service","repo","api","db"].includes(o)){let u={location:"c4Strategy.ts:65",message:"extracted nodeId",data:{mermaidId:l,nodeId:o,className:this.getElementClassName(i),tagName:i.tagName},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"};console.log("[C4Strategy]",u.message,u.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u)}).catch(()=>{})}if(this.diagramType==="c4Component"&&!o&&(l.includes("controller")||l.includes("service")||l.includes("repo")||l.includes("api")||l.includes("db"))){let u={location:"c4Strategy.ts:71",message:"ID did not match patterns",data:{mermaidId:l,patterns:a.map(d=>d.toString()),className:this.getElementClassName(i),tagName:i.tagName},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"};console.log("[C4Strategy]",u.message,u.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u)}).catch(()=>{})}if(o&&!e.has(o)){let u=i,d=null;for(;u&&u!==t;){if(u instanceof SVGElement&&u.tagName==="g"){let m=this.getElementClassName(u);if(m&&(m.includes("c4")||m.includes("element")||m.includes("relationship")||m.includes("boundary"))){d=u;break}}u=u.parentElement}d?e.set(o,d):i.tagName==="g"&&this.hasTargetableClass(i)&&e.set(o,i)}}if(this.diagramType==="c4Component"){let i={location:"c4Strategy.ts:74",message:"extractNodeIds exit",data:{extractedCount:e.size,extractedIds:Array.from(e.keys()),sampleIds:n.slice(0,20)},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"};console.log("[C4Strategy]",i.message,i.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}).catch(()=>{})}return e}getTargetSelectors(t){let e=this.escapeSelector(t);return[`g.c4[data-id="${e}"]`,`g.element[data-id="${e}"]`,`g.relationship[data-id="${e}"]`,`g.boundary[data-id="${e}"]`,`g[class*="c4"][data-id="${e}"]`,`g[class*="element"][data-id="${e}"]`,`g[class*="relationship"][data-id="${e}"]`,`g[class*="boundary"][data-id="${e}"]`,`[data-id="${e}"]`]}findAdjacentElements(t,e){if(!t.getAttribute("data-id"))return[];let a=this.getElementClassName(t);if(a&&(a.includes("c4")||a.includes("element"))){let n=Array.from(e.querySelectorAll('g[class*="relationship"][data-id], path[class*="relationship"]')),c=[];try{let i=t.getBBox();for(let l of n)try{let o=l.getBBox();if(o.x<i.x+i.width&&o.x+o.width>i.x&&o.y<i.y+i.height&&o.y+o.height>i.y){let d=Array.from(e.querySelectorAll('g[class*="c4"][data-id], g[class*="element"][data-id]'));for(let m of d)if(m!==t&&!c.includes(m))try{let p=m.getBBox();o.x<p.x+p.width&&o.x+o.width>p.x&&o.y<p.y+p.height&&o.y+o.height>p.y&&c.push(m)}catch{continue}}}catch{continue}}catch{return[]}return c}if(a&&a.includes("relationship")){let n=Array.from(e.querySelectorAll('g[class*="c4"][data-id], g[class*="element"][data-id]')),c=[];try{let i=t.getBBox();for(let l of n)try{let o=l.getBBox();i.x<o.x+o.width&&i.x+i.width>o.x&&i.y<o.y+o.height&&i.y+i.height>o.y&&c.push(l)}catch{continue}}catch{return[]}return c}return[]}};var de=class extends O{getDiagramType(){return"block"}getTargetableClasses(){return["block","node","edge"]}getTargetableTags(){return["g","rect","path"]}extractNodeIds(t){let e=new Map,s=[/^block-([A-Za-z0-9_]+)-\d+$/,/^node-([A-Za-z0-9_]+)-\d+$/,/^edge-([A-Za-z0-9_]+)-\d+$/,/^([A-Za-z0-9_]+)-\d+$/];for(let a of Array.from(t.querySelectorAll("[id]"))){let n=a.getAttribute("id");if(!n)continue;let c=this.extractIdFromPatterns(n,s);if(c&&!e.has(c)){let i=a,l=null;for(;i&&i!==t;){if(i instanceof SVGElement&&i.tagName==="g"){let o=this.getElementClassName(i);if(o&&(o.includes("block")||o.includes("node")||o.includes("edge"))){l=i;break}}i=i.parentElement}l?e.set(c,l):a.tagName==="g"&&this.hasTargetableClass(a)&&e.set(c,a)}}return e}getTargetSelectors(t){let e=this.escapeSelector(t);return[`g.block[data-id="${e}"]`,`g.node[data-id="${e}"]`,`g.edge[data-id="${e}"]`,`g[class*="block"][data-id="${e}"]`,`g[class*="node"][data-id="${e}"]`,`g[class*="edge"][data-id="${e}"]`,`[data-id="${e}"]`]}findAdjacentElements(t,e){if(!t.getAttribute("data-id"))return[];let a=this.getElementClassName(t);if(a&&(a.includes("block")||a.includes("node"))){let n=Array.from(e.querySelectorAll('path.edge, path[class*="edge"], g.edge path, path[id*="edge"]')),c=[];try{let i=t.getBBox(),l=i.x+i.width/2,o=i.y+i.height/2;for(let u of n)try{let d=u.getBBox(),m=d.x+d.width/2,p=d.y+d.height/2,S=Math.max(i.width,i.height)*1.5,N=Math.sqrt(Math.pow(m-l,2)+Math.pow(p-o,2));if(d.x<i.x+i.width&&d.x+d.width>i.x&&d.y<i.y+i.height&&d.y+d.height>i.y||N<S){let $=Array.from(e.querySelectorAll("g.block[data-id], g.node[data-id]"));for(let D of $)if(D!==t&&!c.includes(D))try{let k=D.getBBox(),g=k.x+k.width/2,h=k.y+k.height/2,f=Math.sqrt(Math.pow(g-m,2)+Math.pow(h-p,2));(d.x<k.x+k.width&&d.x+d.width>k.x&&d.y<k.y+k.height&&d.y+d.height>k.y||f<S)&&c.push(D)}catch{continue}}}catch{continue}}catch{return[]}return c}return[]}};j.register("flowchart",new U);j.register("gantt",new ee);j.register("sequenceDiagram",new te);j.register("classDiagram",new se);j.register("stateDiagram",new X);j.register("stateDiagram-v2",new X);j.register("erDiagram",new ae);j.register("pie",new ne);j.register("journey",new re);j.register("gitGraph",new ie);j.register("timeline",new oe);j.register("quadrantChart",new ce);j.register("requirement",new le);j.register("c4Context",new Y("c4Context"));j.register("c4Container",new Y("c4Container"));j.register("c4Component",new Y("c4Component"));j.register("block",new de);j.setDefault(new U);function qe(r,t,e){let s=t.extractNodeIds(r),a=t.getDiagramType();if(a==="classDiagram"){let g={location:"mermaidDiagram.ts:49",message:"ensureDataIdFromMermaidIds entry",data:{diagramType:a,extractedCount:s.size,hasMermaidText:!!e},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"};console.log("[MermaidDiagram]",g.message,g.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(g)}).catch(()=>{})}if(a==="c4Component"){let g={location:"mermaidDiagram.ts:71",message:"after extractNodeIds",data:{diagramType:t.getDiagramType(),nodeCount:s.size,nodeIds:Array.from(s.keys())},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"B"};console.log("[MermaidDiagram]",g.message,g.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(g)}).catch(()=>{})}let n=t.getDiagramType(),c={location:"mermaidDiagram.ts:60",message:"checking for fallback",data:{diagramType:n,extractedCount:s.size,hasMermaidText:!!e},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"};(n==="classDiagram"||n==="erDiagram"||n==="gitGraph"||n==="journey")&&(console.log("[MermaidDiagram]",c.message,c.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)}).catch(()=>{}));let i=e?_e(e):new Set,l=new Set;if(n==="classDiagram"&&e){let g=/class\s+([A-Za-z0-9_]+)\s*[<{]/g,h;for(;(h=g.exec(e))!==null;)l.add(h[1]);let f=/class\s+([A-Za-z0-9_]+)(?:\s|$)/g;for(f.lastIndex=0;(h=f.exec(e))!==null;)l.add(h[1]);let T={location:"mermaidDiagram.ts:78",message:"extracted class names",data:{diagramType:n,classAliases:Array.from(l),mermaidTextPreview:e.slice(0,200)},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"};console.log("[MermaidDiagram]",T.message,T.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(T)}).catch(()=>{})}let o=new Set;if(n==="erDiagram"&&e){let g=/([A-Z][A-Z0-9_]+)\s*\{/g,h;for(;(h=g.exec(e))!==null;)o.add(h[1]);let f=/([A-Z][A-Z0-9_]+)\s*[|o]+--[|o]+/g;for(f.lastIndex=0;(h=f.exec(e))!==null;)o.add(h[1]);let T=/[|o]+--[|o]+\s*([A-Z][A-Z0-9_]+)/g;for(T.lastIndex=0;(h=T.exec(e))!==null;)o.add(h[1]);let E={location:"mermaidDiagram.ts:103",message:"extracted ER entity names",data:{diagramType:n,erAliases:Array.from(o),mermaidTextPreview:e.slice(0,200)},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"};console.log("[MermaidDiagram]",E.message,E.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(E)}).catch(()=>{})}let u=new Set;if(n==="gitGraph"&&e){let g=/branch\s+([A-Za-z0-9_]+)/g,h;for(;(h=g.exec(e))!==null;)u.add(h[1]);let f=/checkout\s+([A-Za-z0-9_]+)/g;for(f.lastIndex=0;(h=f.exec(e))!==null;)u.add(h[1]);let T=/commit\s+id:\s*"([^"]+)"/g;for(T.lastIndex=0;(h=T.exec(e))!==null;)u.add(h[1]);let E=/merge\s+([A-Za-z0-9_]+)/g;for(E.lastIndex=0;(h=E.exec(e))!==null;)u.add(h[1]);u.add("merge");let v={location:"mermaidDiagram.ts:141",message:"extracted git graph names",data:{diagramType:n,gitAliases:Array.from(u),mermaidTextPreview:e.slice(0,200)},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"};console.log("[MermaidDiagram]",v.message,v.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(v)}).catch(()=>{})}let d=new Set;if(n==="journey"&&e){let g=e.split(`
`);for(let f of g){if(f.trim().startsWith("title")||f.trim().startsWith("section"))continue;let T=f.match(/^\s+([^:]+):\s*\d+:/);if(T&&T[1]){let E=T[1].trim();E&&!E.includes(`
`)&&d.add(E)}}let h={location:"mermaidDiagram.ts:177",message:"extracted journey step names",data:{diagramType:n,journeyAliases:Array.from(d),mermaidTextPreview:e.slice(0,200)},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"};console.log("[MermaidDiagram]",h.message,h.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(h)}).catch(()=>{})}let m=new Set;if(n==="pie"&&e){let g=/"([^"]+)"\s*:\s*\d+\.?\d*/g,h;for(g.lastIndex=0;(h=g.exec(e))!==null;){let T=h[1].trim();T&&m.add(T)}let f={location:"mermaidDiagram.ts:199",message:"extracted pie chart slice names",data:{diagramType:n,pieAliases:Array.from(m),mermaidTextPreview:e.slice(0,200)},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"};console.log("[MermaidDiagram]",f.message,f.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(f)}).catch(()=>{})}let p=new Set;if(n==="quadrantChart"&&e){let g=/"?([^":\n]+)"?\s*:\s*\[?[\d.]+\s*,\s*[\d.]+\]?/g,h;for(g.lastIndex=0;(h=g.exec(e))!==null;){let T=h[1].trim();T&&p.add(T)}let f={location:"mermaidDiagram.ts:227",message:"extracted quadrant chart item names",data:{diagramType:n,quadrantAliases:Array.from(p),mermaidTextPreview:e.slice(0,200)},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"};console.log("[MermaidDiagram]",f.message,f.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(f)}).catch(()=>{})}let S=new Set;if(n==="requirement"&&e){let g=/requirement\s+([A-Za-z0-9_]+)\s*\{/g,h;for(g.lastIndex=0;(h=g.exec(e))!==null;){let v=h[1].trim();v&&S.add(v)}let f=/element\s+([A-Za-z0-9_]+)\s*\{/g,T;for(f.lastIndex=0;(T=f.exec(e))!==null;){let v=T[1].trim();v&&S.add(v)}let E={location:"mermaidDiagram.ts:252",message:"extracted requirement diagram names",data:{diagramType:n,requirementAliases:Array.from(S),mermaidTextPreview:e.slice(0,200)},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"};console.log("[MermaidDiagram]",E.message,E.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(E)}).catch(()=>{})}let N=new Set;if(n==="sequenceDiagram"&&e){let g=/(?:participant|actor)\s+([A-Za-z0-9_]+)/g,h;for(g.lastIndex=0;(h=g.exec(e))!==null;){let v=h[1].trim();v&&N.add(v)}let f=/(?:->>|->|-->>|-->)\s*[A-Za-z0-9_]+\s*:\s*([^\n]+)/g,T;for(f.lastIndex=0;(T=f.exec(e))!==null;){let v=T[1].trim();v&&N.add(v)}let E={location:"mermaidDiagram.ts:282",message:"extracted sequence diagram names",data:{diagramType:n,sequenceAliases:Array.from(N),mermaidTextPreview:e.slice(0,200)},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"};console.log("[MermaidDiagram]",E.message,E.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(E)}).catch(()=>{})}let x=new Set;if(n==="timeline"&&e){let g=/section\s+([^\n]+)/g,h;for(g.lastIndex=0;(h=g.exec(e))!==null;){let T=h[1].trim();T&&x.add(T)}let f={location:"mermaidDiagram.ts:318",message:"extracted timeline diagram names",data:{diagramType:n,timelineAliases:Array.from(x),mermaidTextPreview:e.slice(0,200)},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"};console.log("[MermaidDiagram]",f.message,f.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(f)}).catch(()=>{})}let $=e&&((n==="c4Component"||n==="c4Container"||n==="c4Context")&&(s.size===0||s.size<i.size)||n==="classDiagram"&&(s.size===0||s.size<l.size)||n==="erDiagram"&&(s.size===0||s.size<o.size)||n==="gitGraph"&&(s.size===0||s.size<u.size)||n==="journey"&&(s.size===0||s.size<d.size)||n==="pie"&&(s.size===0||s.size<m.size)||n==="quadrantChart"&&(s.size===0||s.size<p.size)||n==="requirement"&&(s.size===0||s.size<S.size)||n==="sequenceDiagram"&&(s.size===0||s.size<N.size)||n==="timeline"&&(s.size===0||s.size<x.size));if(n==="classDiagram"||n==="erDiagram"||n==="gitGraph"||n==="journey"||n==="pie"||n==="quadrantChart"||n==="requirement"||n==="sequenceDiagram"||n==="timeline"){let g=n==="classDiagram"?l.size:n==="erDiagram"?o.size:n==="gitGraph"?u.size:n==="journey"?d.size:n==="pie"?m.size:n==="quadrantChart"?p.size:n==="requirement"?S.size:n==="sequenceDiagram"?N.size:n==="timeline"?x.size:0,h={location:"mermaidDiagram.ts:200",message:"fallback check",data:{diagramType:n,shouldUseFallback:$,extractedCount:s.size,aliasCount:g},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"};console.log("[MermaidDiagram]",h.message,h.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(h)}).catch(()=>{})}if($){let g={location:"mermaidDiagram.ts:78",message:"extractNodeIds incomplete, trying fallback from text",data:{diagramType:n,extractedCount:s.size,aliasCount:i.size,missingAliases:Array.from(i).filter(E=>!s.has(E))},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"};if(console.log("[MermaidDiagram]",g.message,g.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(g)}).catch(()=>{}),n==="c4Component"||n==="c4Container"||n==="c4Context"){let E={location:"mermaidDiagram.ts:85",message:"extracted aliases from text",data:{diagramType:n,aliases:Array.from(i)},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"};console.log("[MermaidDiagram]",E.message,E.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(E)}).catch(()=>{})}let h={};if(n==="c4Container"||n==="c4Context"){let E=/(?:Container_Boundary|System_Boundary)\s*\(\s*([A-Za-z0-9_]+)\s*,[\s\S]*?\{([\s\S]*?)\}/g,v;for(E.lastIndex=0;(v=E.exec(e))!==null;){let L=v[1],R=v[2],P=[/Container\s*\(\s*([A-Za-z0-9_]+)\s*,/g,/Component\s*\(\s*([A-Za-z0-9_]+)\s*,/g],V=[];for(let M of P){M.lastIndex=0;let I;for(;(I=M.exec(R))!==null;)V.push(I[1])}V.length>0&&(h[L]=V)}if(Object.keys(h).length>0){let L={location:"mermaidDiagram.ts:163",message:"extracted boundary children",data:{diagramType:n,boundaryChildren:h},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"};console.log("[MermaidDiagram]",L.message,L.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(L)}).catch(()=>{})}}let f=n==="classDiagram"?l:n==="erDiagram"?o:n==="gitGraph"?u:n==="journey"?d:n==="pie"?m:n==="quadrantChart"?p:n==="requirement"?S:n==="sequenceDiagram"?N:n==="timeline"?x:i,T=n==="erDiagram"||n==="gitGraph"||n==="journey"||n==="pie"||n==="quadrantChart"||n==="requirement"||n==="sequenceDiagram"?Array.from(f).sort((E,v)=>v.length!==E.length?v.length-E.length:E.localeCompare(v)):Array.from(f);for(let E of T){if(s.has(E)||h[E])continue;let v=E.toLowerCase(),R=Array.from(r.querySelectorAll("*")).filter(I=>{let w=I.textContent?.toLowerCase()||"";if(n==="erDiagram"){let C=E.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");if(new RegExp(`\\b${C.replace(/_/g,"\\_")}\\b`,"i").test(w))return!0;let q=E.replace(/_/g,"").toLowerCase();if(w.trim().startsWith(q)||w.trim().endsWith(q)||new RegExp(`\\b${q}\\b`,"i").test(w)||w.trim().startsWith(v)||w.trim().endsWith(v))return!0}if(n==="gitGraph"){let C=E.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");if(new RegExp(`\\b${C}\\b`,"i").test(w)||w.trim().startsWith(v)||w.trim().endsWith(v))return!0}if(n==="journey"){let C=E.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");if(new RegExp(C.replace(/\s+/g,"\\s+"),"i").test(w)||new RegExp(`\\b${C.replace(/\s+/g,"\\s+")}\\b`,"i").test(w)||w.trim().startsWith(v)||w.trim().endsWith(v))return!0}if(n==="timeline"){let C=w.replace(/\s+/g," ").trim().toLowerCase(),A=v.replace(/\s+/g," ").trim();if(C.includes(A))return!0;let G=E.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");if(new RegExp(G.replace(/\s+/g,"\\s+"),"i").test(w)||C.startsWith(A)||C.endsWith(A))return!0}if(n==="classDiagram"&&(new RegExp(`\\b${E.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\b`,"i").test(w)||w.trim().startsWith(v)||w.trim().endsWith(v)))return!0;let B=v==="db"?/<<system_db>>/i:null;if(B&&B.test(w)||w.includes(v)&&(w.startsWith(v)||w.includes(" "+v)||w.includes(v+" ")||w.includes("<<"+v)||w.includes(v+">>")))return!0;let b=E.replace(/([a-z])([A-Z])/g,"$1 $2").toLowerCase();if(b!==v&&b.includes(" ")){let C=b.split(" ");if(C.length>1&&C.every(A=>w.includes(A))){let A=C.join("");if(w.includes(A)||C.every((G,q)=>{if(q===0)return w.includes(G);let z=C[q-1];return w.includes(z+" "+G)||w.includes(z+G)}))return!0}}if(v.length>3){let C=["app","api","ui","db","service","system","user"];for(let A of C)if(v.endsWith(A)&&v.length>A.length){let G=v.slice(0,-A.length);if(w.includes(G)&&(w.includes(A)||w.includes(A+"lication")||w.includes(A+"i"))&&(w.includes(G+" "+A)||w.includes(G+A)||w.includes(G)&&w.includes(A+"lication")))return!0}}return!1});if(n==="c4Component"&&["controller","service","repo","api","db"].includes(E)){let I={location:"mermaidDiagram.ts:90",message:"searching for alias in text",data:{alias:E,textElementsFound:R.length,textElements:R.slice(0,5).map(w=>({tagName:w.tagName,textContent:w.textContent?.trim().slice(0,50),parentTagName:w.parentElement?.tagName}))},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"};console.log("[MermaidDiagram]",I.message,I.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(I)}).catch(()=>{})}let P=!1;for(let I of R){let w=I,B=null;if(n==="pie"){let b=null,C=I;for(;C&&C!==r;){if(C instanceof SVGElement&&C.tagName==="g"){let A=typeof C.className=="string"?C.className:C.className.baseVal;if(A&&A.includes("legend")){b=C;break}}C=C.parentElement}if(b){let A=Array.from(r.querySelectorAll("path")),G=Array.from(r.querySelectorAll("g")).filter(_=>{let F=typeof _.className=="string"?_.className:_.className.baseVal;return F&&F.includes("legend")}),q=b?G.indexOf(b):-1,z=A.filter(_=>{let F=_.getAttribute("d");return F&&F.includes("M")&&(F.includes("A")||F.includes("L"))});if(q>=0&&q<z.length){let _=z[q];if(_ instanceof SVGGraphicsElement){let F=String(E);if(!s.has(F)){s.set(F,_),P=!0;let Z={location:"mermaidDiagram.ts:445",message:"found pie slice path for legend",data:{diagramType:n,alias:F,legendIndex:q,slicePathTag:_.tagName,slicePathHasD:!!_.getAttribute("d")},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"B"};console.log("[MermaidDiagram]",Z.message,Z.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(Z)}).catch(()=>{});continue}}}}}if(n==="sequenceDiagram"&&I instanceof SVGElement){let b=typeof I.className=="string"?I.className:I.className.baseVal;if(b&&b.includes("message")){let C=null;try{if(I instanceof SVGGraphicsElement){let G=I.getBBox(),q=Array.from(r.querySelectorAll("line, path"));for(let z of q)try{let _=z.getBBox();if(Math.sqrt(Math.pow(G.x+G.width/2-(_.x+_.width/2),2)+Math.pow(G.y+G.height/2-(_.y+_.height/2),2))<150){let Z=z.parentElement;for(;Z&&Z!==r;){if(Z instanceof SVGElement&&Z.tagName==="g"){let Ee=typeof Z.className=="string"?Z.className:Z.className.baseVal;if(Ee&&(Ee.includes("message")||Z.contains(I))){C=Z;break}}Z=Z.parentElement}if(C)break;C=z;break}}catch{continue}}}catch{}let A=I;for(;A&&A!==r&&!C;){if(A instanceof SVGElement&&A.tagName==="g"){let G=typeof A.className=="string"?A.className:A.className.baseVal;if(G&&G.includes("message")){C=A;break}}A=A.parentElement}if(C?B=C:I instanceof SVGGraphicsElement&&(B=I),B){P=!0;let G=String(E),q=null;for(let[z,_]of s.entries())if(z===G){q=_;break}if(q&&q!==B&&s.delete(G),!s.has(G)){s.set(G,B);let z={location:"mermaidDiagram.ts:645",message:"found sequence message label",data:{diagramType:n,alias:G,elementTag:B.tagName,className:(typeof B.className=="string"?B.className:B.className.baseVal).slice(0,50)},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"C"};console.log("[MermaidDiagram]",z.message,z.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(z)}).catch(()=>{})}continue}}}if(n==="quadrantChart"){let b=I;for(;b&&b!==r;){if(b instanceof SVGElement&&b.tagName==="g"){let C=typeof b.className=="string"?b.className:b.className.baseVal;if(C&&C.includes("data-point")&&!C.includes("data-points")&&!C.includes("main")&&b.querySelector("circle")){B=b,P=!0;let A=String(E),G=null;for(let[_,F]of s.entries())if(_===A){G=F;break}if(G){let _=typeof G.className=="string"?G.className:G.className.baseVal;if(_&&(_.includes("main")||_.includes("data-points"))){s.delete(A);let F={location:"mermaidDiagram.ts:572",message:"replacing parent container mapping with data-point",data:{diagramType:n,alias:A,oldElementTag:G.tagName,oldClassName:_,newElementTag:B.tagName,newClassName:C},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"D"};console.log("[MermaidDiagram]",F.message,F.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(F)}).catch(()=>{})}}let q=null;for(let[_,F]of s.entries())if(F===B){q=_;break}if(q&&A.length<=q.length){P=!1;break}q&&s.delete(q),s.set(A,B);let z={location:"mermaidDiagram.ts:610",message:"found quadrant data-point group",data:{diagramType:n,alias:A,elementTag:B.tagName,className:C,hasCircle:!!B.querySelector("circle"),replacedParent:!!G},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"C"};console.log("[MermaidDiagram]",z.message,z.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(z)}).catch(()=>{});break}}b=b.parentElement}if(P&&B)continue}for(;w&&w!==r;){if(w instanceof SVGElement&&w.tagName==="g"){let b=w instanceof SVGElement?typeof w.className=="string"?w.className:w.className.baseVal:"",C=w.querySelector("rect, circle, ellipse, polygon, path");if(n==="pie"&&b&&b.includes("legend")){w=w.parentElement;continue}if(n==="quadrantChart"&&b&&(b.includes("main")||b.includes("data-points"))){w=w.parentElement;continue}if(n==="quadrantChart"&&b&&(b.includes("point")||b.includes("quadrant")||b.includes("data"))){if(b&&b.includes("data-point")&&!b.includes("data-points")){if(B=w,w.querySelector("circle"))break}else if(!B&&!b.includes("main")&&!b.includes("data-points")&&(B=w,w.querySelector("circle")))break}if((b&&(b.includes("c4")||b.includes("element")||b.includes("component")||b.includes("container")||b.includes("relationship")||b.includes("boundary")||b.includes("branch")||b.includes("commit")||b.includes("merge")||b.includes("branchLabel")||b.includes("label")||b.includes("step")||b.includes("task")||b.includes("section")||b.includes("journey")||b.includes("slice")||b.includes("segment")||b.includes("pie")||b.includes("quadrant")||b.includes("point")||b.includes("timeline")||b.includes("event"))||C||!B)&&(B=w,C||b&&(b.includes("branchLabel")||b.includes("label")||b.includes("step")||b.includes("task")||b.includes("slice")||b.includes("point")||b.includes("quadrant"))))break}w=w.parentElement}if(B){let b=String(E);if(n==="quadrantChart"){let A=s.get(b);if(A){let G=typeof A.className=="string"?A.className:A.className.baseVal;if(G&&(G.includes("main")||G.includes("data-points"))||G&&G.includes("data-point")&&!G.includes("data-points"))continue}}if(n==="erDiagram"||n==="gitGraph"||n==="journey"||n==="pie"||n==="quadrantChart"){let A=null;for(let[G,q]of s.entries())if(q===B){A=G;break}if(A&&b.length<=A.length)continue;A&&s.delete(A)}if(s.has(b)||(s.set(b,B),P=!0),(n==="c4Component"||n==="c4Container"||n==="c4Context"||n==="erDiagram"||n==="gitGraph"||n==="journey"||n==="pie"||n==="quadrantChart")&&(n==="c4Component"?["controller","service","repo","api","db"]:n==="c4Container"?["user","webapp","web","api","db"]:n==="c4Context"?["user","webapp","auth"]:n==="erDiagram"?["CUSTOMER","ORDER","ORDER_ITEM","PRODUCT"]:n==="gitGraph"?["main","develop","feature","Initial","Setup","Feature A","Feature B","Update","Feature C","Release","Tag v1.0","merge"]:n==="journey"?["Landing Page","Pricing Page","Signup Form","Email Verification","Welcome Tour","Dashboard"]:n==="pie"?["Desktop","Mobile","Tablet","Other"]:n==="quadrantChart"?["Leader","Challenger","Niche","Innovator"]:[]).includes(b)){let A=B instanceof SVGElement?typeof B.className=="string"?B.className:B.className.baseVal:"",G={location:"mermaidDiagram.ts:148",message:"found element by text fallback",data:{diagramType:n,alias:E,elementTag:B.tagName,groupId:B.id,className:A,hasShapes:!!B.querySelector("rect, circle, ellipse, polygon, path")},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"};console.log("[MermaidDiagram]",G.message,G.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(G)}).catch(()=>{})}break}}let V=String(E);if((n==="c4Component"||n==="c4Container"||n==="c4Context"||n==="erDiagram"||n==="gitGraph"||n==="journey"||n==="pie"||n==="quadrantChart")&&!P&&(n==="c4Component"?["controller","service","repo","api","db"]:n==="c4Container"?["user","webapp","web","api","db"]:n==="c4Context"?["user","webapp","auth"]:n==="erDiagram"?["CUSTOMER","ORDER","ORDER_ITEM","PRODUCT"]:n==="gitGraph"?["main","develop","feature","Initial","Setup","Feature A","Feature B","Update","Feature C","Release","Tag v1.0","merge"]:n==="journey"?["Landing Page","Pricing Page","Signup Form","Email Verification","Welcome Tour","Dashboard"]:n==="pie"?["Desktop","Mobile","Tablet","Other"]:n==="quadrantChart"?["Leader","Challenger","Niche","Innovator"]:[]).includes(V)){let I={location:"mermaidDiagram.ts:207",message:"alias NOT found by text search",data:{diagramType:n,alias:V,textElementsFound:R.length},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"};console.log("[MermaidDiagram]",I.message,I.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(I)}).catch(()=>{})}}for(let[E,v]of Object.entries(h)){if(s.has(E))continue;if(n==="c4Container"&&["webapp"].includes(E)){let R={location:"mermaidDiagram.ts:249",message:"searching for boundary by children (second pass)",data:{alias:E,childAliases:v},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"};console.log("[MermaidDiagram]",R.message,R.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(R)}).catch(()=>{})}let L=[];for(let R of v)if(s.has(R))L.push(s.get(R));else{let P=r.querySelector(`[data-id="${R}"]`);P&&P instanceof SVGElement&&L.push(P)}if(n==="c4Container"&&["webapp"].includes(E)){let R={location:"mermaidDiagram.ts:264",message:"found child elements for boundary (second pass)",data:{alias:E,childAliases:v,childElementsFound:L.length,childElementTags:L.map(P=>P.tagName)},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"};console.log("[MermaidDiagram]",R.message,R.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(R)}).catch(()=>{})}if(L.length>=Math.min(2,v.length)){let R=Array.from(r.querySelectorAll("g")),P=[];for(let M of R){let I=!0;for(let w of L)if(!M.contains(w)){I=!1;break}I&&P.push(M)}if(n==="c4Container"&&["webapp"].includes(E)){let M={location:"mermaidDiagram.ts:288",message:"found ancestor candidates (second pass)",data:{alias:E,ancestorCount:P.length,ancestors:P.map(I=>({tagName:I.tagName,id:I.id||null,className:I instanceof SVGElement?typeof I.className=="string"?I.className:I.className.baseVal:"",hasShapes:!!I.querySelector("rect, circle, ellipse, polygon, path")}))},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"};console.log("[MermaidDiagram]",M.message,M.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(M)}).catch(()=>{})}let V=null;if(P.length===0){let M=!0;for(let I of L)if(!r.contains(I)){M=!1;break}M&&(V=r)}else for(let M of P){let I=M instanceof SVGElement?typeof M.className=="string"?M.className:M.className.baseVal:"";if(!!M.querySelector("rect, circle, ellipse, polygon, path")||I.includes("boundary")||I.includes("container")||I.includes("system")){V=M;break}V||(V=M)}if(V&&!s.has(E)&&(s.set(E,V),n==="c4Container"&&["webapp"].includes(E))){let M=V instanceof SVGElement?typeof V.className=="string"?V.className:V.className.baseVal:"",I={location:"mermaidDiagram.ts:315",message:"found boundary by child elements (second pass)",data:{alias:E,childAliases:v,containsChildren:L.length,className:M,hasShapes:!!V.querySelector("rect, circle, ellipse, polygon, path"),groupId:V.id||null},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"};console.log("[MermaidDiagram]",I.message,I.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(I)}).catch(()=>{})}}}}let D=new Map;if(n==="gitGraph"&&e){let g=/merge\s+([A-Za-z0-9_]+)/g,h=e.split(`
`);g.lastIndex=0;let f;for(;(f=g.exec(e))!==null;){let T=h.findIndex(E=>E.includes(f[0]));if(T>=0&&T<h.length-1){let v=h[T+1].match(/commit\s+id:\s*"([^"]+)"/);v&&v[1]&&s.has(v[1])&&(D.has("merge")||D.set("merge",v[1]))}}}for(let[g,h]of s){h.setAttribute("data-id",g);let f=t.getDiagramType();if((f==="c4Component"||f==="c4Container"||f==="c4Context")&&(f==="c4Component"?["controller","service","repo","api","db"]:f==="c4Container"?["user","webapp","web","api","db"]:f==="c4Context"?["user","webapp","auth"]:[]).includes(g)){let E=h instanceof SVGElement?typeof h.className=="string"?h.className:h.className.baseVal:"",v={location:"mermaidDiagram.ts:325",message:"set data-id",data:{diagramType:f,nodeId:g,elementTag:h.tagName,elementClass:E},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"B"};console.log("[MermaidDiagram]",v.message,v.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(v)}).catch(()=>{})}}for(let[g,h]of D.entries()){let f=s.get(h);if(f&&(s.set(g,f),f.setAttribute("data-id",g),n==="gitGraph")){let T={location:"mermaidDiagram.ts:650",message:"mapped merge to commit",data:{diagramType:n,specialAlias:g,mappedNodeId:h,elementTag:f.tagName},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"B"};console.log("[MermaidDiagram]",T.message,T.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(T)}).catch(()=>{})}}for(let[g,h]of D.entries()){let f=s.get(h);f&&(f.setAttribute("data-id-merge",g),s.has(g)||(s.set(g,f),f.setAttribute("data-id",g)))}let k=t.getDiagramType();if(k==="c4Component"||k==="c4Container"||k==="c4Context"||k==="classDiagram"||k==="erDiagram"||k==="gitGraph"||k==="journey"||k==="pie"||k==="quadrantChart"){let g=Array.from(r.querySelectorAll("[data-id]")),h=r.getAttribute("data-id"),f=g.map(E=>E.getAttribute("data-id")).filter(E=>E);h&&!f.includes(h)&&f.push(h);let T={location:"mermaidDiagram.ts:456",message:"after setting data-id",data:{diagramType:k,totalElementsWithDataId:g.length,rootHasDataId:!!h,rootDataId:h,dataIds:f.slice(0,20)},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"B"};console.log("[MermaidDiagram]",T.message,T.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(T)}).catch(()=>{})}}var Re=(r,t,e)=>({getRoot:()=>t,getContainer:()=>r,resolveTarget:s=>H({getRoot:()=>t,getStrategy:()=>e},s),getStrategy:()=>e,destroy:()=>{r.innerHTML=""}});function _e(r){let t=new Set,e=[/Component\s*\(\s*([A-Za-z0-9_]+)\s*,/g,/Container\s*\(\s*([A-Za-z0-9_]+)\s*,/g,/Person\s*\(\s*([A-Za-z0-9_]+)\s*,/g,/System\s*\(\s*([A-Za-z0-9_]+)\s*,/g,/System_Ext\s*\(\s*([A-Za-z0-9_]+)\s*,/g,/SystemDb\s*\(\s*([A-Za-z0-9_]+)\s*,/g,/Container_Boundary\s*\(\s*([A-Za-z0-9_]+)\s*,/g,/System_Boundary\s*\(\s*([A-Za-z0-9_]+)\s*,/g];for(let s of e){s.lastIndex=0;let a;for(;(a=s.exec(r))!==null;)t.add(a[1])}return t}var Ne=()=>({async render({mountEl:r,mermaidText:t}){let e=window.mermaid;if(!e||typeof e.render!="function")throw new W("Mermaid is not available on window.mermaid","MPF_MERMAID_UNAVAILABLE");let s=`finsteps-${Math.random().toString(36).slice(2,8)}`,a={location:"mermaidDiagram.ts:77",message:"attempting mermaid render",data:{mermaidTextPreview:t.trim().substring(0,100),firstLine:t.trim().split(`
`)[0].trim()},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"};t.trim().toLowerCase().includes("c4component")&&console.log("[MermaidDiagram]",a.message,a.data,"full text:",t),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}).catch(()=>{});let n;try{n=await e.render(s,t)}catch(N){let x={location:"mermaidDiagram.ts:84",message:"mermaid render failed",data:{errorMessage:N instanceof Error?N.message:String(N),errorName:N instanceof Error?N.name:typeof N,mermaidTextPreview:t.trim().substring(0,100),firstLine:t.trim().split(`
`)[0].trim()},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"};throw console.error("[MermaidDiagram]",x.message,x.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(x)}).catch(()=>{}),new W(`Failed to render Mermaid diagram: ${N}`,"MPF_MERMAID_RENDER_FAILED")}let c={location:"mermaidDiagram.ts:91",message:"mermaid render succeeded",data:{hasSvg:!!n?.svg},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"};t.trim().toLowerCase().includes("c4component")&&console.log("[MermaidDiagram]",c.message,c.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)}).catch(()=>{});let{svg:i}=n;r.innerHTML="";let l=document.createElement("div");l.className="finsteps-diagram",l.tabIndex=0,l.setAttribute("role","application"),l.innerHTML=i,r.appendChild(l);let o=l.querySelector("svg");if(!o)throw new W("Mermaid render did not return an SVG element","MPF_MERMAID_RENDER_FAILED");let u=Ae(t),d={location:"mermaidDiagram.ts:107",message:"diagram type detected",data:{diagramType:u,firstLine:t.trim().split(`
`)[0].trim()},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"C"};(u==="c4Component"||t.trim().toLowerCase().includes("c4component"))&&console.log("[MermaidDiagram]",d.message,d.data),fetch("http://127.0.0.1:7242/ingest/e6be1aad-0bf5-49de-87e2-f8c8215b6261",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)}).catch(()=>{});let m=j.getOrDefault(u);qe(o,m,t),o.removeAttribute("width"),o.removeAttribute("height"),o.setAttribute("width","100%"),o.setAttribute("height","100%"),o.getAttribute("preserveAspectRatio")||o.setAttribute("preserveAspectRatio","xMidYMid meet");let p=o.getAttribute("viewBox"),S=p;if(!p||p==="0 0 0 0"){let N=o.querySelector("g");if(N)try{let x=N.getBBox();x.width>0&&x.height>0&&(S=`${x.x-40} ${x.y-40} ${x.width+40*2} ${x.height+40*2}`,o.setAttribute("viewBox",S))}catch{let x=o.getAttribute("width"),$=o.getAttribute("height");if(x&&$){let D=parseFloat(x)||1e3,k=parseFloat($)||1e3;S=`0 0 ${D} ${k}`,o.setAttribute("viewBox",S)}}}return S&&o.setAttribute("data-initial-viewbox",S),Re(l,o,m)}});var me=class{constructor(t){this.handlers=t}async run(t,e,s){let a=[];for(let n of t){let c=this.handlers[n.type];if(!c){let i=new J(`Unknown action: ${n.type}`,"MPF_ACTION_UNKNOWN");if(s==="haltOnError")throw i;a.push(i);continue}try{await c(e,n)}catch(i){if(i instanceof Error){if(s==="haltOnError")throw i;a.push(i)}else if(s==="haltOnError")throw i}}return a}};var Ie=(r,t,e)=>{for(let s of r.elements)s.classList.remove(r.className);r.elements.clear(),r.className=e;for(let s of t)s.classList.add(e),r.elements.add(s)},ze=(r,t)=>{if(!t)return[];let e=H(r.diagram,t);return e?[e]:[]},Te=()=>{let r={className:"finsteps-highlight",elements:new Set};return{"nav.next":async({controller:e})=>{await e.next()},"nav.prev":async({controller:e})=>{await e.prev()},"nav.goto":async({controller:e},s)=>{let a=s.payload?.index,n=s.payload?.id;if(typeof a=="number"){await e.goto(a);return}if(typeof n=="string"){await e.goto(n);return}throw new J("nav.goto requires index or id","MPF_ACTION_INVALID_ARGS")},"nav.reset":async({controller:e})=>{await e.reset()},"camera.fit":async(e,s)=>{if(!e.camera)return;let a=s.payload?.target,n=H(e.diagram,a);if(!n)throw new J("camera.fit missing target","MPF_ACTION_INVALID_ARGS");let i=s.payload?.durationMs??s.payload?.duration,l=s.payload?.easing;await e.camera.fit(n,{padding:typeof s.payload?.padding=="number"?s.payload.padding:void 0,duration:typeof i=="number"?i:void 0,easing:typeof l=="string"?l:void 0})},"camera.reset":({camera:e})=>{e?.reset()},"camera.fitAll":(e,s)=>{if(!e.camera)return;let a=typeof s.payload?.padding=="number"?s.payload.padding:void 0;e.camera.fitAll?e.camera.fitAll(a):e.camera.reset&&e.camera.reset()},"overlay.bubble":(e,s)=>{if(!e.overlay)return;let a=s.payload?.target,n=H(e.diagram,a);if(!n)throw new J("overlay.bubble missing target","MPF_ACTION_INVALID_ARGS");let c=String(s.payload?.text??"");e.overlay.showBubble({id:typeof s.payload?.id=="string"?s.payload.id:void 0,target:n,text:c})},"overlay.hide":(e,s)=>{e.overlay?.hideBubble(typeof s.payload?.id=="string"?s.payload.id:void 0)},"style.highlight":(e,s)=>{let a=s.payload?.target,n=typeof s.payload?.className=="string"?s.payload.className:"finsteps-highlight",c=ze(e,a);Ie(r,c,n)},"style.clear":()=>{Ie(r,[],r.className)},wait:async(e,s)=>{let a=typeof s.payload?.ms=="number"?s.payload.ms:0;await new Promise(n=>window.setTimeout(n,a))}}};var Q=class{constructor(){this.disposers=[];this.timeouts=[]}bind(t,e){for(let s of t){if(s.event==="timer"){let l=window.setTimeout(async()=>{let o=await e.actionEngine.run(s.actions,{controller:e.controller,diagram:e.diagram,event:{type:"timer",target:null,currentTarget:null,originalEvent:null,timeStamp:Date.now()},camera:e.camera,overlay:e.overlay},e.errorPolicy);for(let u of o)e.onError(u)},s.delayMs??0);this.timeouts.push(l);continue}let a=s.event==="key"?e.diagram.getContainer():e.diagram.getRoot(),n=H(e.diagram,s.target)??a,c=s.event==="click"?"click":s.event==="hover"?"mouseenter":s.event==="key"?"keydown":s.eventName??s.event,i=async l=>{if(s.event==="key"&&s.key&&l.key!==s.key)return;let o=Fe(l,c),u=await e.actionEngine.run(s.actions,{controller:e.controller,diagram:e.diagram,event:o,camera:e.camera,overlay:e.overlay},e.errorPolicy);for(let d of u)e.onError(d)};n.addEventListener(c,i),this.disposers.push(()=>n.removeEventListener(c,i))}}destroy(){for(let t of this.disposers)t();for(let t of this.timeouts)window.clearTimeout(t);this.disposers=[],this.timeouts=[]}},Fe=(r,t)=>r instanceof MouseEvent?{type:t,target:r.target,currentTarget:r.currentTarget,clientX:r.clientX,clientY:r.clientY,timeStamp:r.timeStamp,originalEvent:r}:r instanceof KeyboardEvent?{type:t,target:r.target,currentTarget:r.currentTarget,key:r.key,timeStamp:r.timeStamp,originalEvent:r}:{type:t,target:r.target,currentTarget:r.currentTarget,timeStamp:r.timeStamp,originalEvent:r};var ue=class{constructor(){this.listeners=new Map}on(t,e){let s=this.listeners.get(t)??new Set;return s.add(e),this.listeners.set(t,s),()=>{s.delete(e)}}emit(t,e){let s=this.listeners.get(t);if(s)for(let a of s)a(e)}clear(){this.listeners.clear()}};var pe=class{constructor(t){this.deps=t;this.emitter=new ue;this.bindingEngine=new Q;this.stepBindingEngine=new Q;this.currentStepIndex=-1;this.previousStepIndex=-1;this.lastError=null;this.failedStepIndex=null;this.executionContext={};let e={...Te(),...t.actionHandlers??{}};this.actionEngine=new me(e),this.steps=t.ast.steps??[]}async init(t){if(t&&this.emitter.emit("render",t),this.deps.ast.bindings?.length&&this.bindingEngine.bind(this.deps.ast.bindings,{diagram:this.deps.diagram,actionEngine:this.actionEngine,errorPolicy:this.deps.errorPolicy,controller:this,camera:this.deps.camera,overlay:this.deps.overlay,onError:e=>this.emitActionError(e)}),this.steps.length>0&&await this.goto(0),this.deps.hooks?.onInit)try{await this.deps.hooks.onInit(this)}catch(e){console.warn("[MermaidController] onInit hook error:",e)}}async next(){await this.goto(this.currentStepIndex+1)}async prev(){await this.goto(this.currentStepIndex-1)}async goto(t){let e=typeof t=="number"?t:this.steps.findIndex(u=>u.id===t);if(e<0||e>=this.steps.length)return;let s=this.steps[e],a=s.errorPolicy??this.deps.errorPolicy;this.previousStepIndex=this.currentStepIndex;let n=this.previousStepIndex>=0?this.steps[this.previousStepIndex]:void 0;this.executionContext.previousStep=n,this.executionContext.currentStep=s,this.stepBindingEngine.destroy(),this.deps.overlay?.clear&&this.deps.overlay.clear();let c=s.actions.length>0&&(s.actions[0].type==="camera.fit"||s.actions[0].type==="camera.reset"||s.actions[0].type==="camera.fitAll");this.deps.camera&&!c&&this.deps.camera.reset(),await this.actionEngine.run([{type:"style.clear"}],{controller:this,diagram:this.deps.diagram,camera:this.deps.camera,overlay:this.deps.overlay},"continueOnError"),await new Promise(u=>{requestAnimationFrame(()=>{requestAnimationFrame(()=>u())})});let i=[],l=!1;try{for(let d of s.actions){this.executionContext.currentAction=d;let m={action:{...d},step:{...s},context:this.getExecutionContext()};if(this.emitter.emit("actionstart",m),this.deps.hooks?.onActionStart)try{this.deps.hooks.onActionStart(d,s)}catch(p){console.warn("[MermaidController] onActionStart hook error:",p)}}let u=await this.actionEngine.run(s.actions,{controller:this,diagram:this.deps.diagram,camera:this.deps.camera,overlay:this.deps.overlay},a);i=u;for(let d of s.actions){let m=u.find(N=>N instanceof Error&&N.message.includes(d.type)),p={success:!m,error:m},S={action:{...d},result:p,step:{...s},context:this.getExecutionContext()};if(this.emitter.emit("actioncomplete",S),this.deps.hooks?.onActionComplete)try{this.deps.hooks.onActionComplete(d,p)}catch(N){console.warn("[MermaidController] onActionComplete hook error:",N)}}for(let d of u)this.emitActionError(d,s)}catch(u){l=!0;let d=u instanceof Error?u:new Error(String(u));if(this.lastError=d,this.failedStepIndex=e,this.emitActionError(d,s),a==="haltOnError"){this.currentStepIndex=e,this.emitter.emit("stepchange",{state:this.getState(),previousState:{stepIndex:this.previousStepIndex,stepId:this.steps[this.previousStepIndex]?.id,stepCount:this.steps.length},step:{...s},previousStep:n?{...n}:void 0});return}}!l&&i.length===0&&(this.lastError=null,this.failedStepIndex=null),this.currentStepIndex=e,s.bindings?.length&&this.stepBindingEngine.bind(s.bindings,{diagram:this.deps.diagram,actionEngine:this.actionEngine,errorPolicy:a,controller:this,camera:this.deps.camera,overlay:this.deps.overlay,onError:u=>this.emitActionError(u,s)}),this.executionContext.currentAction=void 0;let o={state:this.getState(),previousState:{stepIndex:this.previousStepIndex,stepId:this.steps[this.previousStepIndex]?.id,stepCount:this.steps.length},step:{...s},previousStep:n?{...n}:void 0};if(this.emitter.emit("stepchange",o),this.deps.hooks?.onStepChange)try{await this.deps.hooks.onStepChange(this.getState(),s)}catch(u){console.warn("[MermaidController] onStepChange hook error:",u)}}async reset(){await this.goto(0)}async retry(){this.failedStepIndex!==null&&this.failedStepIndex>=0?await this.goto(this.failedStepIndex):this.currentStepIndex>=0&&await this.goto(this.currentStepIndex)}clearError(){this.lastError=null,this.failedStepIndex=null}async updateAst(t,e){let s=e?.preserveState??!1,a=this.getState(),n=this.steps[this.currentStepIndex]?.id;if(this.deps.ast=t,this.steps=t.steps??[],this.bindingEngine.destroy(),t.bindings?.length&&this.bindingEngine.bind(t.bindings,{diagram:this.deps.diagram,actionEngine:this.actionEngine,errorPolicy:this.deps.errorPolicy,controller:this,camera:this.deps.camera,overlay:this.deps.overlay,onError:c=>this.emitActionError(c)}),s&&n){let c=this.steps.findIndex(i=>i.id===n);c>=0?(this.currentStepIndex=c,await this.goto(c)):this.steps.length>0?await this.goto(0):this.currentStepIndex=-1}else this.steps.length>0?await this.goto(0):this.currentStepIndex=-1;this.emitter.emit("astchange",{previousState:a,newState:this.getState(),previousSteps:a.stepCount,newSteps:this.steps.length})}destroy(){this.bindingEngine.destroy(),this.stepBindingEngine.destroy(),this.deps.camera?.destroy(),this.deps.overlay?.destroy(),this.deps.diagram.destroy(),this.emitter.clear()}getState(){return{stepIndex:this.currentStepIndex,stepId:this.steps[this.currentStepIndex]?.id,stepCount:this.steps.length,errorState:this.lastError?{hasError:!0,lastError:this.lastError,failedStep:this.failedStepIndex??void 0}:void 0}}getExecutionContext(){return{currentAction:this.executionContext.currentAction?{...this.executionContext.currentAction}:void 0,currentStep:this.executionContext.currentStep?{...this.executionContext.currentStep}:void 0,previousStep:this.executionContext.previousStep?{...this.executionContext.previousStep}:void 0}}async setState(t){if(typeof t.stepIndex=="number"){await this.goto(t.stepIndex);return}typeof t.stepId=="string"&&await this.goto(t.stepId)}on(t,e){return this.emitter.on(t,e)}getDeps(){return{diagram:this.deps.diagram,camera:this.deps.camera,overlay:this.deps.overlay}}getSteps(){return this.steps.map(t=>({...t}))}getCurrentStep(){return this.currentStepIndex<0||this.currentStepIndex>=this.steps.length?null:{...this.steps[this.currentStepIndex]}}getActionEngine(){return this.actionEngine}emitActionError(t,e){this.lastError=t;let s={step:e?{...e}:this.executionContext.currentStep,action:this.executionContext.currentAction},a={error:t,...s,context:this.getExecutionContext()};if(this.emitter.emit("actionerror",a),this.emitter.emit("error",a),this.deps.hooks?.onError)try{this.deps.hooks.onError(t,s)}catch(n){console.warn("[MermaidController] onError hook error:",n)}}};var ys=r=>{let t=r.parentElement??document.body;return{getRoot:()=>r,getContainer:()=>t,resolveTarget:e=>H({getRoot:()=>r},e),destroy:()=>{r.remove()}}},Ss=()=>({fit:()=>{},reset:()=>{},destroy:()=>{}}),Es=()=>({showBubble:()=>{},hideBubble:()=>{},destroy:()=>{}});var je=new Set(["mpd","deck","meta","let","use","diagram","mermaid","config","assets","runtime","camera","overlay","navigation","performance","selectors","styles","scene","step","as","focus","pad","align","lock","id","do","assert","else","binding","priority","on","target","when","node","edge","subgraph","css","text","group","union","intersect","except","true","false","null","or","and","viewport","container","svg","engine","options","bounds","strategy","fallback","classes","spotlight","theme","keys","wheelZoom","dragPan","tapToAdvance","progressUI","startAt","click","dblclick","hover","mouseenter","mouseleave","wheel","scroll","key","timer","custom","any"]),Ce=new Set(["==","!=","<=",">=","<",">","+","-","*","/","%","!"]),Le=new Set(["{","}","(",")","[","]",":",";",",",".","=","$"]),Ke=/^[+-]?(?:\d+(?:\.\d+)?|\.\d+)/,Ze=/^\d+/,Ge=/^[A-Za-z_][A-Za-z0-9_-]*/,We=/^#[0-9A-Fa-f]{3}(?:[0-9A-Fa-f]{3})?/;function K(r,t){let{line:e,column:s,offset:a}=r;for(let n of t)a+=1,n===`
`?(e+=1,s=1):s+=1;return{line:e,column:s,offset:a}}function He(r,t){return{start:r,end:t}}function ke(r){let t=[],e=[],s={offset:0,line:1,column:1},a=0,n=(c,i,l,o,u,d)=>{t.push({type:c,value:i,start:o,end:u,image:l,heredoc:d})};for(;a<r.length;){let c=r[a];if(c===" "||c==="	"||c==="\r"||c===`
`){let d=/^[ \t\r\n]+/.exec(r.slice(a));if(d){let m=d[0];s=K(s,m),a+=m.length;continue}}if(c==="#"||c==="/"&&r[a+1]==="/"){let d=/^(#|\/\/)[^\n\r]*/.exec(r.slice(a));if(d){let m=d[0];s=K(s,m),a+=m.length;continue}}if(r.startsWith("<<<",a)){let d=Je(r,a);if(d){let{image:m,tag:p,body:S}=d,N=s,x=K(s,m);n("heredoc",m,m,N,x,{tag:p,body:S}),s=x,a+=m.length;continue}}if(c==='"'||c==="'"){let{image:d,value:m}=Ue(r,a,s,e),p=s,S=K(s,d);n("string",m,d,p,S),s=S,a+=d.length;continue}if(c==="#"){let d=We.exec(r.slice(a));if(d){let m=d[0],p=s,S=K(s,m);n("color",m,m,p,S),s=S,a+=m.length;continue}}let i=Ke.exec(r.slice(a));if(i){let d=i[0],m=r.slice(a+d.length),p=/^(ms|s|m)/.exec(m);if(p){let x=d+p[0],$=s,D=K(s,x);n("duration",x,x,$,D),s=D,a+=x.length;continue}if(m.startsWith("%")){let x=`${d}%`,$=s,D=K(s,x);n("percent",x,x,$,D),s=D,a+=x.length;continue}let S=s,N=K(s,d);n("number",d,d,S,N),s=N,a+=d.length;continue}let l=Ze.exec(r.slice(a));if(l){let d=l[0],m=s,p=K(s,d);n("int",d,d,m,p),s=p,a+=d.length;continue}let o=Ge.exec(r.slice(a));if(o){let d=o[0],m=s,p=K(s,d);d==="true"||d==="false"?n("boolean",d,d,m,p):d==="null"?n("null",d,d,m,p):je.has(d)?n("keyword",d,d,m,p):n("identifier",d,d,m,p),s=p,a+=d.length;continue}let u=r.slice(a,a+2);if(Ce.has(u)){let d=s,m=K(s,u);n("operator",u,u,d,m),s=m,a+=u.length;continue}if(Ce.has(c)){let d=s,m=K(s,c);n("operator",c,c,d,m),s=m,a+=1;continue}if(Le.has(c)){let d=s,m=K(s,c);n("punct",c,c,d,m),s=m,a+=1;continue}e.push({message:`Unexpected character '${c}'.`,severity:"error",span:He(s,K(s,c)),code:"lex/unexpected-character"}),s=K(s,c),a+=1}return t.push({type:"eof",value:"<eof>",start:s,end:s,image:""}),{tokens:t,diagnostics:e}}function Ue(r,t,e,s){let a=r[t],n=t+1,c="";for(;n<r.length;){let l=r[n];if(l===a)return{image:r.slice(t,n+1),value:c};if(l==="\\"){let o=r[n+1];if(o==="n"){c+=`
`,n+=2;continue}if(o==="t"){c+="	",n+=2;continue}if(o==="r"){c+="\r",n+=2;continue}if(o===a){c+=a,n+=2;continue}c+=o??"",n+=2;continue}c+=l,n+=1}let i=r.slice(t,n);return s.push({message:"Unterminated string literal.",severity:"error",span:{start:e,end:K(e,i)},code:"lex/unterminated-string"}),{image:i,value:c}}function Je(r,t){let e=Ge.exec(r.slice(t+3));if(!e)return null;let s=e[0],a=t+3+s.length;if(r[a]!==`
`)return null;let c=`
${s}>>>`,i=r.indexOf(c,a+1);if(i===-1)return null;let l=r.slice(t,i+c.length),o=r.slice(a+1,i);return{image:l,tag:s,body:o}}var Ve="1.0";function Ye(r){let t=ke(r),e=new Se(r,t.tokens,t.diagnostics),s=e.parseProgram(),a=e.diagnostics;return s&&a.push(...Xe(s)),{ast:s,diagnostics:a}}var he=class he{constructor(t,e,s){this.source=t;this.tokens=e;this.index=0;this.diagnostics=s.slice()}parseProgram(){let t=this.peek();if(!this.consumeKeyword("mpd"))return null;let e=this.parseVersion();if(!e)return null;let s=[];if(this.matchKeyword("deck")){let n=this.parseDeck();n&&s.push(n)}else for(;!this.isAtEnd();){let n=this.parseTopLevelItem();if(!n)break;s.push(n)}let a=this.previous();return{type:"Program",version:e.value,body:s,span:y(t,a)}}parseDeck(){let t=this.consumeKeyword("deck");if(!t)return null;let e=this.parseOptionalName(),{items:s,end:a}=this.parseBlock(()=>this.parseDeckItem());return{type:"Deck",name:e??void 0,items:s,span:y(t,a)}}parseTopLevelItem(){return this.parseDeckItemInternal(!0)}parseDeckItem(){return this.parseDeckItemInternal(!1)}parseDeckItemInternal(t){if(this.isAtEnd())return null;let e=this.peek();if(e.type==="keyword"){let s=he.KEYWORD_ITEM_PARSERS[e.value];if(s)return s(this)}return e.type==="identifier"?this.parseUnknownBlock():(t&&this.error(e,"top-level declaration"),null)}parseUnknownBlock(){let t=this.consume("identifier");if(!t)return null;let e=this.consumePunct("{");if(!e)return null;let s=1;for(;!this.isAtEnd()&&s>0;){let c=this.peek();c.type==="punct"&&c.value==="{"?s+=1:c.type==="punct"&&c.value==="}"&&(s-=1),this.advance()}let a=this.previous(),n=this.source.slice(e.start.offset,a.end.offset);return{type:"UnknownBlock",name:t.value,content:n,span:y(t,a)}}parseMetaDecl(){let t=this.consumeKeyword("meta");if(!t)return null;let e=[];for(this.consumePunct("{");!this.isAtEnd()&&!this.matchPunct("}");){let a=this.parseMetaEntry();a&&e.push(a),this.matchPunct(",")&&this.consumePunct(",")}let s=this.consumePunct("}")??this.previous();return{type:"MetaDecl",entries:e,span:y(t,s)}}parseMetaEntry(){let t=this.consume("identifier");if(!t)return null;this.consumePunct(":");let e=this.parseExpr();return e?{type:"MetaEntry",key:t.value,value:e,span:y(t,this.previous())}:null}parseConstDecl(){let t=this.consumeKeyword("let");if(!t)return null;let e=this.consume("identifier");if(!e)return null;this.consumePunct("=");let s=this.parseExpr();return this.consumePunct(";"),{type:"ConstDecl",name:e.value,value:s??this.emptyLiteral(e),span:y(t,this.previous())}}parsePluginDecl(){let t=this.consumeKeyword("use");if(!t)return null;let e=this.parseName(),s;return this.peek().type==="punct"&&this.peek().value==="{"&&(s=this.parseObjectExpr()),this.consumePunct(";"),{type:"PluginDecl",ref:e,options:s,span:y(t,this.previous())}}parseDiagramDecl(){let t=this.consumeKeyword("diagram");if(!t)return null;let e=this.parseName(),{items:s,end:a}=this.parseBlock(()=>this.parseDiagramItem());return{type:"DiagramDecl",id:e,items:s.filter(n=>n!==null),span:y(t,a)}}parseDiagramItem(){let t=this.peek();if(t.type==="keyword")switch(t.value){case"mermaid":return this.parseMermaidSourceDecl();case"config":return this.parseMermaidConfigDecl();case"assets":return this.parseDiagramAssetsDecl();case"meta":return this.parseMetaDecl();default:break}return null}parseMermaidSourceDecl(){let t=this.consumeKeyword("mermaid");if(!t)return null;let e=this.consume("heredoc");return!e||!e.heredoc?null:(this.consumePunct(";"),{type:"MermaidSourceDecl",source:e.heredoc.body,tag:e.heredoc.tag,span:y(t,this.previous())})}parseMermaidConfigDecl(){let t=this.consumeKeyword("config");if(!t)return null;let e=this.parseObjectExpr();return this.consumePunct(";"),{type:"MermaidConfigDecl",config:e,span:y(t,this.previous())}}parseDiagramAssetsDecl(){let t=this.consumeKeyword("assets");if(!t)return null;let e=this.parseObjectExpr();return this.consumePunct(";"),{type:"DiagramAssetsDecl",assets:e,span:y(t,this.previous())}}parseRuntimeDecl(){let t=this.consumeKeyword("runtime");if(!t)return null;let{items:e,end:s}=this.parseBlock(()=>this.parseRuntimeItem());return{type:"RuntimeDecl",items:e.filter(a=>a!==null),span:y(t,s)}}parseRuntimeItem(){let t=this.peek();if(t.type==="keyword")switch(t.value){case"camera":return this.parseCameraDecl();case"overlay":return this.parseOverlayDecl();case"navigation":return this.parseNavigationDecl();case"performance":return this.parsePerformanceDecl();case"meta":return this.parseMetaDecl();default:break}return null}parseCameraDecl(){let t=this.consumeKeyword("camera");if(!t)return null;let{items:e,end:s}=this.parseBlock(()=>this.parseCameraItem());return{type:"CameraDecl",items:e.filter(a=>a!==null),span:y(t,s)}}parseCameraItem(){if(this.matchKeyword("engine")){let t=this.consumeKeyword("engine");this.consumePunct(":");let e=this.parseName();return this.consumePunct(";"),{type:"CameraEngine",name:e,span:y(t,this.previous())}}if(this.matchKeyword("options")){let t=this.consumeKeyword("options");this.consumePunct(":");let e=this.parseObjectExpr();return this.consumePunct(";"),{type:"CameraOptions",options:e,span:y(t,this.previous())}}if(this.matchKeyword("bounds")){let t=this.consumeKeyword("bounds");this.consumePunct(":");let s=this.consume("keyword")?.value??"viewport";return this.consumePunct(";"),{type:"CameraBounds",bounds:s,span:y(t,this.previous())}}return null}parseOverlayDecl(){let t=this.consumeKeyword("overlay");if(!t)return null;let{items:e,end:s}=this.parseBlock(()=>this.parseOverlayItem());return{type:"OverlayDecl",items:e.filter(a=>a!==null),span:y(t,s)}}parseOverlayItem(){if(this.matchKeyword("engine")){let t=this.consumeKeyword("engine");this.consumePunct(":");let e=this.parseName();return this.consumePunct(";"),{type:"OverlayEngine",name:e,span:y(t,this.previous())}}if(this.matchKeyword("options")){let t=this.consumeKeyword("options");this.consumePunct(":");let e=this.parseObjectExpr();return this.consumePunct(";"),{type:"OverlayOptions",options:e,span:y(t,this.previous())}}return null}parseNavigationDecl(){let t=this.consumeKeyword("navigation");if(!t)return null;let{items:e,end:s}=this.parseBlock(()=>this.parseNavigationItem());return{type:"NavigationDecl",items:e.filter(a=>a!==null),span:y(t,s)}}parseNavigationItem(){if(this.matchKeyword("keys")){let t=this.consumeKeyword("keys");this.consumePunct(":");let e=this.parseObjectExpr();return this.consumePunct(";"),{type:"NavigationKeys",options:e,span:y(t,this.previous())}}if(this.matchKeyword("wheelZoom")){let t=this.consumeKeyword("wheelZoom");this.consumePunct(":");let e=this.parseBoolean();return this.consumePunct(";"),{type:"NavigationWheelZoom",value:e,span:y(t,this.previous())}}if(this.matchKeyword("dragPan")){let t=this.consumeKeyword("dragPan");this.consumePunct(":");let e=this.parseBoolean();return this.consumePunct(";"),{type:"NavigationDragPan",value:e,span:y(t,this.previous())}}if(this.matchKeyword("tapToAdvance")){let t=this.consumeKeyword("tapToAdvance");this.consumePunct(":");let e=this.parseBoolean();return this.consumePunct(";"),{type:"NavigationTapToAdvance",value:e,span:y(t,this.previous())}}if(this.matchKeyword("progressUI")){let t=this.consumeKeyword("progressUI");this.consumePunct(":");let e=this.parseBoolean();return this.consumePunct(";"),{type:"NavigationProgressUI",value:e,span:y(t,this.previous())}}if(this.matchKeyword("startAt")){let t=this.consumeKeyword("startAt");this.consumePunct(":");let e=this.peek(),s=0;return e.type==="int"||e.type==="number"?(this.advance(),s=Number(e.value)):e.type==="string"?(this.advance(),s=e.value):this.error(e,"number or string"),this.consumePunct(";"),{type:"NavigationStartAt",value:s,span:y(t,this.previous())}}return null}parsePerformanceDecl(){let t=this.consumeKeyword("performance");if(!t)return null;let e=this.parseObjectExpr();return this.consumePunct(";"),{type:"PerformanceDecl",options:e,span:y(t,this.previous())}}parseSelectorsDecl(){let t=this.consumeKeyword("selectors");if(!t)return null;let{items:e,end:s}=this.parseBlock(()=>this.parseSelectorsItem());return{type:"SelectorsDecl",items:e.filter(a=>a!==null),span:y(t,s)}}parseSelectorsItem(){if(this.matchKeyword("strategy")){let t=this.consumeKeyword("strategy");this.consumePunct(":");let s=this.consume("keyword")?.value??"css";return this.consumePunct(";"),{type:"SelectorsStrategy",strategy:s,span:y(t,this.previous())}}if(this.matchKeyword("fallback")){let t=this.consumeKeyword("fallback");this.consumePunct(":");let e=this.parseArrayExpr();return this.consumePunct(";"),{type:"SelectorsFallback",fallback:e,span:y(t,this.previous())}}if(this.matchKeyword("node")){let t=this.consumeKeyword("node");this.consumePunct(":");let e=this.parseObjectExpr();return this.consumePunct(";"),{type:"SelectorsNode",spec:e,span:y(t,this.previous())}}if(this.matchKeyword("edge")){let t=this.consumeKeyword("edge");this.consumePunct(":");let e=this.parseObjectExpr();return this.consumePunct(";"),{type:"SelectorsEdge",spec:e,span:y(t,this.previous())}}if(this.matchKeyword("subgraph")){let t=this.consumeKeyword("subgraph");this.consumePunct(":");let e=this.parseObjectExpr();return this.consumePunct(";"),{type:"SelectorsSubgraph",spec:e,span:y(t,this.previous())}}return this.matchKeyword("meta")?this.parseMetaDecl():null}parseStylesDecl(){let t=this.consumeKeyword("styles");if(!t)return null;let{items:e,end:s}=this.parseBlock(()=>this.parseStylesItem());return{type:"StylesDecl",items:e.filter(a=>a!==null),span:y(t,s)}}parseStylesItem(){if(this.matchKeyword("classes")){let t=this.consumeKeyword("classes");this.consumePunct(":");let e=this.parseObjectExpr();return this.consumePunct(";"),{type:"StylesClasses",classes:e,span:y(t,this.previous())}}if(this.matchKeyword("spotlight")){let t=this.consumeKeyword("spotlight");this.consumePunct(":");let e=this.parseObjectExpr();return this.consumePunct(";"),{type:"StylesSpotlight",spotlight:e,span:y(t,this.previous())}}if(this.matchKeyword("theme")){let t=this.consumeKeyword("theme");this.consumePunct(":");let e=this.parseName();return this.consumePunct(";"),{type:"StylesTheme",theme:e,span:y(t,this.previous())}}return this.matchKeyword("meta")?this.parseMetaDecl():null}parseSceneDecl(){let t=this.consumeKeyword("scene");if(!t)return null;let e=this.parseName(),s;this.matchKeyword("diagram")&&(this.consumeKeyword("diagram"),s=this.parseName());let{items:a,end:n}=this.parseBlock(()=>this.parseSceneItem());return{type:"SceneDecl",name:e,diagram:s,items:a.filter(c=>c!==null),span:y(t,n)}}parseSceneItem(){let t=this.peek();if(t.type==="keyword")switch(t.value){case"step":return this.parseStepDecl();case"binding":return this.parseBindingDecl();case"meta":return this.parseMetaDecl();case"let":return this.parseConstDecl();default:break}return null}parseStepDecl(){let t=this.consumeKeyword("step");if(!t)return null;let e=this.parseName(),s;this.matchKeyword("as")&&(this.consumeKeyword("as"),s=this.consume("identifier")?.value);let{items:a,end:n}=this.parseBlock(()=>this.parseStepStmt());return{type:"StepDecl",name:e,alias:s,statements:a.filter(c=>c!==null),span:y(t,n)}}parseStepStmt(){let t=this.peek();if(t.type==="keyword")switch(t.value){case"focus":return this.parseFocusStmt();case"do":return this.parseDoStmt();case"let":return this.parseLetStmt();case"assert":return this.parseAssertStmt();case"meta":return this.parseMetaDecl();default:break}if(t.type==="identifier"||t.type==="keyword"){if(t.type==="keyword"&&(t.value==="focus"||t.value==="let"||t.value==="assert"||t.value==="meta"))return null;let e=this.parseActionCall();if(e)return{type:"DoStmt",action:e,span:e.span}}return null}parseFocusStmt(){let t=this.consumeKeyword("focus");if(!t)return null;let e=this.parseTargetExpr(),s={};for(;;){if(this.matchKeyword("pad")){this.consumeKeyword("pad");let a=this.parseNumber();s.pad=a;continue}if(this.matchKeyword("align")){this.consumeKeyword("align");let a=this.consume("keyword");s.align=a?.value??"center";continue}if(this.matchKeyword("lock")){this.consumeKeyword("lock");let a=this.consume("keyword");s.lock=a?.value??"none";continue}if(this.matchKeyword("id")){this.consumeKeyword("id");let a=this.consume("identifier");a&&(s.id=a.value);continue}break}return this.consumePunct(";"),{type:"FocusStmt",target:e??this.emptyTarget(t),options:s,span:y(t,this.previous())}}parseDoStmt(){let t=this.consumeKeyword("do");if(!t)return null;let e=this.parseActionCall();return this.consumePunct(";"),{type:"DoStmt",action:e??this.emptyAction(t),span:y(t,this.previous())}}parseLetStmt(){let t=this.consumeKeyword("let");if(!t)return null;let e=this.consume("identifier");this.consumePunct("=");let s=this.parseExpr();return this.consumePunct(";"),{type:"LetStmt",name:e?.value??"",value:s??this.emptyLiteral(t),span:y(t,this.previous())}}parseAssertStmt(){let t=this.consumeKeyword("assert");if(!t)return null;let e=this.parseExpr(),s;return this.matchKeyword("else")&&(this.consumeKeyword("else"),s=this.consume("string")?.value),this.consumePunct(";"),{type:"AssertStmt",condition:e??this.emptyLiteral(t),message:s,span:y(t,this.previous())}}parseBindingDecl(){let t=this.consumeKeyword("binding");if(!t)return null;let e;(this.peek().type==="identifier"||this.peek().type==="string")&&(e=this.parseName());let s;if(this.matchKeyword("priority")){this.consumeKeyword("priority");let c=this.consume("int");s=c?Number(c.value):void 0,this.consumePunct(";")}let{items:a,end:n}=this.parseBlock(()=>this.parseBindingRule());return{type:"BindingDecl",name:e,priority:s,rules:a.filter(c=>c!==null),span:y(t,n)}}parseBindingRule(){let t=this.consumeKeyword("on");if(!t)return null;let e=this.parseEventSpec(),s;this.matchKeyword("target")&&(this.consumeKeyword("target"),this.matchKeyword("any")?(this.consumeKeyword("any"),s="any"):s=this.parseTargetExpr()??void 0);let a;this.matchKeyword("when")&&(this.consumeKeyword("when"),a=this.parseExpr()??void 0);let{items:n,end:c}=this.parseBlock(()=>this.parseBindingStmt());return{type:"BindingRule",event:e??this.emptyEvent(t),target:s,when:a,statements:n.filter(i=>i!==null),span:y(t,c)}}parseBindingStmt(){return this.matchKeyword("do")?this.parseDoStmt():this.matchKeyword("let")?this.parseLetStmt():this.matchKeyword("assert")?this.parseAssertStmt():null}parseEventSpec(){let t=this.consume("keyword");if(!t)return null;if(t.value==="key")return{type:"EventSpec",kind:"key",value:this.consume("string")?.value,span:y(t,this.previous())};if(t.value==="timer"){let e=this.consume("duration");return{type:"EventSpec",kind:"timer",value:e?Pe(e.value):void 0,span:y(t,this.previous())}}return t.value==="custom"?{type:"EventSpec",kind:"custom",value:this.parseName().value,span:y(t,this.previous())}:{type:"EventSpec",kind:t.value,span:y(t,t)}}parseActionCall(){let t=this.peek(),e=[],s=this.consumeNamePart();if(!s)return null;for(e.push(s.value);!this.isAtEnd();){if(this.matchPunct(".")){this.consumePunct(".");let c=this.consumeNamePart();c&&e.push(c.value);continue}let n=this.peek();if(n.type==="identifier"||n.type==="keyword"){let c=this.peekNext();if(c.type==="punct"&&c.value==="("){let l=this.consumeNamePart();l&&e.push(l.value);break}let i=this.consumeNamePart();i&&e.push(i.value);continue}break}this.consumePunct("(");let a=[];if(!this.matchPunct(")"))do{let n=this.parseActionArg();n&&a.push(n)}while(this.matchPunct(",")&&this.advance());return this.consumePunct(")"),{type:"ActionCall",name:e.join(" "),args:a,span:y(t,this.previous())}}parseActionArg(){let t=this.peek(),e=this.peek();if((e.type==="identifier"||e.type==="keyword")&&this.peekNext().type==="punct"&&this.peekNext().value===":"){let a=this.advance();this.consumePunct(":");let n=this.parseExpr();return{type:"ActionArg",key:a?.value,value:n??this.emptyLiteral(t),span:y(t,this.previous())}}return{type:"ActionArg",value:this.parseExpr()??this.emptyLiteral(t),span:y(t,this.previous())}}parseExpr(){return this.parseOrExpr()}parseOrExpr(){let t=this.parseAndExpr();for(;this.matchKeyword("or");){let e=this.consumeKeyword("or"),s=this.parseAndExpr();t={type:"BinaryExpr",operator:"or",left:t??this.emptyLiteral(e),right:s??this.emptyLiteral(e),span:y(e,this.previous())}}return t}parseAndExpr(){let t=this.parseEqExpr();for(;this.matchKeyword("and");){let e=this.consumeKeyword("and"),s=this.parseEqExpr();t={type:"BinaryExpr",operator:"and",left:t??this.emptyLiteral(e),right:s??this.emptyLiteral(e),span:y(e,this.previous())}}return t}parseEqExpr(){let t=this.parseRelExpr();for(;this.matchOperator("==")||this.matchOperator("!=");){let e=this.consume("operator"),s=this.parseRelExpr();t={type:"BinaryExpr",operator:e.value,left:t??this.emptyLiteral(e),right:s??this.emptyLiteral(e),span:y(e,this.previous())}}return t}parseRelExpr(){let t=this.parseAddExpr();for(;this.matchOperator("<")||this.matchOperator("<=")||this.matchOperator(">")||this.matchOperator(">=");){let e=this.consume("operator"),s=this.parseAddExpr();t={type:"BinaryExpr",operator:e.value,left:t??this.emptyLiteral(e),right:s??this.emptyLiteral(e),span:y(e,this.previous())}}return t}parseAddExpr(){let t=this.parseMulExpr();for(;this.matchOperator("+")||this.matchOperator("-");){let e=this.consume("operator"),s=this.parseMulExpr();t={type:"BinaryExpr",operator:e.value,left:t??this.emptyLiteral(e),right:s??this.emptyLiteral(e),span:y(e,this.previous())}}return t}parseMulExpr(){let t=this.parseUnaryExpr();for(;this.matchOperator("*")||this.matchOperator("/")||this.matchOperator("%");){let e=this.consume("operator"),s=this.parseUnaryExpr();t={type:"BinaryExpr",operator:e.value,left:t??this.emptyLiteral(e),right:s??this.emptyLiteral(e),span:y(e,this.previous())}}return t}parseUnaryExpr(){if(this.matchOperator("!")||this.matchOperator("-")){let t=this.consume("operator"),e=this.parseUnaryExpr();return{type:"UnaryExpr",operator:t.value,argument:e??this.emptyLiteral(t),span:y(t,this.previous())}}return this.parsePrimaryExpr()}parsePrimaryExpr(){let t=this.peek();if(t.type==="number"||t.type==="int"||t.type==="duration"||t.type==="percent"||t.type==="boolean"||t.type==="null"||t.type==="string"||t.type==="color")return this.advance(),this.literalFromToken(t);if(t.type==="punct"&&t.value==="{")return this.parseObjectExpr();if(t.type==="punct"&&t.value==="[")return this.parseArrayExpr();if(t.type==="punct"&&t.value==="("){let e=this.consumePunct("("),s=this.parseExpr();return this.consumePunct(")"),s?{...s,span:y(e,this.previous())}:null}return t.type==="punct"&&t.value==="$"?this.parseVarRef():this.isTargetKeyword(t)?this.parseTargetExpr():t.type==="identifier"?this.parseCallExpr():null}parseVarRef(){let t=this.consumePunct("$"),e=[],s=this.consume("identifier");for(s&&e.push(s.value);this.matchPunct(".");){this.consumePunct(".");let a=this.consume("identifier");a&&e.push(a.value)}return{type:"VarRef",path:e,span:y(t,this.previous())}}parseCallExpr(){let t=this.peek(),e=this.consume("identifier");if(!e)return null;this.consumePunct("(");let s=[];if(!this.matchPunct(")"))do{let a=this.parseActionArg();a&&s.push(a)}while(this.matchPunct(",")&&this.advance());return this.consumePunct(")"),{type:"CallExpr",name:e.value,args:s,span:y(t,this.previous())}}parseObjectExpr(){let t=this.consumePunct("{"),e=[];if(!this.matchPunct("}"))do{let s=this.peek(),a=s.type==="identifier"||s.type==="keyword"?this.advance():this.consume("string");if(!a)break;this.consumePunct(":");let n=this.parseExpr(),c=a.type==="string"?a.value.slice(1,-1):a.value;e.push({type:"ObjectEntry",key:c,value:n??this.emptyLiteral(a),span:y(a,this.previous())})}while(this.matchPunct(",")&&this.advance());return this.consumePunct("}"),{type:"ObjectExpr",entries:e,span:y(t,this.previous())}}parseArrayExpr(){let t=this.consumePunct("["),e=[];if(!this.matchPunct("]"))do{let s=this.parseExpr();s&&e.push(s)}while(this.matchPunct(",")&&this.advance());return this.consumePunct("]"),{type:"ArrayExpr",items:e,span:y(t,this.previous())}}parseTargetExpr(){let t=this.peek();if(!this.isTargetKeyword(t))return this.error(t,"target expression"),null;let e=this.consume("keyword");if(!e)return null;switch(e.value){case"node":return this.parseTargetUnary(e,"TargetNode",()=>this.parseNodeRef());case"edge":return this.parseTargetUnary(e,"TargetEdge",()=>this.parseEdgeRef());case"subgraph":return this.parseTargetUnary(e,"TargetSubgraph",()=>this.parseSubgraphRef());case"css":return this.parseTargetString(e,"TargetCss");case"id":return this.parseTargetString(e,"TargetId");case"text":return this.parseTargetString(e,"TargetText");case"group":return this.parseTargetList(e,"TargetGroup");case"union":return this.parseTargetList(e,"TargetUnion");case"intersect":return this.parseTargetList(e,"TargetIntersect");case"except":return this.parseTargetExcept(e);default:return null}}parseTargetUnary(t,e,s){this.consumePunct("(");let a=s();return this.consumePunct(")"),{type:e,ref:a,span:y(t,this.previous())}}parseTargetString(t,e){this.consumePunct("(");let s=this.consume("string");this.consumePunct(")");let a=s?.value??"";return e==="TargetCss"?{type:"TargetCss",selector:a,span:y(t,this.previous())}:e==="TargetId"?{type:"TargetId",id:a,span:y(t,this.previous())}:{type:"TargetText",text:a,span:y(t,this.previous())}}parseTargetList(t,e){this.consumePunct("(");let s=[];if(!this.matchPunct(")"))do{let n=this.parseTargetExpr();n&&s.push(n)}while(this.matchPunct(",")&&this.advance());return this.consumePunct(")"),{type:e,targets:s,span:y(t,this.previous())}}parseTargetExcept(t){this.consumePunct("(");let e=this.parseTargetExpr();this.consumePunct(",");let s=this.parseTargetExpr();return this.consumePunct(")"),{type:"TargetExcept",left:e??this.emptyTarget(t),right:s??this.emptyTarget(t),span:y(t,this.previous())}}parseNodeRef(){if(this.matchOperator("*"))return this.consume("operator"),"*";if(this.peek().type==="string"){let e=this.consume("string");return this.makeName(e)}let t=this.consume("identifier");return t?this.makeName(t):"*"}parseEdgeRef(){let t=this.peek(),e=this.parseNodeRef();if(this.matchPunct(",")){this.consumePunct(",");let s=this.parseNodeRef();return{from:e,to:s}}return e==="*"?{type:"Name",value:"*",kind:"identifier",span:y(t,this.previous())}:e}parseSubgraphRef(){if(this.matchOperator("*"))return this.consume("operator"),"*";if(this.peek().type==="string"){let e=this.consume("string");return this.makeName(e)}let t=this.consume("identifier");return t?this.makeName(t):"*"}parseQualifiedName(){let t=[],e=this.consumeNamePart();for(e&&t.push(e.value);this.matchPunct(".");){this.consumePunct(".");let s=this.consumeNamePart();s&&t.push(s.value)}return t.join(".")}consumeNamePart(){let t=this.peek();return t.type==="identifier"||t.type==="keyword"?this.advance():(this.error(t,"identifier"),null)}parseName(){let t=this.peek();if(t.type==="string")return this.advance(),{type:"Name",value:t.value,kind:"string",span:y(t,t)};let e=this.consume("identifier");return{type:"Name",value:e?.value??"",kind:"identifier",span:y(e??t,this.previous())}}parseOptionalName(){let t=this.peek();return t.type==="identifier"||t.type==="string"?this.parseName():null}parseNumber(){let t=this.consume("number")??this.consume("int");return t?Number(t.value):0}parseBoolean(){let t=this.consume("boolean");return t?t.value==="true":!1}parseVersion(){let t=this.consume("number")??this.consume("int");if(!t)return null;let e=[t.value];for(;this.matchPunct(".");){this.consumePunct(".");let s=this.consume("number")??this.consume("int");if(!s)break;e.push(s.value)}return{value:e.join("."),end:this.previous()}}parseBlock(t){let e=[],s=this.consumePunct("{");for(;!this.isAtEnd()&&!this.matchPunct("}");){let n=t();n?e.push(n):this.advance()}let a=this.consumePunct("}")??this.previous();return{items:e,end:a??s}}literalFromToken(t){let e=t.value;return t.type==="boolean"?{type:"Literal",literalType:"boolean",value:t.value==="true",raw:e,span:y(t,t)}:t.type==="null"?{type:"Literal",literalType:"null",value:null,raw:e,span:y(t,t)}:t.type==="string"?{type:"Literal",literalType:"string",value:t.value,raw:e,span:y(t,t)}:t.type==="color"?{type:"Literal",literalType:"color",value:t.value,raw:e,span:y(t,t)}:t.type==="duration"?{type:"Literal",literalType:"duration",value:Pe(t.value),raw:e,span:y(t,t)}:t.type==="percent"?{type:"Literal",literalType:"percent",value:Number(t.value.replace("%","")),raw:e,span:y(t,t)}:{type:"Literal",literalType:t.type==="int"?"int":"number",value:Number(t.value),raw:e,span:y(t,t)}}emptyLiteral(t){return{type:"Literal",literalType:"null",value:null,raw:"null",span:y(t,t)}}emptyTarget(t){return{type:"TargetNode",ref:"*",span:y(t,t)}}emptyAction(t){return{type:"ActionCall",name:"",args:[],span:y(t,t)}}emptyEvent(t){return{type:"EventSpec",kind:"click",span:y(t,t)}}makeName(t){return{type:"Name",value:t.value,kind:t.type==="string"?"string":"identifier",span:y(t,t)}}isTargetKeyword(t){return t.type==="keyword"&&["node","edge","subgraph","css","id","text","group","union","intersect","except"].includes(t.value)}matchKeyword(t){let e=this.peek();return e.type==="keyword"&&e.value===t}matchOperator(t){let e=this.peek();return e.type==="operator"&&e.value===t}matchPunct(t){let e=this.peek();return e.type==="punct"&&e.value===t}consumeKeyword(t){let e=this.peek();return e.type==="keyword"&&e.value===t?this.advance():(this.error(e,`keyword '${t}'`),null)}consumePunct(t){let e=this.peek();return e.type==="punct"&&e.value===t?this.advance():(this.error(e,`symbol '${t}'`),null)}consume(t){let e=this.peek();return e.type===t?this.advance():(this.error(e,t),null)}error(t,e){if(t.type==="eof"){this.diagnostics.push({message:`Unexpected end of input, expected ${e}.`,severity:"error",span:y(t,t),code:"parse/unexpected-eof"});return}this.diagnostics.push({message:`Unexpected '${t.image||t.value}', expected ${e}.`,severity:"error",span:y(t,t),code:"parse/unexpected-token"})}advance(){return this.isAtEnd()||(this.index+=1),this.tokens[this.index-1]}peek(){return this.tokens[this.index]}peekNext(){return this.tokens[this.index+1]}previous(){return this.tokens[Math.max(0,this.index-1)]}isAtEnd(){return this.peek().type==="eof"}};he.KEYWORD_ITEM_PARSERS={diagram:t=>t.parseDiagramDecl(),runtime:t=>t.parseRuntimeDecl(),selectors:t=>t.parseSelectorsDecl(),styles:t=>t.parseStylesDecl(),let:t=>t.parseConstDecl(),scene:t=>t.parseSceneDecl(),binding:t=>t.parseBindingDecl(),use:t=>t.parsePluginDecl(),meta:t=>t.parseMetaDecl()};var Se=he;function y(r,t){return{start:r.start,end:t.end}}function Pe(r){return r.endsWith("ms")?Number(r.replace("ms","")):r.endsWith("s")?Number(r.replace("s",""))*1e3:r.endsWith("m")?Number(r.replace("m",""))*6e4:Number(r)}function Xe(r){let t=[];r.version!==Ve&&r.version!=="1"&&t.push({message:`MPD version '${r.version}' differs from supported version ${Ve}.`,severity:"warning",span:r.span,code:"validate/version-mismatch"});for(let a of r.body){if(a.type==="SceneDecl"){let n=new Set;for(let c of a.items)if(c.type==="StepDecl"){let i=c.name.value;n.has(i)?t.push({message:`Duplicate step name '${i}' in scene '${a.name.value}'.`,severity:"error",span:c.span,code:"validate/duplicate-step"}):n.add(i)}}a.type==="UnknownBlock"&&t.push({message:`Unknown block '${a.name}'.`,severity:"warning",span:a.span,code:"validate/unknown-block"})}let e=a=>{switch(a.type){case"TargetEdge":{let n=a.ref;typeof n=="object"&&(n.from==="*"||n.to==="*")&&t.push({message:"Edge target cannot use '*' in edge tuple.",severity:"error",span:a.span,code:"validate/malformed-target"});break}case"TargetCss":case"TargetId":case"TargetText":{(a.selector??a.id??a.text??"")||t.push({message:"Target string cannot be empty.",severity:"error",span:a.span,code:"validate/malformed-target"});break}case"TargetGroup":case"TargetUnion":case"TargetIntersect":a.targets.forEach(e);break;case"TargetExcept":e(a.left),e(a.right);break;case"BinaryExpr":e(a.left),e(a.right);break;case"UnaryExpr":e(a.argument);break;case"ObjectExpr":a.entries.forEach(n=>e(n.value));break;case"ArrayExpr":a.items.forEach(e);break;case"CallExpr":a.args.forEach(n=>e(n.value));break;case"Literal":case"VarRef":case"TargetNode":case"TargetSubgraph":break;default:break}},s=a=>{if(!a||typeof a!="object")return;switch(a.type){case"StepDecl":{a.statements.forEach(s);break}case"SceneDecl":{a.items.forEach(s);break}case"FocusStmt":e(a.target);break;case"LetStmt":e(a.value);break;case"AssertStmt":e(a.condition);break;case"DoStmt":a.action.args.forEach(c=>e(c.value));break;case"BindingDecl":a.rules.forEach(s);break;case"BindingRule":{let c=a;c.when&&e(c.when),c.statements.forEach(s);break}case"ConstDecl":e(a.value);break;case"MetaDecl":a.entries.forEach(c=>e(c.value));break;default:break}};return r.body.forEach(s),t}function Qe(r){return r.length?r.map(t=>{let e=t.span?`(${t.span.start.line}:${t.span.start.column})`:"",s=t.code?` [${t.code}]`:"";return`${t.severity.toUpperCase()}: ${t.message} ${e}${s}`.trim()}).join(`
`):"No diagnostics."}var et=r=>{if(r.ast)return r.ast;if(r.mpdText&&r.options?.parseMpd)return r.options.parseMpd(r.mpdText);throw new W("presentMermaid requires ast or mpdText with parseMpd","MPF_INVALID_PRESENT_OPTIONS")},ks=async r=>{let t=et(r),s=await(r.options?.diagram??Ne()).render({mountEl:r.mountEl,mermaidText:r.mermaidText}),a=r.options?.camera??we(s),n=r.options?.overlay??De(),c=new pe({diagram:s,camera:a,overlay:n,ast:t,actionHandlers:r.options?.actionHandlers,errorPolicy:r.options?.errorPolicy??"haltOnError",hooks:r.options?.hooks});return await c.init({diagram:s}),c};export{J as ActionError,W as MPFError,fe as ParseError,we as createBasicCameraHandle,De as createBasicOverlayHandle,Ne as createMermaidDiagramAdapter,Ss as createMockCameraHandle,ys as createMockDiagramHandle,Es as createMockOverlayHandle,Qe as formatDiagnostics,Ye as parseMPD,ks as presentMermaid};
