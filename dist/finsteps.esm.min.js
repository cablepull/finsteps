var I=class{extractIdFromPatterns(t,e){for(let s of e){let n=t.match(s);if(n&&n[1])return n[1]}return null}getElementClassName(t){return typeof t.className=="string"?t.className:t.className.baseVal}hasTargetableClass(t){let e=this.getElementClassName(t);return this.getTargetableClasses().some(n=>e.includes(n))}escapeSelector(t){return typeof CSS<"u"&&typeof CSS.escape=="function"?CSS.escape(t):t.replace(/[^a-zA-Z0-9_-]/g,"\\$&")}};var F=class extends I{getDiagramType(){return"flowchart"}getTargetableClasses(){return["node"]}getTargetableTags(){return["g"]}extractNodeIds(t){let e=new Map,s=[/^[a-zA-Z0-9-]+-([A-Za-z0-9_]+)-\d+$/,/^[a-zA-Z0-9-]+-\d+-([A-Za-z0-9_]+)$/,/^node-([A-Za-z0-9_]+)$/,/^flowchart-([A-Za-z0-9_]+)-/];for(let n of Array.from(t.querySelectorAll("[id]"))){let c=n.getAttribute("id");if(!c)continue;let i=this.extractIdFromPatterns(c,s);if(i&&!e.has(i)){let a=n,l=null;for(;a&&a!==t;){if(a instanceof SVGElement&&a.tagName==="g"){let o=this.getElementClassName(a);if(o&&o.includes("node")){l=a;break}}a=a.parentElement}l?e.set(i,l):n.tagName==="g"&&this.hasTargetableClass(n)&&e.set(i,n)}}return e}getTargetSelectors(t){let e=this.escapeSelector(t);return[`g.node[data-id="${e}"]`,`g[class*="node"][data-id="${e}"]`,`[data-id="${e}"]`]}findAdjacentElements(t,e){if(!t.getAttribute("data-id"))return[];let n;try{let o=t.getBBox(),p=t.getAttribute("transform");if(p&&p.includes("translate")){let d=p.match(/translate\s*\(\s*([-\d.]+)\s*[, ]\s*([-\d.]+)\s*\)/);if(d){let u=parseFloat(d[1]),h=parseFloat(d[2]);n=new DOMRect(o.x+u,o.y+h,o.width,o.height)}else n=o}else n=o}catch{return[]}let c=n.x+n.width/2,i=n.y+n.height/2,a=Array.from(e.querySelectorAll('path.edge, path[class*="edge"], g.edge path, path[id*="edge"]')),l=new Set;for(let o of a)try{let p=o.getBBox(),d=p.x+p.width/2,u=p.y+p.height/2,h=Math.max(n.width,n.height)*1.5,w=Math.sqrt(Math.pow(d-c,2)+Math.pow(u-i,2)),D=p.x<n.x+n.width&&p.x+p.width>n.x&&p.y<n.y+n.height&&p.y+p.height>n.y,N=o.getAttribute("d"),v=!1;if(N){let m=N.match(/[ML]\s*([-\d.]+)\s+([-\d.]+)/g);if(m)for(let b of m){let S=b.match(/[ML]\s*([-\d.]+)\s+([-\d.]+)/);if(S){let E=parseFloat(S[1]),k=parseFloat(S[2]);if(Math.sqrt(Math.pow(E-c,2)+Math.pow(k-i,2))<h){v=!0;break}}}}if(D||v||w<h){let m=Array.from(e.querySelectorAll("g.node[data-id]"));for(let b of m)if(b!==t&&!l.has(b))try{let S=b.getBBox(),E=b.getAttribute("transform"),k=S;if(E&&E.includes("translate")){let V=E.match(/translate\s*\(\s*([-\d.]+)\s*[, ]\s*([-\d.]+)\s*\)/);if(V){let g=parseFloat(V[1]),y=parseFloat(V[2]);k=new DOMRect(S.x+g,S.y+y,S.width,S.height)}}let q=k.x+k.width/2,P=k.y+k.height/2,T=Math.sqrt(Math.pow(q-d,2)+Math.pow(P-u,2));(k.x<p.x+p.width&&k.x+k.width>p.x&&k.y<p.y+p.height&&k.y+k.height>p.y||T<h)&&l.add(b)}catch{continue}}}catch{continue}return Array.from(l)}};var he={linear:r=>r,ease:r=>r<.5?2*r*r:-1+(4-2*r)*r,easeIn:r=>r*r,easeOut:r=>r*(2-r),easeInOut:r=>r<.5?2*r*r:-1+(4-2*r)*r,cubicIn:r=>r*r*r,cubicOut:r=>--r*r*r+1,cubicInOut:r=>r<.5?4*r*r*r:(r-1)*(2*r-2)*(2*r-2)+1,quadIn:r=>r*r,quadOut:r=>r*(2-r),quadInOut:r=>r<.5?2*r*r:-1+(4-2*r)*r,quartIn:r=>r*r*r*r,quartOut:r=>1- --r*r*r*r,quartInOut:r=>r<.5?8*r*r*r*r:1-8*--r*r*r*r,quintIn:r=>r*r*r*r*r,quintOut:r=>1+--r*r*r*r*r,quintInOut:r=>r<.5?16*r*r*r*r*r:1+16*--r*r*r*r*r,sineIn:r=>1-Math.cos(r*Math.PI/2),sineOut:r=>Math.sin(r*Math.PI/2),sineInOut:r=>-(Math.cos(Math.PI*r)-1)/2,expoIn:r=>r===0?0:Math.pow(2,10*(r-1)),expoOut:r=>r===1?1:1-Math.pow(2,-10*r),expoInOut:r=>r===0?0:r===1?1:r<.5?Math.pow(2,20*r-10)/2:(2-Math.pow(2,-20*r+10))/2,circIn:r=>1-Math.sqrt(1-r*r),circOut:r=>Math.sqrt(1- --r*r),circInOut:r=>r<.5?(1-Math.sqrt(1-4*r*r))/2:(Math.sqrt(1-4*(r-1)*(r-1))+1)/2,backIn:r=>2.70158*r*r*r-1.70158*r*r,backOut:r=>1+2.70158*Math.pow(r-1,3)+1.70158*Math.pow(r-1,2),backInOut:r=>{let e=2.5949095;return r<.5?Math.pow(2*r,2)*((e+1)*2*r-e)/2:(Math.pow(2*r-2,2)*((e+1)*(r*2-2)+e)+2)/2}};function Ve(r){return he[r]||he.easeOut}var ge=r=>{let t=r.viewBox?.baseVal;return t&&t.width&&t.height?`${t.x} ${t.y} ${t.width} ${t.height}`:r.getAttribute("viewBox")};function Te(r,t,e){return e.findAdjacentElements(r,t)}var de=(r,t=40)=>{let e=r.getAttribute("data-initial-viewbox");if(e)return e;let s=null;for(let m of Array.from(r.children))if(m instanceof SVGGElement){s=m;break}let n=1/0,c=1/0,i=-1/0,a=-1/0;if(s)try{let m=s.getBBox();n=m.x,c=m.y,i=m.x+m.width,a=m.y+m.height}catch{}let l=i-n,o=a-c,p=ge(r),d={width:0,height:0};if(p){let m=p.split(" ").map(Number);m.length===4&&(d={width:m[2],height:m[3]})}let u={width:0,height:0};if(e){let m=e.split(" ").map(Number);m.length===4&&(u={width:m[2],height:m[3]})}if(!isFinite(n)||!isFinite(c)||!isFinite(i)||!isFinite(a)||l<10||o<10||d.width>0&&l<d.width*.1||u.width>0&&l<u.width*.5){let m=[];for(let b of Array.from(r.children))b instanceof SVGGraphicsElement&&m.push(b);m.length===0&&m.push(...Array.from(r.querySelectorAll("g, rect, circle, ellipse, line, polyline, polygon, path, text"))),n=1/0,c=1/0,i=-1/0,a=-1/0;for(let b of m)try{let S=b.getBBox();isFinite(S.x)&&isFinite(S.y)&&isFinite(S.width)&&isFinite(S.height)&&S.width>0&&S.height>0&&(n=Math.min(n,S.x),c=Math.min(c,S.y),i=Math.max(i,S.x+S.width),a=Math.max(a,S.y+S.height))}catch{continue}}let w=i-n,D=a-c,N=u.width>0&&w<u.width*.7;if(!isFinite(n)||!isFinite(c)||!isFinite(i)||!isFinite(a)||w<10||D<10||d.width>0&&w<d.width*.1||N){if(e&&u.width>0&&u.height>0)return e;if(p)return p;let m=r.getAttribute("width"),b=r.getAttribute("height");if(m&&b){let S=parseFloat(m)||1e3,E=parseFloat(b)||1e3;return`0 0 ${S} ${E}`}return null}let v={x:n-t,y:c-t,width:w+t*2,height:D+t*2};return`${v.x} ${v.y} ${v.width} ${v.height}`};function Ie(r){if(!r)return null;let t=r.split(" ").map(Number);return t.length!==4||t.some(isNaN)?null:{x:t[0],y:t[1],width:t[2],height:t[3]}}function Ce(r,t,e,s,n){return new Promise(c=>{if(!t){r.setAttribute("viewBox",`${e.x} ${e.y} ${e.width} ${e.height}`),c();return}let i=performance.now(),a=l=>{let o=l-i,p=Math.min(o/s,1),d=n(p),u={x:t.x+(e.x-t.x)*d,y:t.y+(e.y-t.y)*d,width:t.width+(e.width-t.width)*d,height:t.height+(e.height-t.height)*d};r.setAttribute("viewBox",`${u.x} ${u.y} ${u.width} ${u.height}`),p<1?requestAnimationFrame(a):(r.setAttribute("viewBox",`${e.x} ${e.y} ${e.width} ${e.height}`),c())};requestAnimationFrame(a)})}var fe=r=>{let t=r.getRoot(),e=r.getContainer(),s=ge(t),n=!1,c=0,i=0,a=(u,h)=>{let w=t.viewBox?.baseVal;if(!w||!w.width||!w.height)return;let D={x:w.x,y:w.y,width:w.width,height:w.height},N=t.clientWidth||w.width,v=t.clientHeight||w.height,m=D.width/N,b=D.height/v,S=D.x-u*m,E=D.y-h*b;t.setAttribute("viewBox",`${S} ${E} ${D.width} ${D.height}`)},l=u=>{u.button===0&&(u.target?.closest("button")||u.target?.closest(".nav-btn")||u.target?.closest(".dataid-chip")||u.target?.closest("a")||(n=!0,c=u.clientX,i=u.clientY,e.style.cursor="grabbing",e.style.userSelect="none",u.preventDefault()))},o=u=>{if(!n)return;let h=u.clientX-c,w=u.clientY-i;a(h,w),c=u.clientX,i=u.clientY,u.preventDefault()},p=()=>{n&&(n=!1,e.style.cursor="grab",e.style.userSelect="")},d=()=>{n&&(n=!1,e.style.cursor="grab",e.style.userSelect="")};return e.style.cursor="grab",e.addEventListener("mousedown",l),document.addEventListener("mousemove",o),document.addEventListener("mouseup",p),e.addEventListener("mouseleave",d),{fit(u,h){if(u instanceof SVGGraphicsElement)try{let w=u.getBBox(),D=u instanceof SVGElement?u.getAttribute("transform"):null,N=w;if(D&&D.includes("translate"))try{let g=D.match(/translate\s*\(\s*([-\d.]+)\s*[, ]\s*([-\d.]+)\s*\)/);if(g){let y=parseFloat(g[1]),A=parseFloat(g[2]);N=new DOMRect(w.x+y,w.y+A,w.width,w.height)}}catch{}let v=h?.padding??16,m=40;N.height<m&&(N=new DOMRect(N.x,N.y-m/2,N.width||m,m)),N.width<m&&(N=new DOMRect(N.x-m/2,N.y,m,N.height||m));let b=r.getStrategy?.()||new F,S=Te(u,t,b),E=N;for(let g of S)try{let y=g.getBBox(),A=g.getAttribute("transform"),G=y;if(A&&A.includes("translate")){let O=A.match(/translate\s*\(\s*([-\d.]+)\s*[, ]\s*([-\d.]+)\s*\)/);if(O){let W=parseFloat(O[1]),ke=parseFloat(O[2]);G=new DOMRect(y.x+W,y.y+ke,y.width,y.height)}}let C=Math.min(E.x,G.x),B=Math.min(E.y,G.y),$=Math.max(E.x+E.width,G.x+G.width),R=Math.max(E.y+E.height,G.y+G.height);E=new DOMRect(C,B,$-C,R-B)}catch{continue}if(N=E,!isFinite(N.width)||!isFinite(N.height)||N.width<=0||N.height<=0){let g=u.parentElement;if(g instanceof SVGGraphicsElement){let y=g.getBBox();if(isFinite(y.width)&&isFinite(y.height)&&y.width>0&&y.height>0){let A={x:y.x-v,y:y.y-v,width:y.width+v*2,height:y.height+v*2};t.setAttribute("viewBox",`${A.x} ${A.y} ${A.width} ${A.height}`);return}}return}let k=null;try{let g=Array.from(t.children).find(y=>y instanceof SVGGElement);g&&(k=g.getBBox())}catch{}if(k&&(N.x<k.x||N.y<k.y||N.x+N.width>k.x+k.width||N.y+N.height>k.y+k.height)){let g=Math.min(E.x,k.x),y=Math.min(E.y,k.y),A=Math.max(E.x+E.width,k.x+k.width),G=Math.max(E.y+E.height,k.y+k.height);E=new DOMRect(g,y,A-g,G-y)}let q=E,P={x:q.x-v,y:q.y-v,width:q.width+v*2,height:q.height+v*2},T=`${P.x} ${P.y} ${P.width} ${P.height}`,x=h?.duration??0,V=h?.easing??"easeOut";if(x<=0)t.setAttribute("viewBox",T);else{let g=Ie(t.getAttribute("viewBox")),y=P,A=Ve(V);return Ce(t,g,y,x,A)}}catch(w){console.warn("Failed to get bounding box for camera.fit:",w)}},reset(){let u=de(t);u?t.setAttribute("viewBox",u):s&&t.setAttribute("viewBox",s)},zoom(u,h){let w=t.viewBox?.baseVal;if(!w||!w.width||!w.height)return;let D={x:w.x,y:w.y,width:w.width,height:w.height},N=h??{x:D.x+D.width/2,y:D.y+D.height/2},v=D.width/u,m=D.height/u,b=N.x-v/2,S=N.y-m/2;t.setAttribute("viewBox",`${b} ${S} ${v} ${m}`)},pan(u,h){let w=t.viewBox?.baseVal;if(!w||!w.width||!w.height)return;let D={x:w.x,y:w.y,width:w.width,height:w.height},N=t.clientWidth||w.width,v=t.clientHeight||w.height,m=D.width/N,b=D.height/v,S=D.x+u*m,E=D.y+h*b;t.setAttribute("viewBox",`${S} ${E} ${D.width} ${D.height}`)},fitAll(u=40){let h=de(t,u);h&&t.setAttribute("viewBox",h)},destroy(){e.removeEventListener("mousedown",l),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",p),e.removeEventListener("mouseleave",d),e.style.cursor="",e.style.userSelect="";let u=de(t);u?t.setAttribute("viewBox",u):s&&t.setAttribute("viewBox",s)}}};var ye=()=>{let r=document.createElement("div");r.className="finsteps-overlay",r.style.position="fixed",r.style.top="0",r.style.left="0",r.style.width="0",r.style.height="0",r.style.pointerEvents="none",document.body.appendChild(r);let t=new Map,e=()=>{for(let c of t.values()){let i=c.target.getBoundingClientRect(),a=c.element.getBoundingClientRect(),l=Math.max(8,i.top-a.height-8),o=Math.max(8,i.left+i.width/2-a.width/2);c.element.style.top=`${l}px`,c.element.style.left=`${o}px`}},s=()=>e(),n=()=>e();return window.addEventListener("scroll",s,!0),window.addEventListener("resize",n),{showBubble({id:c="default",target:i,text:a}){let l=t.get(c);if(!l){let o=document.createElement("div");o.className="finsteps-bubble",o.style.position="fixed",o.style.padding="8px 12px",o.style.borderRadius="8px",o.style.background="rgba(15, 23, 42, 0.95)",o.style.color="#fff",o.style.font="14px/1.4 sans-serif",o.style.maxWidth="240px",o.style.pointerEvents="none",r.appendChild(o),l={id:c,element:o,target:i},t.set(c,l)}l.target=i,l.element.textContent=a,requestAnimationFrame(e)},hideBubble(c="default"){let i=t.get(c);i&&(i.element.remove(),t.delete(c))},destroy(){window.removeEventListener("scroll",s,!0),window.removeEventListener("resize",n);for(let c of t.values())c.element.remove();t.clear(),r.remove()}}};var z=class extends Error{constructor(t,e){super(t),this.name="MPFError",this.code=e}},ue=class extends z{constructor(t,e="MPF_PARSE_ERROR"){super(t,e),this.name="ParseError"}},K=class extends z{constructor(t,e="MPF_ACTION_INVALID_ARGS"){super(t,e),this.name="ActionError"}};var Ee=r=>typeof CSS<"u"&&typeof CSS.escape=="function"?CSS.escape(r):r.replace(/[^a-zA-Z0-9_-]/g,"\\$&"),L=(r,t)=>{if(!t)return null;if(t.element)return t.element;let e=r.getRoot(),s=null;if(t.selector)s=e.querySelector(t.selector),!s&&typeof document<"u"&&(s=document.querySelector(t.selector));else if(t.id)s=e.querySelector(`#${Ee(t.id)}`);else if(t.dataId){let c=(r.getStrategy?.()||new F).getTargetSelectors(t.dataId);for(let i of c)if(s=e.querySelector(i),s)break;!s&&e instanceof Element&&e.getAttribute("data-id")===t.dataId&&(s=e)}if(!s)return null;if(!(s instanceof SVGGraphicsElement)||s.tagName==="text"||s instanceof SVGElement&&(typeof s.className=="string"&&s.className.includes("flowchart-label")||typeof s.className!="string"&&s.className.baseVal.includes("flowchart-label"))){let n=s;for(;n;){let c=n.parentElement;if(!c||c===e)break;if(c instanceof SVGGraphicsElement){if(c.tagName==="g"){if((c instanceof SVGElement?typeof c.className=="string"?c.className:c.className.baseVal:"").includes("node")&&c!==e&&c.getAttribute("data-id")===t?.dataId)return c;let a=c.parentElement;if(a===e||a&&a.tagName==="svg"){n=c;continue}}if(c===e)break}n=c}if(n instanceof SVGGraphicsElement&&n!==e){let c=n.parentElement;if(c&&c.tagName!=="svg")return n}}if(s instanceof SVGGraphicsElement&&s.tagName!=="g"){let n=s.parentElement;if(n instanceof SVGGraphicsElement&&n.tagName==="g"&&(n instanceof SVGElement?typeof n.className=="string"?n.className:n.className.baseVal:"").includes("node")&&n.getAttribute("data-id")===t?.dataId)return n}if(s instanceof SVGGraphicsElement&&s.tagName==="g"){let n=s.parentElement;if(n===e||n&&n.tagName==="svg"){let c=s.getAttribute("data-id"),i=s instanceof SVGElement?typeof s.className=="string"?s.className:s.className.baseVal:"";if(c!==t?.dataId||!i.includes("node")){let a=t?.dataId?Ee(t.dataId):"",l=e.querySelector(`g.node[data-id="${a}"]`);if(l instanceof SVGGraphicsElement)return l}}}return s};function Se(r){let t=r.trim(),e=t.split(`
`)[0].trim().toLowerCase();return e.startsWith("flowchart")?"flowchart":e.startsWith("sequenceDiagram")||e.startsWith("sequencediagram")?"sequenceDiagram":e.startsWith("classDiagram")||e.startsWith("classdiagram")?"classDiagram":e.startsWith("stateDiagram-v2")||e.startsWith("statediagram-v2")?"stateDiagram-v2":e.startsWith("stateDiagram")||e.startsWith("statediagram")?"stateDiagram":e.startsWith("erDiagram")||e.startsWith("erdiagram")?"erDiagram":e.startsWith("gantt")?"gantt":e.startsWith("pie")?"pie":e.startsWith("journey")?"journey":e.startsWith("gitGraph")||e.startsWith("gitgraph")?"gitGraph":e.startsWith("timeline")?"timeline":e.startsWith("quadrantChart")||e.startsWith("quadrantchart")?"quadrantChart":e.startsWith("requirement")?"requirement":e.startsWith("C4Context")||e.startsWith("c4context")?"c4Context":e.startsWith("C4Container")||e.startsWith("c4container")?"c4Container":e.startsWith("C4Component")||e.startsWith("c4component")?"c4Component":e.startsWith("block-beta")||e.startsWith("blockBeta")||e.startsWith("blockbeta")||e.startsWith("blockDiagram")||e.startsWith("blockdiagram")?"block":t.includes("graph")||t.includes("-->")||t.includes("---")?"flowchart":"unknown"}var me=class{constructor(){this.strategies=new Map;this.defaultStrategy=null}register(t,e){this.strategies.set(t,e)}get(t){return this.strategies.get(t)}getOrDefault(t){let e=this.strategies.get(t);if(e)return e;if(this.defaultStrategy)return this.defaultStrategy;throw new Error(`No strategy found for diagram type: ${t} and no default strategy set`)}setDefault(t){this.defaultStrategy=t}has(t){return this.strategies.has(t)}getRegisteredTypes(){return Array.from(this.strategies.keys())}},M=new me;var U=class extends I{getDiagramType(){return"gantt"}getTargetableClasses(){return["task","milestone","section"]}getTargetableTags(){return["g","rect","polygon"]}extractNodeIds(t){let e=new Map,s=[/^[a-zA-Z0-9-]+-([A-Za-z0-9_]+)-\d+$/,/^gantt-([A-Za-z0-9_]+)-/,/^task-([A-Za-z0-9_]+)/,/^([A-Za-z0-9_]+)$/];for(let n of Array.from(t.querySelectorAll("[id]"))){let c=n.getAttribute("id");if(!c)continue;let i=this.extractIdFromPatterns(c,s);if(!i){let a=this.getElementClassName(n);a&&(a.includes("task")||a.includes("milestone"))&&!c.endsWith("-text")&&!c.endsWith("-Text")&&(i=c)}if(i&&!e.has(i)){let a=n,l=null;for(;a&&a!==t;){if(a instanceof SVGElement&&a.tagName==="g"){let o=this.getElementClassName(a);if(o&&(o.includes("task")||o.includes("milestone")||o.includes("section"))){l=a;break}}a=a.parentElement}if(l)e.set(i,l);else if(n.tagName==="g"&&this.hasTargetableClass(n))e.set(i,n);else if(n.tagName==="rect"){let o=this.getElementClassName(n);o&&(o.includes("task")||o.includes("milestone"))&&e.set(i,n)}else if(n.tagName==="polygon"){let o=this.getElementClassName(n);o&&o.includes("milestone")&&e.set(i,n)}}}return e}getTargetSelectors(t){let e=this.escapeSelector(t);return[`g.task[data-id="${e}"]`,`g.milestone[data-id="${e}"]`,`g[class*="task"][data-id="${e}"]`,`g[class*="milestone"][data-id="${e}"]`,`g[class*="section"][data-id="${e}"]`,`rect.task[data-id="${e}"]`,`rect[class*="task"][data-id="${e}"]`,`polygon.milestone[data-id="${e}"]`,`polygon[class*="milestone"][data-id="${e}"]`,`[data-id="${e}"]`]}findAdjacentElements(t,e){if(!t.getAttribute("data-id"))return[];let n=this.getElementClassName(t);if(n&&n.includes("milestone"))return Array.from(e.querySelectorAll("[data-id]")).filter(p=>p!==t&&p instanceof SVGGraphicsElement);let i=null,a=t;for(;a&&a!==e;){if(a.tagName==="g"&&a instanceof SVGElement){let o=a,p=this.getElementClassName(o);if(p&&p.includes("section")){i=o;break}}a=a.parentElement}return i?Array.from(i.querySelectorAll('[data-id], g[class*="task"][data-id], polygon[class*="milestone"][data-id]')).filter(o=>o!==t):Array.from(e.querySelectorAll('[data-id], g[class*="task"][data-id], polygon[class*="milestone"][data-id]')).filter(p=>p!==t)}};var Y=class extends I{getDiagramType(){return"sequenceDiagram"}getTargetableClasses(){return["participant","message","activation","note"]}getTargetableTags(){return["g","rect","text"]}extractNodeIds(t){let e=new Map,s=[/^participant-([A-Za-z0-9_]+)-\d+$/,/^actor-([A-Za-z0-9_]+)-\d+$/,/^message-([A-Za-z0-9_]+)-\d+$/,/^activation-([A-Za-z0-9_]+)-\d+$/,/^note-([A-Za-z0-9_]+)-\d+$/,/^([A-Za-z0-9_]+)-\d+$/];for(let n of Array.from(t.querySelectorAll("[id]"))){let c=n.getAttribute("id");if(!c)continue;let i=this.extractIdFromPatterns(c,s);if(i&&!e.has(i)){let a=n,l=null;for(;a&&a!==t;){if(a instanceof SVGElement&&a.tagName==="g"){let o=this.getElementClassName(a);if(o&&(o.includes("participant")||o.includes("actor")||o.includes("message")||o.includes("activation")||o.includes("note"))){l=a;break}}a=a.parentElement}l?e.set(i,l):n.tagName==="g"&&this.hasTargetableClass(n)&&e.set(i,n)}}return e}getTargetSelectors(t){let e=this.escapeSelector(t);return[`g.participant[data-id="${e}"]`,`g.actor[data-id="${e}"]`,`g.message[data-id="${e}"]`,`g.activation[data-id="${e}"]`,`g.note[data-id="${e}"]`,`line[data-id="${e}"]`,`text[data-id="${e}"]`,`g[class*="participant"][data-id="${e}"]`,`g[class*="actor"][data-id="${e}"]`,`g[class*="message"][data-id="${e}"]`,`g[class*="activation"][data-id="${e}"]`,`g[class*="note"][data-id="${e}"]`,`[data-id="${e}"]`]}findAdjacentElements(t,e){if(!t.getAttribute("data-id"))return[];let n=this.getElementClassName(t);if(n&&(n.includes("participant")||n.includes("actor"))){let c=Array.from(e.querySelectorAll('g[class*="message"][data-id]')),i=[];for(let a of c)try{let l=t.getBBox(),o=a.getBBox();o.x<l.x+l.width&&o.x+o.width>l.x&&o.y<l.y+l.height&&o.y+o.height>l.y&&i.push(a)}catch{continue}return i}if(n&&n.includes("message")){let c=Array.from(e.querySelectorAll('g[class*="participant"][data-id], g[class*="actor"][data-id]')),i=[];try{let a=t.getBBox();for(let l of c)try{let o=l.getBBox();a.x<o.x+o.width&&a.x+a.width>o.x&&a.y<o.y+o.height&&a.y+a.height>o.y&&i.push(l)}catch{continue}}catch{return[]}return i}if(n&&n.includes("activation")){let c=t.parentElement;for(;c&&c!==e;){if(c instanceof SVGGraphicsElement){let i=this.getElementClassName(c);if(i&&(i.includes("participant")||i.includes("actor")))return[c]}c=c.parentElement}}return[]}};var X=class extends I{getDiagramType(){return"classDiagram"}getTargetableClasses(){return["class","classBox","relation","edge"]}getTargetableTags(){return["g","rect","path"]}extractNodeIds(t){let e=new Map,s=[/^class-([A-Za-z0-9_]+)-\d+$/,/^classBox-([A-Za-z0-9_]+)-\d+$/,/^relation-([A-Za-z0-9_]+)-\d+$/,/^edge-([A-Za-z0-9_]+)-\d+$/,/^([A-Za-z0-9_]+)-\d+$/];for(let n of Array.from(t.querySelectorAll("[id]"))){let c=n.getAttribute("id");if(!c)continue;let i=this.extractIdFromPatterns(c,s);if(i&&!e.has(i)){let a=n,l=null;for(;a&&a!==t;){if(a instanceof SVGElement&&a.tagName==="g"){let o=this.getElementClassName(a);if(o&&(o.includes("class")||o.includes("classBox")||o.includes("relation")||o.includes("edge"))){l=a;break}}a=a.parentElement}l?e.set(i,l):n.tagName==="g"&&this.hasTargetableClass(n)&&e.set(i,n)}}return e}getTargetSelectors(t){let e=this.escapeSelector(t);return[`g.class[data-id="${e}"]`,`g.classBox[data-id="${e}"]`,`g.relation[data-id="${e}"]`,`g.edge[data-id="${e}"]`,`g[class*="class"][data-id="${e}"]`,`g[class*="relation"][data-id="${e}"]`,`g[class*="edge"][data-id="${e}"]`,`[data-id="${e}"]`]}findAdjacentElements(t,e){if(!t.getAttribute("data-id"))return[];let n=this.getElementClassName(t);if(n&&(n.includes("class")||n.includes("classBox"))){let c=Array.from(e.querySelectorAll('g[class*="relation"][data-id], g[class*="edge"][data-id], path[class*="edge"]')),i=[];try{let a=t.getBBox();for(let l of c)try{let o=l.getBBox();if(o.x<a.x+a.width&&o.x+o.width>a.x&&o.y<a.y+a.height&&o.y+o.height>a.y){let d=Array.from(e.querySelectorAll('g[class*="class"][data-id], g[class*="classBox"][data-id]'));for(let u of d)if(u!==t&&!i.includes(u))try{let h=u.getBBox();o.x<h.x+h.width&&o.x+o.width>h.x&&o.y<h.y+h.height&&o.y+o.height>h.y&&i.push(u)}catch{continue}}}catch{continue}}catch{return[]}return i}if(n&&(n.includes("relation")||n.includes("edge"))){let c=Array.from(e.querySelectorAll('g[class*="class"][data-id], g[class*="classBox"][data-id]')),i=[];try{let a=t.getBBox();for(let l of c)try{let o=l.getBBox();a.x<o.x+o.width&&a.x+a.width>o.x&&a.y<o.y+o.height&&a.y+a.height>o.y&&i.push(l)}catch{continue}}catch{return[]}return i}return[]}};var H=class extends I{getDiagramType(){return"stateDiagram"}getTargetableClasses(){return["state","stateNode","transition","edge"]}getTargetableTags(){return["g","rect","ellipse","path"]}extractNodeIds(t){let e=new Map,s=[/^stateDiagram-([A-Za-z0-9_]+)-\d+$/,/^state-([A-Za-z0-9_]+)-\d+$/,/^stateNode-([A-Za-z0-9_]+)-\d+$/,/^node-([A-Za-z0-9_]+)-\d+$/,/^stateDiagram-([A-Za-z0-9_]+)$/,/^state-([A-Za-z0-9_]+)$/,/^([A-Za-z0-9_]+)-\d+$/,/^([A-Za-z0-9_]+)$/],n=t.querySelectorAll('g[class*="state"], g[class*="node"]');for(let i=0;i<n.length;i++){let a=n[i];if(!this.getElementClassName(a))continue;let o=a.querySelectorAll("text");for(let p=0;p<o.length;p++){let d=o[p],u=d.textContent?.trim();if(u&&/^[A-Za-z][A-Za-z0-9_]*$/.test(u)){let h=a;d.parentElement&&d.parentElement instanceof SVGElement&&(h=d.parentElement);let w=this.getElementClassName(h);w&&!w.includes("edgeLabel")&&!w.includes("label")&&(e.has(u)||e.set(u,a))}}}let c=[];for(let i of Array.from(t.querySelectorAll("[id]"))){let a=i.getAttribute("id");if(!a)continue;c.push(a);let l=this.extractIdFromPatterns(a,s);if(l&&!e.has(l)){let o=i,p=null;for(;o&&o!==t;){if(o instanceof SVGElement&&o.tagName==="g"){let d=this.getElementClassName(o);if(d&&(d.includes("state")||d.includes("node")||d.includes("transition")||d.includes("edge"))){p=o;break}}o=o.parentElement}p?e.set(l,p):i.tagName==="g"&&this.hasTargetableClass(i)&&e.set(l,i)}}return e}getTargetSelectors(t){let e=this.escapeSelector(t);return[`g.state[data-id="${e}"]`,`g.stateNode[data-id="${e}"]`,`g.node[data-id="${e}"]`,`g.transition[data-id="${e}"]`,`g.edge[data-id="${e}"]`,`g[class*="state"][data-id="${e}"]`,`g[class*="node"][data-id="${e}"]`,`g[class*="transition"][data-id="${e}"]`,`g[class*="edge"][data-id="${e}"]`,`[data-id="${e}"]`]}findAdjacentElements(t,e){if(!t.getAttribute("data-id"))return[];let n=this.getElementClassName(t);if(n&&(n.includes("state")||n.includes("stateNode"))){let c=Array.from(e.querySelectorAll('g[class*="transition"][data-id], g[class*="edge"][data-id], path[class*="edge"]')),i=[];try{let a=t.getBBox();for(let l of c)try{let o=l.getBBox();if(o.x<a.x+a.width&&o.x+o.width>a.x&&o.y<a.y+a.height&&o.y+o.height>a.y){let d=Array.from(e.querySelectorAll('g[class*="state"][data-id], g[class*="stateNode"][data-id]'));for(let u of d)if(u!==t&&!i.includes(u))try{let h=u.getBBox();o.x<h.x+h.width&&o.x+o.width>h.x&&o.y<h.y+h.height&&o.y+o.height>h.y&&i.push(u)}catch{continue}}}catch{continue}}catch{return[]}return i}if(n&&(n.includes("transition")||n.includes("edge"))){let c=Array.from(e.querySelectorAll('g[class*="state"][data-id], g[class*="stateNode"][data-id]')),i=[];try{let a=t.getBBox();for(let l of c)try{let o=l.getBBox();a.x<o.x+o.width&&a.x+a.width>o.x&&a.y<o.y+o.height&&a.y+a.height>o.y&&i.push(l)}catch{continue}}catch{return[]}return i}return[]}};var Q=class extends I{getDiagramType(){return"erDiagram"}getTargetableClasses(){return["entity","relationship","attribute","edge"]}getTargetableTags(){return["g","rect","path"]}extractNodeIds(t){let e=new Map,s=[/^entity-([A-Za-z0-9_]+)-\d+$/,/^relationship-([A-Za-z0-9_]+)-\d+$/,/^attribute-([A-Za-z0-9_]+)-\d+$/,/^edge-([A-Za-z0-9_]+)-\d+$/,/^([A-Za-z0-9_]+)-\d+$/];for(let n of Array.from(t.querySelectorAll("[id]"))){let c=n.getAttribute("id");if(!c)continue;let i=this.extractIdFromPatterns(c,s);if(i&&!e.has(i)){let a=n,l=null;for(;a&&a!==t;){if(a instanceof SVGElement&&a.tagName==="g"){let o=this.getElementClassName(a);if(o&&(o.includes("entity")||o.includes("relationship")||o.includes("attribute")||o.includes("edge"))){l=a;break}}a=a.parentElement}l?e.set(i,l):n.tagName==="g"&&this.hasTargetableClass(n)&&e.set(i,n)}}return e}getTargetSelectors(t){let e=this.escapeSelector(t);return[`g.entity[data-id="${e}"]`,`g.relationship[data-id="${e}"]`,`g.attribute[data-id="${e}"]`,`g.edge[data-id="${e}"]`,`g[class*="entity"][data-id="${e}"]`,`g[class*="relationship"][data-id="${e}"]`,`g[class*="attribute"][data-id="${e}"]`,`g[class*="edge"][data-id="${e}"]`,`[data-id="${e}"]`]}findAdjacentElements(t,e){if(!t.getAttribute("data-id"))return[];let n=this.getElementClassName(t);if(n&&n.includes("entity")){let c=Array.from(e.querySelectorAll('g[class*="relationship"][data-id], g[class*="edge"][data-id], path[class*="edge"]')),i=[];try{let a=t.getBBox();for(let l of c)try{let o=l.getBBox();if(o.x<a.x+a.width&&o.x+o.width>a.x&&o.y<a.y+a.height&&o.y+o.height>a.y){let d=Array.from(e.querySelectorAll('g[class*="entity"][data-id]'));for(let u of d)if(u!==t&&!i.includes(u))try{let h=u.getBBox();o.x<h.x+h.width&&o.x+o.width>h.x&&o.y<h.y+h.height&&o.y+o.height>h.y&&i.push(u)}catch{continue}}}catch{continue}}catch{return[]}return i}if(n&&(n.includes("relationship")||n.includes("edge"))){let c=Array.from(e.querySelectorAll('g[class*="entity"][data-id]')),i=[];try{let a=t.getBBox();for(let l of c)try{let o=l.getBBox();a.x<o.x+o.width&&a.x+a.width>o.x&&a.y<o.y+o.height&&a.y+a.height>o.y&&i.push(l)}catch{continue}}catch{return[]}return i}return[]}};var J=class extends I{getDiagramType(){return"pie"}getTargetableClasses(){return["slice","pie"]}getTargetableTags(){return["g","path","text"]}extractNodeIds(t){let e=new Map,s=[/^slice-([A-Za-z0-9_]+)-\d+$/,/^pie-([A-Za-z0-9_]+)-\d+$/,/^([A-Za-z0-9_]+)-\d+$/];for(let n of Array.from(t.querySelectorAll("[id]"))){let c=n.getAttribute("id");if(!c)continue;let i=this.extractIdFromPatterns(c,s);if(i&&!e.has(i)){let a=n,l=null;for(;a&&a!==t;){if(a instanceof SVGElement&&a.tagName==="g"){let o=this.getElementClassName(a);if(o&&(o.includes("slice")||o.includes("pie"))){l=a;break}}a=a.parentElement}l?e.set(i,l):(n.tagName==="g"&&this.hasTargetableClass(n)||n.tagName==="path"&&this.hasTargetableClass(n))&&e.set(i,n)}}return e}getTargetSelectors(t){let e=this.escapeSelector(t);return[`g.slice[data-id="${e}"]`,`g.pie[data-id="${e}"]`,`path.slice[data-id="${e}"]`,`path.pie[data-id="${e}"]`,`g[class*="slice"][data-id="${e}"]`,`g[class*="pie"][data-id="${e}"]`,`path[class*="slice"][data-id="${e}"]`,`path[class*="pie"][data-id="${e}"]`,`[data-id="${e}"]`]}findAdjacentElements(t,e){return[]}};var ee=class extends I{getDiagramType(){return"journey"}getTargetableClasses(){return["step","task","section"]}getTargetableTags(){return["g","rect","text"]}extractNodeIds(t){let e=new Map,s=[/^step-([A-Za-z0-9_]+)-\d+$/,/^task-([A-Za-z0-9_]+)-\d+$/,/^section-([A-Za-z0-9_]+)-\d+$/,/^([A-Za-z0-9_]+)-\d+$/];for(let n of Array.from(t.querySelectorAll("[id]"))){let c=n.getAttribute("id");if(!c)continue;let i=this.extractIdFromPatterns(c,s);if(i&&!e.has(i)){let a=n,l=null;for(;a&&a!==t;){if(a instanceof SVGElement&&a.tagName==="g"){let o=this.getElementClassName(a);if(o&&(o.includes("step")||o.includes("task")||o.includes("section"))){l=a;break}}a=a.parentElement}l?e.set(i,l):n.tagName==="g"&&this.hasTargetableClass(n)&&e.set(i,n)}}return e}getTargetSelectors(t){let e=this.escapeSelector(t);return[`g.step[data-id="${e}"]`,`g.task[data-id="${e}"]`,`g.section[data-id="${e}"]`,`g[class*="step"][data-id="${e}"]`,`g[class*="task"][data-id="${e}"]`,`g[class*="section"][data-id="${e}"]`,`[data-id="${e}"]`]}findAdjacentElements(t,e){if(!t.getAttribute("data-id"))return[];let n=Array.from(e.querySelectorAll('g[class*="step"][data-id], g[class*="task"][data-id]')),c=n.indexOf(t);if(c===-1)return[];let i=[];return c>0&&i.push(n[c-1]),c<n.length-1&&i.push(n[c+1]),i}};var te=class extends I{getDiagramType(){return"gitGraph"}getTargetableClasses(){return["commit","branch","merge"]}getTargetableTags(){return["g","circle","path","text"]}extractNodeIds(t){let e=new Map,s=[/^commit-([A-Za-z0-9_]+)-\d+$/,/^branch-([A-Za-z0-9_]+)-\d+$/,/^merge-([A-Za-z0-9_]+)-\d+$/,/^([A-Za-z0-9_]+)-\d+$/];for(let n of Array.from(t.querySelectorAll("[id]"))){let c=n.getAttribute("id");if(!c)continue;let i=this.extractIdFromPatterns(c,s);if(i&&!e.has(i)){let a=n,l=null;for(;a&&a!==t;){if(a instanceof SVGElement&&a.tagName==="g"){let o=this.getElementClassName(a);if(o&&(o.includes("commit")||o.includes("branch")||o.includes("merge"))){l=a;break}}a=a.parentElement}l?e.set(i,l):(n.tagName==="g"&&this.hasTargetableClass(n)||n.tagName==="circle"&&this.hasTargetableClass(n))&&e.set(i,n)}}return e}getTargetSelectors(t){let e=this.escapeSelector(t);return[`g.commit[data-id="${e}"]`,`g.branch[data-id="${e}"]`,`g.merge[data-id="${e}"]`,`circle.commit[data-id="${e}"]`,`circle.branch[data-id="${e}"]`,`g[class*="commit"][data-id="${e}"]`,`g[class*="branch"][data-id="${e}"]`,`g[class*="merge"][data-id="${e}"]`,`circle[class*="commit"][data-id="${e}"]`,`circle[class*="branch"][data-id="${e}"]`,`[data-id="${e}"]`]}findAdjacentElements(t,e){if(!t.getAttribute("data-id"))return[];let n=this.getElementClassName(t);if(n&&n.includes("commit")){let c=Array.from(e.querySelectorAll('g[class*="branch"][data-id], path[class*="branch"], path[class*="edge"]')),i=[];try{let a=t.getBBox();for(let l of c)try{let o=l.getBBox();if(o.x<a.x+a.width&&o.x+o.width>a.x&&o.y<a.y+a.height&&o.y+o.height>a.y){let d=Array.from(e.querySelectorAll('g[class*="commit"][data-id], circle[class*="commit"][data-id]'));for(let u of d)if(u!==t&&!i.includes(u))try{let h=u.getBBox();o.x<h.x+h.width&&o.x+h.width>h.x&&o.y<h.y+h.height&&o.y+h.height>h.y&&i.push(u)}catch{continue}}}catch{continue}}catch{return[]}return i}if(n&&n.includes("branch")){let c=Array.from(e.querySelectorAll('g[class*="commit"][data-id], circle[class*="commit"][data-id]')),i=[];try{let a=t.getBBox();for(let l of c)try{let o=l.getBBox();a.x<o.x+o.width&&a.x+a.width>o.x&&a.y<o.y+o.height&&a.y+o.height>o.y&&i.push(l)}catch{continue}}catch{return[]}return i}return[]}};var ne=class extends I{getDiagramType(){return"timeline"}getTargetableClasses(){return["section","event","timeline"]}getTargetableTags(){return["g","rect","text"]}extractNodeIds(t){let e=new Map,s=[/^section-([A-Za-z0-9_]+)-\d+$/,/^event-([A-Za-z0-9_]+)-\d+$/,/^timeline-([A-Za-z0-9_]+)-\d+$/,/^([A-Za-z0-9_]+)-\d+$/];for(let n of Array.from(t.querySelectorAll("[id]"))){let c=n.getAttribute("id");if(!c)continue;let i=this.extractIdFromPatterns(c,s);if(i&&!e.has(i)){let a=n,l=null;for(;a&&a!==t;){if(a instanceof SVGElement&&a.tagName==="g"){let o=this.getElementClassName(a);if(o&&(o.includes("section")||o.includes("event")||o.includes("timeline"))){l=a;break}}a=a.parentElement}l?e.set(i,l):n.tagName==="g"&&this.hasTargetableClass(n)&&e.set(i,n)}}return e}getTargetSelectors(t){let e=this.escapeSelector(t);return[`g.section[data-id="${e}"]`,`g.event[data-id="${e}"]`,`g.timeline[data-id="${e}"]`,`g[class*="section"][data-id="${e}"]`,`g[class*="event"][data-id="${e}"]`,`g[class*="timeline"][data-id="${e}"]`,`[data-id="${e}"]`]}findAdjacentElements(t,e){if(!t.getAttribute("data-id"))return[];let n=this.getElementClassName(t);if(n&&n.includes("section"))return Array.from(t.querySelectorAll('g[class*="event"][data-id]'));if(n&&n.includes("event")){let c=t.parentElement;for(;c&&c!==e;){let a=this.getElementClassName(c);if(a&&a.includes("section"))return Array.from(c.querySelectorAll('g[class*="event"][data-id]')).filter(o=>o!==t);c=c.parentElement}return Array.from(e.querySelectorAll('g[class*="event"][data-id]')).filter(a=>a!==t)}return[]}};var se=class extends I{getDiagramType(){return"quadrantChart"}getTargetableClasses(){return["quadrant","point","data"]}getTargetableTags(){return["g","circle","rect","text"]}extractNodeIds(t){let e=new Map,s=[/^quadrant-([A-Za-z0-9_]+)-\d+$/,/^point-([A-Za-z0-9_]+)-\d+$/,/^data-([A-Za-z0-9_]+)-\d+$/,/^([A-Za-z0-9_]+)-\d+$/];for(let n of Array.from(t.querySelectorAll("[id]"))){let c=n.getAttribute("id");if(!c)continue;let i=this.extractIdFromPatterns(c,s);if(i&&!e.has(i)){let a=n,l=null;for(;a&&a!==t;){if(a instanceof SVGElement&&a.tagName==="g"){let o=this.getElementClassName(a);if(o&&(o.includes("quadrant")||o.includes("point")||o.includes("data"))){l=a;break}}a=a.parentElement}l?e.set(i,l):(n.tagName==="g"&&this.hasTargetableClass(n)||n.tagName==="circle"&&this.hasTargetableClass(n))&&e.set(i,n)}}return e}getTargetSelectors(t){let e=this.escapeSelector(t);return[`g.quadrant[data-id="${e}"]`,`g.point[data-id="${e}"]`,`g.data[data-id="${e}"]`,`circle.quadrant[data-id="${e}"]`,`circle.point[data-id="${e}"]`,`circle.data[data-id="${e}"]`,`g[class*="quadrant"][data-id="${e}"]`,`g[class*="point"][data-id="${e}"]`,`g[class*="data"][data-id="${e}"]`,`[data-id="${e}"]`]}findAdjacentElements(t,e){if(!t.getAttribute("data-id"))return[];let n=this.getElementClassName(t);if(n&&(n.includes("point")||n.includes("data")))try{let c=t.getBBox(),i=c.x+c.width/2,a=c.y+c.height/2,l=Array.from(e.querySelectorAll('g[class*="quadrant"]'));for(let o of l)try{let p=o.getBBox();if(i>=p.x&&i<=p.x+p.width&&a>=p.y&&a<=p.y+p.height)return Array.from(o.querySelectorAll('g[class*="point"][data-id], circle[class*="point"][data-id], g[class*="data"][data-id], circle[class*="data"][data-id]')).filter(u=>u!==t)}catch{continue}}catch{return Array.from(e.querySelectorAll('g[class*="point"][data-id], circle[class*="point"][data-id], g[class*="data"][data-id], circle[class*="data"][data-id]')).filter(i=>i!==t)}return n&&n.includes("quadrant")?Array.from(t.querySelectorAll('g[class*="point"][data-id], circle[class*="point"][data-id], g[class*="data"][data-id], circle[class*="data"][data-id]')):[]}};var re=class extends I{getDiagramType(){return"requirement"}getTargetableClasses(){return["requirement","function","relationship"]}getTargetableTags(){return["g","rect","path"]}extractNodeIds(t){let e=new Map,s=[/^requirement-([A-Za-z0-9_]+)-\d+$/,/^function-([A-Za-z0-9_]+)-\d+$/,/^relationship-([A-Za-z0-9_]+)-\d+$/,/^([A-Za-z0-9_]+)-\d+$/];for(let n of Array.from(t.querySelectorAll("[id]"))){let c=n.getAttribute("id");if(!c)continue;let i=this.extractIdFromPatterns(c,s);if(i&&!e.has(i)){let a=n,l=null;for(;a&&a!==t;){if(a instanceof SVGElement&&a.tagName==="g"){let o=this.getElementClassName(a);if(o&&(o.includes("requirement")||o.includes("function")||o.includes("relationship"))){l=a;break}}a=a.parentElement}l?e.set(i,l):n.tagName==="g"&&this.hasTargetableClass(n)&&e.set(i,n)}}return e}getTargetSelectors(t){let e=this.escapeSelector(t);return[`g.requirement[data-id="${e}"]`,`g.function[data-id="${e}"]`,`g.relationship[data-id="${e}"]`,`g[class*="requirement"][data-id="${e}"]`,`g[class*="function"][data-id="${e}"]`,`g[class*="relationship"][data-id="${e}"]`,`[data-id="${e}"]`]}findAdjacentElements(t,e){if(!t.getAttribute("data-id"))return[];let n=this.getElementClassName(t);if(n&&(n.includes("requirement")||n.includes("function"))){let c=Array.from(e.querySelectorAll('g[class*="relationship"][data-id], path[class*="relationship"]')),i=[];try{let a=t.getBBox();for(let l of c)try{let o=l.getBBox();if(o.x<a.x+a.width&&o.x+o.width>a.x&&o.y<a.y+a.height&&o.y+o.height>a.y){let d=Array.from(e.querySelectorAll('g[class*="requirement"][data-id], g[class*="function"][data-id]'));for(let u of d)if(u!==t&&!i.includes(u))try{let h=u.getBBox();o.x<h.x+h.width&&o.x+o.width>h.x&&o.y<h.y+h.height&&o.y+o.height>h.y&&i.push(u)}catch{continue}}}catch{continue}}catch{return[]}return i}return[]}};var Z=class extends I{constructor(t){super(),this.diagramType=t}getDiagramType(){return this.diagramType}getTargetableClasses(){return["c4","element","relationship","boundary"]}getTargetableTags(){return["g","rect","path","text"]}extractNodeIds(t){let e=new Map,s=[/^c4-([A-Za-z0-9_]+)-\d+$/,/^element-([A-Za-z0-9_]+)-\d+$/,/^relationship-([A-Za-z0-9_]+)-\d+$/,/^boundary-([A-Za-z0-9_]+)-\d+$/,/^([A-Za-z0-9_]+)-\d+$/,/^([A-Za-z0-9_]+)$/],n=[],c=Array.from(t.querySelectorAll("[id]"));for(let i of c){let a=i.getAttribute("id");if(!a)continue;n.push(a);let l=this.extractIdFromPatterns(a,s);if(l&&!e.has(l)){let o=i,p=null;for(;o&&o!==t;){if(o instanceof SVGElement&&o.tagName==="g"){let d=this.getElementClassName(o);if(d&&(d.includes("c4")||d.includes("element")||d.includes("relationship")||d.includes("boundary"))){p=o;break}}o=o.parentElement}p?e.set(l,p):i.tagName==="g"&&this.hasTargetableClass(i)&&e.set(l,i)}}return e}getTargetSelectors(t){let e=this.escapeSelector(t);return[`g.c4[data-id="${e}"]`,`g.element[data-id="${e}"]`,`g.relationship[data-id="${e}"]`,`g.boundary[data-id="${e}"]`,`g[class*="c4"][data-id="${e}"]`,`g[class*="element"][data-id="${e}"]`,`g[class*="relationship"][data-id="${e}"]`,`g[class*="boundary"][data-id="${e}"]`,`[data-id="${e}"]`]}findAdjacentElements(t,e){if(!t.getAttribute("data-id"))return[];let n=this.getElementClassName(t);if(n&&(n.includes("c4")||n.includes("element"))){let c=Array.from(e.querySelectorAll('g[class*="relationship"][data-id], path[class*="relationship"]')),i=[];try{let a=t.getBBox();for(let l of c)try{let o=l.getBBox();if(o.x<a.x+a.width&&o.x+o.width>a.x&&o.y<a.y+a.height&&o.y+o.height>a.y){let d=Array.from(e.querySelectorAll('g[class*="c4"][data-id], g[class*="element"][data-id]'));for(let u of d)if(u!==t&&!i.includes(u))try{let h=u.getBBox();o.x<h.x+h.width&&o.x+o.width>h.x&&o.y<h.y+h.height&&o.y+o.height>h.y&&i.push(u)}catch{continue}}}catch{continue}}catch{return[]}return i}if(n&&n.includes("relationship")){let c=Array.from(e.querySelectorAll('g[class*="c4"][data-id], g[class*="element"][data-id]')),i=[];try{let a=t.getBBox();for(let l of c)try{let o=l.getBBox();a.x<o.x+o.width&&a.x+a.width>o.x&&a.y<o.y+o.height&&a.y+a.height>o.y&&i.push(l)}catch{continue}}catch{return[]}return i}return[]}};var ae=class extends I{getDiagramType(){return"block"}getTargetableClasses(){return["block","node","edge"]}getTargetableTags(){return["g","rect","path"]}extractNodeIds(t){let e=new Map,s=[/^block-([A-Za-z0-9_]+)-\d+$/,/^node-([A-Za-z0-9_]+)-\d+$/,/^edge-([A-Za-z0-9_]+)-\d+$/,/^([A-Za-z0-9_]+)-\d+$/];for(let n of Array.from(t.querySelectorAll("[id]"))){let c=n.getAttribute("id");if(!c)continue;let i=this.extractIdFromPatterns(c,s);if(i&&!e.has(i)){let a=n,l=null;for(;a&&a!==t;){if(a instanceof SVGElement&&a.tagName==="g"){let o=this.getElementClassName(a);if(o&&(o.includes("block")||o.includes("node")||o.includes("edge"))){l=a;break}}a=a.parentElement}l?e.set(i,l):n.tagName==="g"&&this.hasTargetableClass(n)&&e.set(i,n)}}return e}getTargetSelectors(t){let e=this.escapeSelector(t);return[`g.block[data-id="${e}"]`,`g.node[data-id="${e}"]`,`g.edge[data-id="${e}"]`,`g[class*="block"][data-id="${e}"]`,`g[class*="node"][data-id="${e}"]`,`g[class*="edge"][data-id="${e}"]`,`[data-id="${e}"]`]}findAdjacentElements(t,e){if(!t.getAttribute("data-id"))return[];let n=this.getElementClassName(t);if(n&&(n.includes("block")||n.includes("node"))){let c=Array.from(e.querySelectorAll('path.edge, path[class*="edge"], g.edge path, path[id*="edge"]')),i=[];try{let a=t.getBBox(),l=a.x+a.width/2,o=a.y+a.height/2;for(let p of c)try{let d=p.getBBox(),u=d.x+d.width/2,h=d.y+d.height/2,w=Math.max(a.width,a.height)*1.5,D=Math.sqrt(Math.pow(u-l,2)+Math.pow(h-o,2));if(d.x<a.x+a.width&&d.x+d.width>a.x&&d.y<a.y+a.height&&d.y+d.height>a.y||D<w){let v=Array.from(e.querySelectorAll("g.block[data-id], g.node[data-id]"));for(let m of v)if(m!==t&&!i.includes(m))try{let b=m.getBBox(),S=b.x+b.width/2,E=b.y+b.height/2,k=Math.sqrt(Math.pow(S-u,2)+Math.pow(E-h,2));(d.x<b.x+b.width&&d.x+d.width>b.x&&d.y<b.y+b.height&&d.y+d.height>b.y||k<w)&&i.push(m)}catch{continue}}}catch{continue}}catch{return[]}return i}return[]}};M.register("flowchart",new F);M.register("gantt",new U);M.register("sequenceDiagram",new Y);M.register("classDiagram",new X);M.register("stateDiagram",new H);M.register("stateDiagram-v2",new H);M.register("erDiagram",new Q);M.register("pie",new J);M.register("journey",new ee);M.register("gitGraph",new te);M.register("timeline",new ne);M.register("quadrantChart",new se);M.register("requirement",new re);M.register("c4Context",new Z("c4Context"));M.register("c4Container",new Z("c4Container"));M.register("c4Component",new Z("c4Component"));M.register("block",new ae);M.setDefault(new F);function Pe(r,t,e){let s=t.extractNodeIds(r),n=t.getDiagramType(),c=e?$e(e):new Set,i=new Set;if(n==="classDiagram"&&e){let v=/class\s+([A-Za-z0-9_]+)\s*[<{]/g,m;for(;(m=v.exec(e))!==null;)i.add(m[1]);let b=/class\s+([A-Za-z0-9_]+)(?:\s|$)/g;for(b.lastIndex=0;(m=b.exec(e))!==null;)i.add(m[1])}let a=new Set;if(n==="erDiagram"&&e){let v=/([A-Z][A-Z0-9_]+)\s*\{/g,m;for(;(m=v.exec(e))!==null;)a.add(m[1]);let b=/([A-Z][A-Z0-9_]+)\s*[|o]+--[|o]+/g;for(b.lastIndex=0;(m=b.exec(e))!==null;)a.add(m[1]);let S=/[|o]+--[|o]+\s*([A-Z][A-Z0-9_]+)/g;for(S.lastIndex=0;(m=S.exec(e))!==null;)a.add(m[1])}let l=new Set;if(n==="gitGraph"&&e){let v=/branch\s+([A-Za-z0-9_]+)/g,m;for(;(m=v.exec(e))!==null;)l.add(m[1]);let b=/checkout\s+([A-Za-z0-9_]+)/g;for(b.lastIndex=0;(m=b.exec(e))!==null;)l.add(m[1]);let S=/commit\s+id:\s*"([^"]+)"/g;for(S.lastIndex=0;(m=S.exec(e))!==null;)l.add(m[1]);let E=/merge\s+([A-Za-z0-9_]+)/g;for(E.lastIndex=0;(m=E.exec(e))!==null;)l.add(m[1]);l.add("merge")}let o=new Set;if(n==="journey"&&e){let v=e.split(`
`);for(let m of v){if(m.trim().startsWith("title")||m.trim().startsWith("section"))continue;let b=m.match(/^\s+([^:]+):\s*\d+:/);if(b&&b[1]){let S=b[1].trim();S&&!S.includes(`
`)&&o.add(S)}}}let p=new Set;if(n==="pie"&&e){let v=/"([^"]+)"\s*:\s*\d+\.?\d*/g,m;for(v.lastIndex=0;(m=v.exec(e))!==null;){let b=m[1].trim();b&&p.add(b)}}let d=new Set;if(n==="quadrantChart"&&e){let v=/"?([^":\n]+)"?\s*:\s*\[?[\d.]+\s*,\s*[\d.]+\]?/g,m;for(v.lastIndex=0;(m=v.exec(e))!==null;){let b=m[1].trim();b&&d.add(b)}}let u=new Set;if(n==="requirement"&&e){let v=/requirement\s+([A-Za-z0-9_]+)\s*\{/g,m;for(v.lastIndex=0;(m=v.exec(e))!==null;){let E=m[1].trim();E&&u.add(E)}let b=/element\s+([A-Za-z0-9_]+)\s*\{/g,S;for(b.lastIndex=0;(S=b.exec(e))!==null;){let E=S[1].trim();E&&u.add(E)}}let h=new Set;if(n==="sequenceDiagram"&&e){let v=/(?:participant|actor)\s+([A-Za-z0-9_]+)/g,m;for(v.lastIndex=0;(m=v.exec(e))!==null;){let E=m[1].trim();E&&h.add(E)}let b=/(?:->>|->|-->>|-->)\s*[A-Za-z0-9_]+\s*:\s*([^\n]+)/g,S;for(b.lastIndex=0;(S=b.exec(e))!==null;){let E=S[1].trim();E&&h.add(E)}}let w=new Set;if(n==="timeline"&&e){let v=/section\s+([^\n]+)/g,m;for(v.lastIndex=0;(m=v.exec(e))!==null;){let b=m[1].trim();b&&w.add(b)}}if(e&&((n==="c4Component"||n==="c4Container"||n==="c4Context")&&(s.size===0||s.size<c.size)||n==="classDiagram"&&(s.size===0||s.size<i.size)||n==="erDiagram"&&(s.size===0||s.size<a.size)||n==="gitGraph"&&(s.size===0||s.size<l.size)||n==="journey"&&(s.size===0||s.size<o.size)||n==="pie"&&(s.size===0||s.size<p.size)||n==="quadrantChart"&&(s.size===0||s.size<d.size)||n==="requirement"&&(s.size===0||s.size<u.size)||n==="sequenceDiagram"&&(s.size===0||s.size<h.size)||n==="timeline"&&(s.size===0||s.size<w.size))){let v={};if(n==="c4Container"||n==="c4Context"){let S=/(?:Container_Boundary|System_Boundary)\s*\(\s*([A-Za-z0-9_]+)\s*,[\s\S]*?\{([\s\S]*?)\}/g,E;for(S.lastIndex=0;(E=S.exec(e))!==null;){let k=E[1],q=E[2],P=[/Container\s*\(\s*([A-Za-z0-9_]+)\s*,/g,/Component\s*\(\s*([A-Za-z0-9_]+)\s*,/g],T=[];for(let x of P){x.lastIndex=0;let V;for(;(V=x.exec(q))!==null;)T.push(V[1])}T.length>0&&(v[k]=T)}}let m=n==="classDiagram"?i:n==="erDiagram"?a:n==="gitGraph"?l:n==="journey"?o:n==="pie"?p:n==="quadrantChart"?d:n==="requirement"?u:n==="sequenceDiagram"?h:n==="timeline"?w:c,b=n==="erDiagram"||n==="gitGraph"||n==="journey"||n==="pie"||n==="quadrantChart"||n==="requirement"||n==="sequenceDiagram"?Array.from(m).sort((S,E)=>E.length!==S.length?E.length-S.length:S.localeCompare(E)):Array.from(m);for(let S of b){if(s.has(S)||v[S])continue;let E=S.toLowerCase(),q=Array.from(r.querySelectorAll("*")).filter(T=>{let x=T.textContent?.toLowerCase()||"";if(n==="erDiagram"){let y=S.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");if(new RegExp(`\\b${y.replace(/_/g,"\\_")}\\b`,"i").test(x))return!0;let C=S.replace(/_/g,"").toLowerCase();if(x.trim().startsWith(C)||x.trim().endsWith(C)||new RegExp(`\\b${C}\\b`,"i").test(x)||x.trim().startsWith(E)||x.trim().endsWith(E))return!0}if(n==="gitGraph"){let y=S.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");if(new RegExp(`\\b${y}\\b`,"i").test(x)||x.trim().startsWith(E)||x.trim().endsWith(E))return!0}if(n==="journey"){let y=S.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");if(new RegExp(y.replace(/\s+/g,"\\s+"),"i").test(x)||new RegExp(`\\b${y.replace(/\s+/g,"\\s+")}\\b`,"i").test(x)||x.trim().startsWith(E)||x.trim().endsWith(E))return!0}if(n==="timeline"){let y=x.replace(/\s+/g," ").trim().toLowerCase(),A=E.replace(/\s+/g," ").trim();if(y.includes(A))return!0;let G=S.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");if(new RegExp(G.replace(/\s+/g,"\\s+"),"i").test(x)||y.startsWith(A)||y.endsWith(A))return!0}if(n==="classDiagram"&&(new RegExp(`\\b${S.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\b`,"i").test(x)||x.trim().startsWith(E)||x.trim().endsWith(E)))return!0;let V=E==="db"?/<<system_db>>/i:null;if(V&&V.test(x)||x.includes(E)&&(x.startsWith(E)||x.includes(" "+E)||x.includes(E+" ")||x.includes("<<"+E)||x.includes(E+">>")))return!0;let g=S.replace(/([a-z])([A-Z])/g,"$1 $2").toLowerCase();if(g!==E&&g.includes(" ")){let y=g.split(" ");if(y.length>1&&y.every(A=>x.includes(A))){let A=y.join("");if(x.includes(A)||y.every((G,C)=>{if(C===0)return x.includes(G);let B=y[C-1];return x.includes(B+" "+G)||x.includes(B+G)}))return!0}}if(E.length>3){let y=["app","api","ui","db","service","system","user"];for(let A of y)if(E.endsWith(A)&&E.length>A.length){let G=E.slice(0,-A.length);if(x.includes(G)&&(x.includes(A)||x.includes(A+"lication")||x.includes(A+"i"))&&(x.includes(G+" "+A)||x.includes(G+A)||x.includes(G)&&x.includes(A+"lication")))return!0}}return!1}),P=!1;for(let T of q){let x=T,V=null;if(n==="pie"){let g=null,y=T;for(;y&&y!==r;){if(y instanceof SVGElement&&y.tagName==="g"){let A=typeof y.className=="string"?y.className:y.className.baseVal;if(A&&A.includes("legend")){g=y;break}}y=y.parentElement}if(g){let A=Array.from(r.querySelectorAll("path")),G=Array.from(r.querySelectorAll("g")).filter($=>{let R=typeof $.className=="string"?$.className:$.className.baseVal;return R&&R.includes("legend")}),C=g?G.indexOf(g):-1,B=A.filter($=>{let R=$.getAttribute("d");return R&&R.includes("M")&&(R.includes("A")||R.includes("L"))});if(C>=0&&C<B.length){let $=B[C];if($ instanceof SVGGraphicsElement){let R=String(S);if(!s.has(R)){s.set(R,$),P=!0;continue}}}}}if(n==="sequenceDiagram"&&T instanceof SVGElement){let g=typeof T.className=="string"?T.className:T.className.baseVal;if(g&&g.includes("message")){let y=null;try{if(T instanceof SVGGraphicsElement){let G=T.getBBox(),C=Array.from(r.querySelectorAll("line, path"));for(let B of C)try{let $=B.getBBox();if(Math.sqrt(Math.pow(G.x+G.width/2-($.x+$.width/2),2)+Math.pow(G.y+G.height/2-($.y+$.height/2),2))<150){let O=B.parentElement;for(;O&&O!==r;){if(O instanceof SVGElement&&O.tagName==="g"){let W=typeof O.className=="string"?O.className:O.className.baseVal;if(W&&(W.includes("message")||O.contains(T))){y=O;break}}O=O.parentElement}if(y)break;y=B;break}}catch{continue}}}catch{}let A=T;for(;A&&A!==r&&!y;){if(A instanceof SVGElement&&A.tagName==="g"){let G=typeof A.className=="string"?A.className:A.className.baseVal;if(G&&G.includes("message")){y=A;break}}A=A.parentElement}if(y?V=y:T instanceof SVGGraphicsElement&&(V=T),V){P=!0;let G=String(S),C=null;for(let[B,$]of s.entries())if(B===G){C=$;break}C&&C!==V&&s.delete(G),s.has(G)||s.set(G,V);continue}}}if(n==="quadrantChart"){let g=T;for(;g&&g!==r;){if(g instanceof SVGElement&&g.tagName==="g"){let y=typeof g.className=="string"?g.className:g.className.baseVal;if(y&&y.includes("data-point")&&!y.includes("data-points")&&!y.includes("main")&&g.querySelector("circle")){V=g,P=!0;let A=String(S),G=null;for(let[B,$]of s.entries())if(B===A){G=$;break}if(G){let B=typeof G.className=="string"?G.className:G.className.baseVal;B&&(B.includes("main")||B.includes("data-points"))&&s.delete(A)}let C=null;for(let[B,$]of s.entries())if($===V){C=B;break}if(C&&A.length<=C.length){P=!1;break}C&&s.delete(C),s.set(A,V);break}}g=g.parentElement}if(P&&V)continue}for(;x&&x!==r;){if(x instanceof SVGElement&&x.tagName==="g"){let g=x instanceof SVGElement?typeof x.className=="string"?x.className:x.className.baseVal:"",y=x.querySelector("rect, circle, ellipse, polygon, path");if(n==="pie"&&g&&g.includes("legend")){x=x.parentElement;continue}if(n==="quadrantChart"&&g&&(g.includes("main")||g.includes("data-points"))){x=x.parentElement;continue}if(n==="quadrantChart"&&g&&(g.includes("point")||g.includes("quadrant")||g.includes("data"))){if(g&&g.includes("data-point")&&!g.includes("data-points")){if(V=x,x.querySelector("circle"))break}else if(!V&&!g.includes("main")&&!g.includes("data-points")&&(V=x,x.querySelector("circle")))break}if((g&&(g.includes("c4")||g.includes("element")||g.includes("component")||g.includes("container")||g.includes("relationship")||g.includes("boundary")||g.includes("branch")||g.includes("commit")||g.includes("merge")||g.includes("branchLabel")||g.includes("label")||g.includes("step")||g.includes("task")||g.includes("section")||g.includes("journey")||g.includes("slice")||g.includes("segment")||g.includes("pie")||g.includes("quadrant")||g.includes("point")||g.includes("timeline")||g.includes("event"))||y||!V)&&(V=x,y||g&&(g.includes("branchLabel")||g.includes("label")||g.includes("step")||g.includes("task")||g.includes("slice")||g.includes("point")||g.includes("quadrant"))))break}x=x.parentElement}if(V){let g=String(S);if(n==="quadrantChart"){let y=s.get(g);if(y){let A=typeof y.className=="string"?y.className:y.className.baseVal;if(A&&(A.includes("main")||A.includes("data-points"))||A&&A.includes("data-point")&&!A.includes("data-points"))continue}}if(n==="erDiagram"||n==="gitGraph"||n==="journey"||n==="pie"||n==="quadrantChart"){let y=null;for(let[A,G]of s.entries())if(G===V){y=A;break}if(y&&g.length<=y.length)continue;y&&s.delete(y)}s.has(g)||(s.set(g,V),P=!0);break}}}for(let[S,E]of Object.entries(v)){if(s.has(S))continue;let k=[];for(let q of E)if(s.has(q))k.push(s.get(q));else{let P=r.querySelector(`[data-id="${q}"]`);P&&P instanceof SVGElement&&k.push(P)}if(k.length>=Math.min(2,E.length)){let q=Array.from(r.querySelectorAll("g")),P=[];for(let x of q){let V=!0;for(let g of k)if(!x.contains(g)){V=!1;break}V&&P.push(x)}let T=null;if(P.length===0){let x=!0;for(let V of k)if(!r.contains(V)){x=!1;break}x&&(T=r)}else for(let x of P){let V=x instanceof SVGElement?typeof x.className=="string"?x.className:x.className.baseVal:"";if(!!x.querySelector("rect, circle, ellipse, polygon, path")||V.includes("boundary")||V.includes("container")||V.includes("system")){T=x;break}T||(T=x)}T&&!s.has(S)&&s.set(S,T)}}}let N=new Map;if(n==="gitGraph"&&e){let v=/merge\s+([A-Za-z0-9_]+)/g,m=e.split(`
`);v.lastIndex=0;let b;for(;(b=v.exec(e))!==null;){let S=m.findIndex(E=>E.includes(b[0]));if(S>=0&&S<m.length-1){let k=m[S+1].match(/commit\s+id:\s*"([^"]+)"/);k&&k[1]&&s.has(k[1])&&(N.has("merge")||N.set("merge",k[1]))}}}for(let[v,m]of s)m.setAttribute("data-id",v);for(let[v,m]of N.entries()){let b=s.get(m);b&&(s.set(v,b),b.setAttribute("data-id",v))}for(let[v,m]of N.entries()){let b=s.get(m);b&&(b.setAttribute("data-id-merge",v),s.has(v)||(s.set(v,b),b.setAttribute("data-id",v)))}}var Be=(r,t,e)=>({getRoot:()=>t,getContainer:()=>r,resolveTarget:s=>L({getRoot:()=>t,getStrategy:()=>e},s),getStrategy:()=>e,destroy:()=>{r.innerHTML=""}});function $e(r){let t=new Set,e=[/Component\s*\(\s*([A-Za-z0-9_]+)\s*,/g,/Container\s*\(\s*([A-Za-z0-9_]+)\s*,/g,/Person\s*\(\s*([A-Za-z0-9_]+)\s*,/g,/System\s*\(\s*([A-Za-z0-9_]+)\s*,/g,/System_Ext\s*\(\s*([A-Za-z0-9_]+)\s*,/g,/SystemDb\s*\(\s*([A-Za-z0-9_]+)\s*,/g,/Container_Boundary\s*\(\s*([A-Za-z0-9_]+)\s*,/g,/System_Boundary\s*\(\s*([A-Za-z0-9_]+)\s*,/g];for(let s of e){s.lastIndex=0;let n;for(;(n=s.exec(r))!==null;)t.add(n[1])}return t}var xe=()=>({async render({mountEl:r,mermaidText:t}){let e=window.mermaid;if(!e||typeof e.render!="function")throw new z("Mermaid is not available on window.mermaid","MPF_MERMAID_UNAVAILABLE");let s=`finsteps-${Math.random().toString(36).slice(2,8)}`,n;try{n=await e.render(s,t)}catch(u){throw new z(`Failed to render Mermaid diagram: ${u}`,"MPF_MERMAID_RENDER_FAILED")}let{svg:c}=n;r.innerHTML="";let i=document.createElement("div");i.className="finsteps-diagram",i.tabIndex=0,i.setAttribute("role","application"),i.innerHTML=c,r.appendChild(i);let a=i.querySelector("svg");if(!a)throw new z("Mermaid render did not return an SVG element","MPF_MERMAID_RENDER_FAILED");let l=Se(t),o=M.getOrDefault(l);Pe(a,o,t),a.removeAttribute("width"),a.removeAttribute("height"),a.setAttribute("width","100%"),a.setAttribute("height","100%"),a.getAttribute("preserveAspectRatio")||a.setAttribute("preserveAspectRatio","xMidYMid meet");let p=a.getAttribute("viewBox"),d=p;if(!p||p==="0 0 0 0"){let u=a.querySelector("g");if(u)try{let h=u.getBBox();h.width>0&&h.height>0&&(d=`${h.x-40} ${h.y-40} ${h.width+40*2} ${h.height+40*2}`,a.setAttribute("viewBox",d))}catch{let h=a.getAttribute("width"),w=a.getAttribute("height");if(h&&w){let D=parseFloat(h)||1e3,N=parseFloat(w)||1e3;d=`0 0 ${D} ${N}`,a.setAttribute("viewBox",d)}}}return d&&a.setAttribute("data-initial-viewbox",d),Be(i,a,o)}});var ie=class{constructor(t){this.handlers=t}async run(t,e,s){let n=[];for(let c of t){let i=this.handlers[c.type];if(!i){let a=new K(`Unknown action: ${c.type}`,"MPF_ACTION_UNKNOWN");if(s==="haltOnError")throw a;n.push(a);continue}try{await i(e,c)}catch(a){if(a instanceof Error){if(s==="haltOnError")throw a;n.push(a)}else if(s==="haltOnError")throw a}}return n}};var we=(r,t,e)=>{for(let s of r.elements)s.classList.remove(r.className);r.elements.clear(),r.className=e;for(let s of t)s.classList.add(e),r.elements.add(s)},Me=(r,t)=>{if(!t)return[];let e=L(r.diagram,t);return e?[e]:[]},be=()=>{let r={className:"finsteps-highlight",elements:new Set};return{"nav.next":async({controller:e})=>{await e.next()},"nav.prev":async({controller:e})=>{await e.prev()},"nav.goto":async({controller:e},s)=>{let n=s.payload?.index,c=s.payload?.id;if(typeof n=="number"){await e.goto(n);return}if(typeof c=="string"){await e.goto(c);return}throw new K("nav.goto requires index or id","MPF_ACTION_INVALID_ARGS")},"nav.reset":async({controller:e})=>{await e.reset()},"camera.fit":async(e,s)=>{if(!e.camera)return;let n=s.payload?.target,c=L(e.diagram,n);if(!c)throw new K("camera.fit missing target","MPF_ACTION_INVALID_ARGS");let a=s.payload?.durationMs??s.payload?.duration,l=s.payload?.easing;await e.camera.fit(c,{padding:typeof s.payload?.padding=="number"?s.payload.padding:void 0,duration:typeof a=="number"?a:void 0,easing:typeof l=="string"?l:void 0})},"camera.reset":({camera:e})=>{e?.reset()},"camera.fitAll":(e,s)=>{if(!e.camera)return;let n=typeof s.payload?.padding=="number"?s.payload.padding:void 0;e.camera.fitAll?e.camera.fitAll(n):e.camera.reset&&e.camera.reset()},"overlay.bubble":(e,s)=>{if(!e.overlay)return;let n=s.payload?.target,c=L(e.diagram,n);if(!c)throw new K("overlay.bubble missing target","MPF_ACTION_INVALID_ARGS");let i=String(s.payload?.text??"");e.overlay.showBubble({id:typeof s.payload?.id=="string"?s.payload.id:void 0,target:c,text:i})},"overlay.hide":(e,s)=>{e.overlay?.hideBubble(typeof s.payload?.id=="string"?s.payload.id:void 0)},"style.highlight":(e,s)=>{let n=s.payload?.target,c=typeof s.payload?.className=="string"?s.payload.className:"finsteps-highlight",i=Me(e,n);we(r,i,c)},"style.clear":()=>{we(r,[],r.className)},wait:async(e,s)=>{let n=typeof s.payload?.ms=="number"?s.payload.ms:0;await new Promise(c=>window.setTimeout(c,n))}}};var j=class{constructor(){this.disposers=[];this.timeouts=[]}bind(t,e){for(let s of t){if(s.event==="timer"){let l=window.setTimeout(async()=>{let o=await e.actionEngine.run(s.actions,{controller:e.controller,diagram:e.diagram,event:{type:"timer",target:null,currentTarget:null,originalEvent:null,timeStamp:Date.now()},camera:e.camera,overlay:e.overlay},e.errorPolicy);for(let p of o)e.onError(p)},s.delayMs??0);this.timeouts.push(l);continue}let n=s.event==="key"?e.diagram.getContainer():e.diagram.getRoot(),c=L(e.diagram,s.target)??n,i=s.event==="click"?"click":s.event==="hover"?"mouseenter":s.event==="key"?"keydown":s.eventName??s.event,a=async l=>{if(s.event==="key"&&s.key&&l.key!==s.key)return;let o=qe(l,i),p=await e.actionEngine.run(s.actions,{controller:e.controller,diagram:e.diagram,event:o,camera:e.camera,overlay:e.overlay},e.errorPolicy);for(let d of p)e.onError(d)};c.addEventListener(i,a),this.disposers.push(()=>c.removeEventListener(i,a))}}destroy(){for(let t of this.disposers)t();for(let t of this.timeouts)window.clearTimeout(t);this.disposers=[],this.timeouts=[]}},qe=(r,t)=>r instanceof MouseEvent?{type:t,target:r.target,currentTarget:r.currentTarget,clientX:r.clientX,clientY:r.clientY,timeStamp:r.timeStamp,originalEvent:r}:r instanceof KeyboardEvent?{type:t,target:r.target,currentTarget:r.currentTarget,key:r.key,timeStamp:r.timeStamp,originalEvent:r}:{type:t,target:r.target,currentTarget:r.currentTarget,timeStamp:r.timeStamp,originalEvent:r};var oe=class{constructor(){this.listeners=new Map}on(t,e){let s=this.listeners.get(t)??new Set;return s.add(e),this.listeners.set(t,s),()=>{s.delete(e)}}emit(t,e){let s=this.listeners.get(t);if(s)for(let n of s)n(e)}clear(){this.listeners.clear()}};var ce=class{constructor(t){this.deps=t;this.emitter=new oe;this.bindingEngine=new j;this.stepBindingEngine=new j;this.currentStepIndex=-1;this.previousStepIndex=-1;this.lastError=null;this.failedStepIndex=null;this.executionContext={};let e={...be(),...t.actionHandlers??{}};this.actionEngine=new ie(e),this.steps=t.ast.steps??[]}async init(t){if(t&&this.emitter.emit("render",t),this.deps.ast.bindings?.length&&this.bindingEngine.bind(this.deps.ast.bindings,{diagram:this.deps.diagram,actionEngine:this.actionEngine,errorPolicy:this.deps.errorPolicy,controller:this,camera:this.deps.camera,overlay:this.deps.overlay,onError:e=>this.emitActionError(e)}),this.steps.length>0&&await this.goto(0),this.deps.hooks?.onInit)try{await this.deps.hooks.onInit(this)}catch(e){console.warn("[MermaidController] onInit hook error:",e)}}async next(){await this.goto(this.currentStepIndex+1)}async prev(){await this.goto(this.currentStepIndex-1)}async goto(t){let e=typeof t=="number"?t:this.steps.findIndex(p=>p.id===t);if(e<0||e>=this.steps.length)return;let s=this.steps[e],n=s.errorPolicy??this.deps.errorPolicy;this.previousStepIndex=this.currentStepIndex;let c=this.previousStepIndex>=0?this.steps[this.previousStepIndex]:void 0;this.executionContext.previousStep=c,this.executionContext.currentStep=s,this.stepBindingEngine.destroy(),this.deps.overlay?.clear&&this.deps.overlay.clear();let i=s.actions.length>0&&(s.actions[0].type==="camera.fit"||s.actions[0].type==="camera.reset"||s.actions[0].type==="camera.fitAll");this.deps.camera&&!i&&this.deps.camera.reset(),await this.actionEngine.run([{type:"style.clear"}],{controller:this,diagram:this.deps.diagram,camera:this.deps.camera,overlay:this.deps.overlay},"continueOnError"),await new Promise(p=>{requestAnimationFrame(()=>{requestAnimationFrame(()=>p())})});let a=[],l=!1;try{for(let d of s.actions){this.executionContext.currentAction=d;let u={action:{...d},step:{...s},context:this.getExecutionContext()};if(this.emitter.emit("actionstart",u),this.deps.hooks?.onActionStart)try{this.deps.hooks.onActionStart(d,s)}catch(h){console.warn("[MermaidController] onActionStart hook error:",h)}}let p=await this.actionEngine.run(s.actions,{controller:this,diagram:this.deps.diagram,camera:this.deps.camera,overlay:this.deps.overlay},n);a=p;for(let d of s.actions){let u=p.find(D=>D instanceof Error&&D.message.includes(d.type)),h={success:!u,error:u},w={action:{...d},result:h,step:{...s},context:this.getExecutionContext()};if(this.emitter.emit("actioncomplete",w),this.deps.hooks?.onActionComplete)try{this.deps.hooks.onActionComplete(d,h)}catch(D){console.warn("[MermaidController] onActionComplete hook error:",D)}}for(let d of p)this.emitActionError(d,s)}catch(p){l=!0;let d=p instanceof Error?p:new Error(String(p));if(this.lastError=d,this.failedStepIndex=e,this.emitActionError(d,s),n==="haltOnError"){this.currentStepIndex=e,this.emitter.emit("stepchange",{state:this.getState(),previousState:{stepIndex:this.previousStepIndex,stepId:this.steps[this.previousStepIndex]?.id,stepCount:this.steps.length},step:{...s},previousStep:c?{...c}:void 0});return}}!l&&a.length===0&&(this.lastError=null,this.failedStepIndex=null),this.currentStepIndex=e,s.bindings?.length&&this.stepBindingEngine.bind(s.bindings,{diagram:this.deps.diagram,actionEngine:this.actionEngine,errorPolicy:n,controller:this,camera:this.deps.camera,overlay:this.deps.overlay,onError:p=>this.emitActionError(p,s)}),this.executionContext.currentAction=void 0;let o={state:this.getState(),previousState:{stepIndex:this.previousStepIndex,stepId:this.steps[this.previousStepIndex]?.id,stepCount:this.steps.length},step:{...s},previousStep:c?{...c}:void 0};if(this.emitter.emit("stepchange",o),this.deps.hooks?.onStepChange)try{await this.deps.hooks.onStepChange(this.getState(),s)}catch(p){console.warn("[MermaidController] onStepChange hook error:",p)}}async reset(){await this.goto(0)}async retry(){this.failedStepIndex!==null&&this.failedStepIndex>=0?await this.goto(this.failedStepIndex):this.currentStepIndex>=0&&await this.goto(this.currentStepIndex)}clearError(){this.lastError=null,this.failedStepIndex=null}async updateAst(t,e){let s=e?.preserveState??!1,n=this.getState(),c=this.steps[this.currentStepIndex]?.id;if(this.deps.ast=t,this.steps=t.steps??[],this.bindingEngine.destroy(),t.bindings?.length&&this.bindingEngine.bind(t.bindings,{diagram:this.deps.diagram,actionEngine:this.actionEngine,errorPolicy:this.deps.errorPolicy,controller:this,camera:this.deps.camera,overlay:this.deps.overlay,onError:i=>this.emitActionError(i)}),s&&c){let i=this.steps.findIndex(a=>a.id===c);i>=0?(this.currentStepIndex=i,await this.goto(i)):this.steps.length>0?await this.goto(0):this.currentStepIndex=-1}else this.steps.length>0?await this.goto(0):this.currentStepIndex=-1;this.emitter.emit("astchange",{previousState:n,newState:this.getState(),previousSteps:n.stepCount,newSteps:this.steps.length})}destroy(){this.bindingEngine.destroy(),this.stepBindingEngine.destroy(),this.deps.camera?.destroy(),this.deps.overlay?.destroy(),this.deps.diagram.destroy(),this.emitter.clear()}getState(){return{stepIndex:this.currentStepIndex,stepId:this.steps[this.currentStepIndex]?.id,stepCount:this.steps.length,errorState:this.lastError?{hasError:!0,lastError:this.lastError,failedStep:this.failedStepIndex??void 0}:void 0}}getExecutionContext(){return{currentAction:this.executionContext.currentAction?{...this.executionContext.currentAction}:void 0,currentStep:this.executionContext.currentStep?{...this.executionContext.currentStep}:void 0,previousStep:this.executionContext.previousStep?{...this.executionContext.previousStep}:void 0}}async setState(t){if(typeof t.stepIndex=="number"){await this.goto(t.stepIndex);return}typeof t.stepId=="string"&&await this.goto(t.stepId)}on(t,e){return this.emitter.on(t,e)}getDeps(){return{diagram:this.deps.diagram,camera:this.deps.camera,overlay:this.deps.overlay}}getSteps(){return this.steps.map(t=>({...t}))}getCurrentStep(){return this.currentStepIndex<0||this.currentStepIndex>=this.steps.length?null:{...this.steps[this.currentStepIndex]}}getActionEngine(){return this.actionEngine}emitActionError(t,e){this.lastError=t;let s={step:e?{...e}:this.executionContext.currentStep,action:this.executionContext.currentAction},n={error:t,...s,context:this.getExecutionContext()};if(this.emitter.emit("actionerror",n),this.emitter.emit("error",n),this.deps.hooks?.onError)try{this.deps.hooks.onError(t,s)}catch(c){console.warn("[MermaidController] onError hook error:",c)}}};var pn=r=>{let t=r.parentElement??document.body;return{getRoot:()=>r,getContainer:()=>t,resolveTarget:e=>L({getRoot:()=>r},e),destroy:()=>{r.remove()}}},hn=()=>({fit:()=>{},reset:()=>{},destroy:()=>{}}),gn=()=>({showBubble:()=>{},hideBubble:()=>{},destroy:()=>{}});var _e=new Set(["mpd","deck","meta","let","use","diagram","mermaid","config","assets","runtime","camera","overlay","navigation","performance","selectors","styles","scene","step","as","focus","pad","align","lock","id","do","assert","else","binding","priority","on","target","when","node","edge","subgraph","css","text","group","union","intersect","except","true","false","null","or","and","viewport","container","svg","engine","options","bounds","strategy","fallback","classes","spotlight","theme","keys","wheelZoom","dragPan","tapToAdvance","progressUI","startAt","click","dblclick","hover","mouseenter","mouseleave","wheel","scroll","key","timer","custom","any"]),ve=new Set(["==","!=","<=",">=","<",">","+","-","*","/","%","!"]),Oe=new Set(["{","}","(",")","[","]",":",";",",",".","=","$"]),Re=/^[+-]?(?:\d+(?:\.\d+)?|\.\d+)/,ze=/^\d+/,Ae=/^[A-Za-z_][A-Za-z0-9_-]*/,Le=/^#[0-9A-Fa-f]{3}(?:[0-9A-Fa-f]{3})?/;function _(r,t){let{line:e,column:s,offset:n}=r;for(let c of t)n+=1,c===`
`?(e+=1,s=1):s+=1;return{line:e,column:s,offset:n}}function Fe(r,t){return{start:r,end:t}}function Ne(r){let t=[],e=[],s={offset:0,line:1,column:1},n=0,c=(i,a,l,o,p,d)=>{t.push({type:i,value:a,start:o,end:p,image:l,heredoc:d})};for(;n<r.length;){let i=r[n];if(i===" "||i==="	"||i==="\r"||i===`
`){let d=/^[ \t\r\n]+/.exec(r.slice(n));if(d){let u=d[0];s=_(s,u),n+=u.length;continue}}if(i==="#"||i==="/"&&r[n+1]==="/"){let d=/^(#|\/\/)[^\n\r]*/.exec(r.slice(n));if(d){let u=d[0];s=_(s,u),n+=u.length;continue}}if(r.startsWith("<<<",n)){let d=Ze(r,n);if(d){let{image:u,tag:h,body:w}=d,D=s,N=_(s,u);c("heredoc",u,u,D,N,{tag:h,body:w}),s=N,n+=u.length;continue}}if(i==='"'||i==="'"){let{image:d,value:u}=Ke(r,n,s,e),h=s,w=_(s,d);c("string",u,d,h,w),s=w,n+=d.length;continue}if(i==="#"){let d=Le.exec(r.slice(n));if(d){let u=d[0],h=s,w=_(s,u);c("color",u,u,h,w),s=w,n+=u.length;continue}}let a=Re.exec(r.slice(n));if(a){let d=a[0],u=r.slice(n+d.length),h=/^(ms|s|m)/.exec(u);if(h){let N=d+h[0],v=s,m=_(s,N);c("duration",N,N,v,m),s=m,n+=N.length;continue}if(u.startsWith("%")){let N=`${d}%`,v=s,m=_(s,N);c("percent",N,N,v,m),s=m,n+=N.length;continue}let w=s,D=_(s,d);c("number",d,d,w,D),s=D,n+=d.length;continue}let l=ze.exec(r.slice(n));if(l){let d=l[0],u=s,h=_(s,d);c("int",d,d,u,h),s=h,n+=d.length;continue}let o=Ae.exec(r.slice(n));if(o){let d=o[0],u=s,h=_(s,d);d==="true"||d==="false"?c("boolean",d,d,u,h):d==="null"?c("null",d,d,u,h):_e.has(d)?c("keyword",d,d,u,h):c("identifier",d,d,u,h),s=h,n+=d.length;continue}let p=r.slice(n,n+2);if(ve.has(p)){let d=s,u=_(s,p);c("operator",p,p,d,u),s=u,n+=p.length;continue}if(ve.has(i)){let d=s,u=_(s,i);c("operator",i,i,d,u),s=u,n+=1;continue}if(Oe.has(i)){let d=s,u=_(s,i);c("punct",i,i,d,u),s=u,n+=1;continue}e.push({message:`Unexpected character '${i}'.`,severity:"error",span:Fe(s,_(s,i)),code:"lex/unexpected-character"}),s=_(s,i),n+=1}return t.push({type:"eof",value:"<eof>",start:s,end:s,image:""}),{tokens:t,diagnostics:e}}function Ke(r,t,e,s){let n=r[t],c=t+1,i="";for(;c<r.length;){let l=r[c];if(l===n)return{image:r.slice(t,c+1),value:i};if(l==="\\"){let o=r[c+1];if(o==="n"){i+=`
`,c+=2;continue}if(o==="t"){i+="	",c+=2;continue}if(o==="r"){i+="\r",c+=2;continue}if(o===n){i+=n,c+=2;continue}i+=o??"",c+=2;continue}i+=l,c+=1}let a=r.slice(t,c);return s.push({message:"Unterminated string literal.",severity:"error",span:{start:e,end:_(e,a)},code:"lex/unterminated-string"}),{image:a,value:i}}function Ze(r,t){let e=Ae.exec(r.slice(t+3));if(!e)return null;let s=e[0],n=t+3+s.length;if(r[n]!==`
`)return null;let i=`
${s}>>>`,a=r.indexOf(i,n+1);if(a===-1)return null;let l=r.slice(t,a+i.length),o=r.slice(n+1,a);return{image:l,tag:s,body:o}}var Ge="1.0";function He(r){let t=Ne(r),e=new pe(r,t.tokens,t.diagnostics),s=e.parseProgram(),n=e.diagnostics;return s&&n.push(...je(s)),{ast:s,diagnostics:n}}var le=class le{constructor(t,e,s){this.source=t;this.tokens=e;this.index=0;this.diagnostics=s.slice()}parseProgram(){let t=this.peek();if(!this.consumeKeyword("mpd"))return null;let e=this.parseVersion();if(!e)return null;let s=[];if(this.matchKeyword("deck")){let c=this.parseDeck();c&&s.push(c)}else for(;!this.isAtEnd();){let c=this.parseTopLevelItem();if(!c)break;s.push(c)}let n=this.previous();return{type:"Program",version:e.value,body:s,span:f(t,n)}}parseDeck(){let t=this.consumeKeyword("deck");if(!t)return null;let e=this.parseOptionalName(),{items:s,end:n}=this.parseBlock(()=>this.parseDeckItem());return{type:"Deck",name:e??void 0,items:s,span:f(t,n)}}parseTopLevelItem(){return this.parseDeckItemInternal(!0)}parseDeckItem(){return this.parseDeckItemInternal(!1)}parseDeckItemInternal(t){if(this.isAtEnd())return null;let e=this.peek();if(e.type==="keyword"){let s=le.KEYWORD_ITEM_PARSERS[e.value];if(s)return s(this)}return e.type==="identifier"?this.parseUnknownBlock():(t&&this.error(e,"top-level declaration"),null)}parseUnknownBlock(){let t=this.consume("identifier");if(!t)return null;let e=this.consumePunct("{");if(!e)return null;let s=1;for(;!this.isAtEnd()&&s>0;){let i=this.peek();i.type==="punct"&&i.value==="{"?s+=1:i.type==="punct"&&i.value==="}"&&(s-=1),this.advance()}let n=this.previous(),c=this.source.slice(e.start.offset,n.end.offset);return{type:"UnknownBlock",name:t.value,content:c,span:f(t,n)}}parseMetaDecl(){let t=this.consumeKeyword("meta");if(!t)return null;let e=[];for(this.consumePunct("{");!this.isAtEnd()&&!this.matchPunct("}");){let n=this.parseMetaEntry();n&&e.push(n),this.matchPunct(",")&&this.consumePunct(",")}let s=this.consumePunct("}")??this.previous();return{type:"MetaDecl",entries:e,span:f(t,s)}}parseMetaEntry(){let t=this.consume("identifier");if(!t)return null;this.consumePunct(":");let e=this.parseExpr();return e?{type:"MetaEntry",key:t.value,value:e,span:f(t,this.previous())}:null}parseConstDecl(){let t=this.consumeKeyword("let");if(!t)return null;let e=this.consume("identifier");if(!e)return null;this.consumePunct("=");let s=this.parseExpr();return this.consumePunct(";"),{type:"ConstDecl",name:e.value,value:s??this.emptyLiteral(e),span:f(t,this.previous())}}parsePluginDecl(){let t=this.consumeKeyword("use");if(!t)return null;let e=this.parseName(),s;return this.peek().type==="punct"&&this.peek().value==="{"&&(s=this.parseObjectExpr()),this.consumePunct(";"),{type:"PluginDecl",ref:e,options:s,span:f(t,this.previous())}}parseDiagramDecl(){let t=this.consumeKeyword("diagram");if(!t)return null;let e=this.parseName(),{items:s,end:n}=this.parseBlock(()=>this.parseDiagramItem());return{type:"DiagramDecl",id:e,items:s.filter(c=>c!==null),span:f(t,n)}}parseDiagramItem(){let t=this.peek();if(t.type==="keyword")switch(t.value){case"mermaid":return this.parseMermaidSourceDecl();case"config":return this.parseMermaidConfigDecl();case"assets":return this.parseDiagramAssetsDecl();case"meta":return this.parseMetaDecl();default:break}return null}parseMermaidSourceDecl(){let t=this.consumeKeyword("mermaid");if(!t)return null;let e=this.consume("heredoc");return!e||!e.heredoc?null:(this.consumePunct(";"),{type:"MermaidSourceDecl",source:e.heredoc.body,tag:e.heredoc.tag,span:f(t,this.previous())})}parseMermaidConfigDecl(){let t=this.consumeKeyword("config");if(!t)return null;let e=this.parseObjectExpr();return this.consumePunct(";"),{type:"MermaidConfigDecl",config:e,span:f(t,this.previous())}}parseDiagramAssetsDecl(){let t=this.consumeKeyword("assets");if(!t)return null;let e=this.parseObjectExpr();return this.consumePunct(";"),{type:"DiagramAssetsDecl",assets:e,span:f(t,this.previous())}}parseRuntimeDecl(){let t=this.consumeKeyword("runtime");if(!t)return null;let{items:e,end:s}=this.parseBlock(()=>this.parseRuntimeItem());return{type:"RuntimeDecl",items:e.filter(n=>n!==null),span:f(t,s)}}parseRuntimeItem(){let t=this.peek();if(t.type==="keyword")switch(t.value){case"camera":return this.parseCameraDecl();case"overlay":return this.parseOverlayDecl();case"navigation":return this.parseNavigationDecl();case"performance":return this.parsePerformanceDecl();case"meta":return this.parseMetaDecl();default:break}return null}parseCameraDecl(){let t=this.consumeKeyword("camera");if(!t)return null;let{items:e,end:s}=this.parseBlock(()=>this.parseCameraItem());return{type:"CameraDecl",items:e.filter(n=>n!==null),span:f(t,s)}}parseCameraItem(){if(this.matchKeyword("engine")){let t=this.consumeKeyword("engine");this.consumePunct(":");let e=this.parseName();return this.consumePunct(";"),{type:"CameraEngine",name:e,span:f(t,this.previous())}}if(this.matchKeyword("options")){let t=this.consumeKeyword("options");this.consumePunct(":");let e=this.parseObjectExpr();return this.consumePunct(";"),{type:"CameraOptions",options:e,span:f(t,this.previous())}}if(this.matchKeyword("bounds")){let t=this.consumeKeyword("bounds");this.consumePunct(":");let s=this.consume("keyword")?.value??"viewport";return this.consumePunct(";"),{type:"CameraBounds",bounds:s,span:f(t,this.previous())}}return null}parseOverlayDecl(){let t=this.consumeKeyword("overlay");if(!t)return null;let{items:e,end:s}=this.parseBlock(()=>this.parseOverlayItem());return{type:"OverlayDecl",items:e.filter(n=>n!==null),span:f(t,s)}}parseOverlayItem(){if(this.matchKeyword("engine")){let t=this.consumeKeyword("engine");this.consumePunct(":");let e=this.parseName();return this.consumePunct(";"),{type:"OverlayEngine",name:e,span:f(t,this.previous())}}if(this.matchKeyword("options")){let t=this.consumeKeyword("options");this.consumePunct(":");let e=this.parseObjectExpr();return this.consumePunct(";"),{type:"OverlayOptions",options:e,span:f(t,this.previous())}}return null}parseNavigationDecl(){let t=this.consumeKeyword("navigation");if(!t)return null;let{items:e,end:s}=this.parseBlock(()=>this.parseNavigationItem());return{type:"NavigationDecl",items:e.filter(n=>n!==null),span:f(t,s)}}parseNavigationItem(){if(this.matchKeyword("keys")){let t=this.consumeKeyword("keys");this.consumePunct(":");let e=this.parseObjectExpr();return this.consumePunct(";"),{type:"NavigationKeys",options:e,span:f(t,this.previous())}}if(this.matchKeyword("wheelZoom")){let t=this.consumeKeyword("wheelZoom");this.consumePunct(":");let e=this.parseBoolean();return this.consumePunct(";"),{type:"NavigationWheelZoom",value:e,span:f(t,this.previous())}}if(this.matchKeyword("dragPan")){let t=this.consumeKeyword("dragPan");this.consumePunct(":");let e=this.parseBoolean();return this.consumePunct(";"),{type:"NavigationDragPan",value:e,span:f(t,this.previous())}}if(this.matchKeyword("tapToAdvance")){let t=this.consumeKeyword("tapToAdvance");this.consumePunct(":");let e=this.parseBoolean();return this.consumePunct(";"),{type:"NavigationTapToAdvance",value:e,span:f(t,this.previous())}}if(this.matchKeyword("progressUI")){let t=this.consumeKeyword("progressUI");this.consumePunct(":");let e=this.parseBoolean();return this.consumePunct(";"),{type:"NavigationProgressUI",value:e,span:f(t,this.previous())}}if(this.matchKeyword("startAt")){let t=this.consumeKeyword("startAt");this.consumePunct(":");let e=this.peek(),s=0;return e.type==="int"||e.type==="number"?(this.advance(),s=Number(e.value)):e.type==="string"?(this.advance(),s=e.value):this.error(e,"number or string"),this.consumePunct(";"),{type:"NavigationStartAt",value:s,span:f(t,this.previous())}}return null}parsePerformanceDecl(){let t=this.consumeKeyword("performance");if(!t)return null;let e=this.parseObjectExpr();return this.consumePunct(";"),{type:"PerformanceDecl",options:e,span:f(t,this.previous())}}parseSelectorsDecl(){let t=this.consumeKeyword("selectors");if(!t)return null;let{items:e,end:s}=this.parseBlock(()=>this.parseSelectorsItem());return{type:"SelectorsDecl",items:e.filter(n=>n!==null),span:f(t,s)}}parseSelectorsItem(){if(this.matchKeyword("strategy")){let t=this.consumeKeyword("strategy");this.consumePunct(":");let s=this.consume("keyword")?.value??"css";return this.consumePunct(";"),{type:"SelectorsStrategy",strategy:s,span:f(t,this.previous())}}if(this.matchKeyword("fallback")){let t=this.consumeKeyword("fallback");this.consumePunct(":");let e=this.parseArrayExpr();return this.consumePunct(";"),{type:"SelectorsFallback",fallback:e,span:f(t,this.previous())}}if(this.matchKeyword("node")){let t=this.consumeKeyword("node");this.consumePunct(":");let e=this.parseObjectExpr();return this.consumePunct(";"),{type:"SelectorsNode",spec:e,span:f(t,this.previous())}}if(this.matchKeyword("edge")){let t=this.consumeKeyword("edge");this.consumePunct(":");let e=this.parseObjectExpr();return this.consumePunct(";"),{type:"SelectorsEdge",spec:e,span:f(t,this.previous())}}if(this.matchKeyword("subgraph")){let t=this.consumeKeyword("subgraph");this.consumePunct(":");let e=this.parseObjectExpr();return this.consumePunct(";"),{type:"SelectorsSubgraph",spec:e,span:f(t,this.previous())}}return this.matchKeyword("meta")?this.parseMetaDecl():null}parseStylesDecl(){let t=this.consumeKeyword("styles");if(!t)return null;let{items:e,end:s}=this.parseBlock(()=>this.parseStylesItem());return{type:"StylesDecl",items:e.filter(n=>n!==null),span:f(t,s)}}parseStylesItem(){if(this.matchKeyword("classes")){let t=this.consumeKeyword("classes");this.consumePunct(":");let e=this.parseObjectExpr();return this.consumePunct(";"),{type:"StylesClasses",classes:e,span:f(t,this.previous())}}if(this.matchKeyword("spotlight")){let t=this.consumeKeyword("spotlight");this.consumePunct(":");let e=this.parseObjectExpr();return this.consumePunct(";"),{type:"StylesSpotlight",spotlight:e,span:f(t,this.previous())}}if(this.matchKeyword("theme")){let t=this.consumeKeyword("theme");this.consumePunct(":");let e=this.parseName();return this.consumePunct(";"),{type:"StylesTheme",theme:e,span:f(t,this.previous())}}return this.matchKeyword("meta")?this.parseMetaDecl():null}parseSceneDecl(){let t=this.consumeKeyword("scene");if(!t)return null;let e=this.parseName(),s;this.matchKeyword("diagram")&&(this.consumeKeyword("diagram"),s=this.parseName());let{items:n,end:c}=this.parseBlock(()=>this.parseSceneItem());return{type:"SceneDecl",name:e,diagram:s,items:n.filter(i=>i!==null),span:f(t,c)}}parseSceneItem(){let t=this.peek();if(t.type==="keyword")switch(t.value){case"step":return this.parseStepDecl();case"binding":return this.parseBindingDecl();case"meta":return this.parseMetaDecl();case"let":return this.parseConstDecl();default:break}return null}parseStepDecl(){let t=this.consumeKeyword("step");if(!t)return null;let e=this.parseName(),s;this.matchKeyword("as")&&(this.consumeKeyword("as"),s=this.consume("identifier")?.value);let{items:n,end:c}=this.parseBlock(()=>this.parseStepStmt());return{type:"StepDecl",name:e,alias:s,statements:n.filter(i=>i!==null),span:f(t,c)}}parseStepStmt(){let t=this.peek();if(t.type==="keyword")switch(t.value){case"focus":return this.parseFocusStmt();case"do":return this.parseDoStmt();case"let":return this.parseLetStmt();case"assert":return this.parseAssertStmt();case"meta":return this.parseMetaDecl();default:break}if(t.type==="identifier"||t.type==="keyword"){if(t.type==="keyword"&&(t.value==="focus"||t.value==="let"||t.value==="assert"||t.value==="meta"))return null;let e=this.parseActionCall();if(e)return{type:"DoStmt",action:e,span:e.span}}return null}parseFocusStmt(){let t=this.consumeKeyword("focus");if(!t)return null;let e=this.parseTargetExpr(),s={};for(;;){if(this.matchKeyword("pad")){this.consumeKeyword("pad");let n=this.parseNumber();s.pad=n;continue}if(this.matchKeyword("align")){this.consumeKeyword("align");let n=this.consume("keyword");s.align=n?.value??"center";continue}if(this.matchKeyword("lock")){this.consumeKeyword("lock");let n=this.consume("keyword");s.lock=n?.value??"none";continue}if(this.matchKeyword("id")){this.consumeKeyword("id");let n=this.consume("identifier");n&&(s.id=n.value);continue}break}return this.consumePunct(";"),{type:"FocusStmt",target:e??this.emptyTarget(t),options:s,span:f(t,this.previous())}}parseDoStmt(){let t=this.consumeKeyword("do");if(!t)return null;let e=this.parseActionCall();return this.consumePunct(";"),{type:"DoStmt",action:e??this.emptyAction(t),span:f(t,this.previous())}}parseLetStmt(){let t=this.consumeKeyword("let");if(!t)return null;let e=this.consume("identifier");this.consumePunct("=");let s=this.parseExpr();return this.consumePunct(";"),{type:"LetStmt",name:e?.value??"",value:s??this.emptyLiteral(t),span:f(t,this.previous())}}parseAssertStmt(){let t=this.consumeKeyword("assert");if(!t)return null;let e=this.parseExpr(),s;return this.matchKeyword("else")&&(this.consumeKeyword("else"),s=this.consume("string")?.value),this.consumePunct(";"),{type:"AssertStmt",condition:e??this.emptyLiteral(t),message:s,span:f(t,this.previous())}}parseBindingDecl(){let t=this.consumeKeyword("binding");if(!t)return null;let e;(this.peek().type==="identifier"||this.peek().type==="string")&&(e=this.parseName());let s;if(this.matchKeyword("priority")){this.consumeKeyword("priority");let i=this.consume("int");s=i?Number(i.value):void 0,this.consumePunct(";")}let{items:n,end:c}=this.parseBlock(()=>this.parseBindingRule());return{type:"BindingDecl",name:e,priority:s,rules:n.filter(i=>i!==null),span:f(t,c)}}parseBindingRule(){let t=this.consumeKeyword("on");if(!t)return null;let e=this.parseEventSpec(),s;this.matchKeyword("target")&&(this.consumeKeyword("target"),this.matchKeyword("any")?(this.consumeKeyword("any"),s="any"):s=this.parseTargetExpr()??void 0);let n;this.matchKeyword("when")&&(this.consumeKeyword("when"),n=this.parseExpr()??void 0);let{items:c,end:i}=this.parseBlock(()=>this.parseBindingStmt());return{type:"BindingRule",event:e??this.emptyEvent(t),target:s,when:n,statements:c.filter(a=>a!==null),span:f(t,i)}}parseBindingStmt(){return this.matchKeyword("do")?this.parseDoStmt():this.matchKeyword("let")?this.parseLetStmt():this.matchKeyword("assert")?this.parseAssertStmt():null}parseEventSpec(){let t=this.consume("keyword");if(!t)return null;if(t.value==="key")return{type:"EventSpec",kind:"key",value:this.consume("string")?.value,span:f(t,this.previous())};if(t.value==="timer"){let e=this.consume("duration");return{type:"EventSpec",kind:"timer",value:e?De(e.value):void 0,span:f(t,this.previous())}}return t.value==="custom"?{type:"EventSpec",kind:"custom",value:this.parseName().value,span:f(t,this.previous())}:{type:"EventSpec",kind:t.value,span:f(t,t)}}parseActionCall(){let t=this.peek(),e=[],s=this.consumeNamePart();if(!s)return null;for(e.push(s.value);!this.isAtEnd();){if(this.matchPunct(".")){this.consumePunct(".");let i=this.consumeNamePart();i&&e.push(i.value);continue}let c=this.peek();if(c.type==="identifier"||c.type==="keyword"){let i=this.peekNext();if(i.type==="punct"&&i.value==="("){let l=this.consumeNamePart();l&&e.push(l.value);break}let a=this.consumeNamePart();a&&e.push(a.value);continue}break}this.consumePunct("(");let n=[];if(!this.matchPunct(")"))do{let c=this.parseActionArg();c&&n.push(c)}while(this.matchPunct(",")&&this.advance());return this.consumePunct(")"),{type:"ActionCall",name:e.join(" "),args:n,span:f(t,this.previous())}}parseActionArg(){let t=this.peek(),e=this.peek();if((e.type==="identifier"||e.type==="keyword")&&this.peekNext().type==="punct"&&this.peekNext().value===":"){let n=this.advance();this.consumePunct(":");let c=this.parseExpr();return{type:"ActionArg",key:n?.value,value:c??this.emptyLiteral(t),span:f(t,this.previous())}}return{type:"ActionArg",value:this.parseExpr()??this.emptyLiteral(t),span:f(t,this.previous())}}parseExpr(){return this.parseOrExpr()}parseOrExpr(){let t=this.parseAndExpr();for(;this.matchKeyword("or");){let e=this.consumeKeyword("or"),s=this.parseAndExpr();t={type:"BinaryExpr",operator:"or",left:t??this.emptyLiteral(e),right:s??this.emptyLiteral(e),span:f(e,this.previous())}}return t}parseAndExpr(){let t=this.parseEqExpr();for(;this.matchKeyword("and");){let e=this.consumeKeyword("and"),s=this.parseEqExpr();t={type:"BinaryExpr",operator:"and",left:t??this.emptyLiteral(e),right:s??this.emptyLiteral(e),span:f(e,this.previous())}}return t}parseEqExpr(){let t=this.parseRelExpr();for(;this.matchOperator("==")||this.matchOperator("!=");){let e=this.consume("operator"),s=this.parseRelExpr();t={type:"BinaryExpr",operator:e.value,left:t??this.emptyLiteral(e),right:s??this.emptyLiteral(e),span:f(e,this.previous())}}return t}parseRelExpr(){let t=this.parseAddExpr();for(;this.matchOperator("<")||this.matchOperator("<=")||this.matchOperator(">")||this.matchOperator(">=");){let e=this.consume("operator"),s=this.parseAddExpr();t={type:"BinaryExpr",operator:e.value,left:t??this.emptyLiteral(e),right:s??this.emptyLiteral(e),span:f(e,this.previous())}}return t}parseAddExpr(){let t=this.parseMulExpr();for(;this.matchOperator("+")||this.matchOperator("-");){let e=this.consume("operator"),s=this.parseMulExpr();t={type:"BinaryExpr",operator:e.value,left:t??this.emptyLiteral(e),right:s??this.emptyLiteral(e),span:f(e,this.previous())}}return t}parseMulExpr(){let t=this.parseUnaryExpr();for(;this.matchOperator("*")||this.matchOperator("/")||this.matchOperator("%");){let e=this.consume("operator"),s=this.parseUnaryExpr();t={type:"BinaryExpr",operator:e.value,left:t??this.emptyLiteral(e),right:s??this.emptyLiteral(e),span:f(e,this.previous())}}return t}parseUnaryExpr(){if(this.matchOperator("!")||this.matchOperator("-")){let t=this.consume("operator"),e=this.parseUnaryExpr();return{type:"UnaryExpr",operator:t.value,argument:e??this.emptyLiteral(t),span:f(t,this.previous())}}return this.parsePrimaryExpr()}parsePrimaryExpr(){let t=this.peek();if(t.type==="number"||t.type==="int"||t.type==="duration"||t.type==="percent"||t.type==="boolean"||t.type==="null"||t.type==="string"||t.type==="color")return this.advance(),this.literalFromToken(t);if(t.type==="punct"&&t.value==="{")return this.parseObjectExpr();if(t.type==="punct"&&t.value==="[")return this.parseArrayExpr();if(t.type==="punct"&&t.value==="("){let e=this.consumePunct("("),s=this.parseExpr();return this.consumePunct(")"),s?{...s,span:f(e,this.previous())}:null}return t.type==="punct"&&t.value==="$"?this.parseVarRef():this.isTargetKeyword(t)?this.parseTargetExpr():t.type==="identifier"?this.parseCallExpr():null}parseVarRef(){let t=this.consumePunct("$"),e=[],s=this.consume("identifier");for(s&&e.push(s.value);this.matchPunct(".");){this.consumePunct(".");let n=this.consume("identifier");n&&e.push(n.value)}return{type:"VarRef",path:e,span:f(t,this.previous())}}parseCallExpr(){let t=this.peek(),e=this.consume("identifier");if(!e)return null;this.consumePunct("(");let s=[];if(!this.matchPunct(")"))do{let n=this.parseActionArg();n&&s.push(n)}while(this.matchPunct(",")&&this.advance());return this.consumePunct(")"),{type:"CallExpr",name:e.value,args:s,span:f(t,this.previous())}}parseObjectExpr(){let t=this.consumePunct("{"),e=[];if(!this.matchPunct("}"))do{let s=this.peek(),n=s.type==="identifier"||s.type==="keyword"?this.advance():this.consume("string");if(!n)break;this.consumePunct(":");let c=this.parseExpr(),i=n.type==="string"?n.value.slice(1,-1):n.value;e.push({type:"ObjectEntry",key:i,value:c??this.emptyLiteral(n),span:f(n,this.previous())})}while(this.matchPunct(",")&&this.advance());return this.consumePunct("}"),{type:"ObjectExpr",entries:e,span:f(t,this.previous())}}parseArrayExpr(){let t=this.consumePunct("["),e=[];if(!this.matchPunct("]"))do{let s=this.parseExpr();s&&e.push(s)}while(this.matchPunct(",")&&this.advance());return this.consumePunct("]"),{type:"ArrayExpr",items:e,span:f(t,this.previous())}}parseTargetExpr(){let t=this.peek();if(!this.isTargetKeyword(t))return this.error(t,"target expression"),null;let e=this.consume("keyword");if(!e)return null;switch(e.value){case"node":return this.parseTargetUnary(e,"TargetNode",()=>this.parseNodeRef());case"edge":return this.parseTargetUnary(e,"TargetEdge",()=>this.parseEdgeRef());case"subgraph":return this.parseTargetUnary(e,"TargetSubgraph",()=>this.parseSubgraphRef());case"css":return this.parseTargetString(e,"TargetCss");case"id":return this.parseTargetString(e,"TargetId");case"text":return this.parseTargetString(e,"TargetText");case"group":return this.parseTargetList(e,"TargetGroup");case"union":return this.parseTargetList(e,"TargetUnion");case"intersect":return this.parseTargetList(e,"TargetIntersect");case"except":return this.parseTargetExcept(e);default:return null}}parseTargetUnary(t,e,s){this.consumePunct("(");let n=s();return this.consumePunct(")"),{type:e,ref:n,span:f(t,this.previous())}}parseTargetString(t,e){this.consumePunct("(");let s=this.consume("string");this.consumePunct(")");let n=s?.value??"";return e==="TargetCss"?{type:"TargetCss",selector:n,span:f(t,this.previous())}:e==="TargetId"?{type:"TargetId",id:n,span:f(t,this.previous())}:{type:"TargetText",text:n,span:f(t,this.previous())}}parseTargetList(t,e){this.consumePunct("(");let s=[];if(!this.matchPunct(")"))do{let c=this.parseTargetExpr();c&&s.push(c)}while(this.matchPunct(",")&&this.advance());return this.consumePunct(")"),{type:e,targets:s,span:f(t,this.previous())}}parseTargetExcept(t){this.consumePunct("(");let e=this.parseTargetExpr();this.consumePunct(",");let s=this.parseTargetExpr();return this.consumePunct(")"),{type:"TargetExcept",left:e??this.emptyTarget(t),right:s??this.emptyTarget(t),span:f(t,this.previous())}}parseNodeRef(){if(this.matchOperator("*"))return this.consume("operator"),"*";if(this.peek().type==="string"){let e=this.consume("string");return this.makeName(e)}let t=this.consume("identifier");return t?this.makeName(t):"*"}parseEdgeRef(){let t=this.peek(),e=this.parseNodeRef();if(this.matchPunct(",")){this.consumePunct(",");let s=this.parseNodeRef();return{from:e,to:s}}return e==="*"?{type:"Name",value:"*",kind:"identifier",span:f(t,this.previous())}:e}parseSubgraphRef(){if(this.matchOperator("*"))return this.consume("operator"),"*";if(this.peek().type==="string"){let e=this.consume("string");return this.makeName(e)}let t=this.consume("identifier");return t?this.makeName(t):"*"}parseQualifiedName(){let t=[],e=this.consumeNamePart();for(e&&t.push(e.value);this.matchPunct(".");){this.consumePunct(".");let s=this.consumeNamePart();s&&t.push(s.value)}return t.join(".")}consumeNamePart(){let t=this.peek();return t.type==="identifier"||t.type==="keyword"?this.advance():(this.error(t,"identifier"),null)}parseName(){let t=this.peek();if(t.type==="string")return this.advance(),{type:"Name",value:t.value,kind:"string",span:f(t,t)};let e=this.consume("identifier");return{type:"Name",value:e?.value??"",kind:"identifier",span:f(e??t,this.previous())}}parseOptionalName(){let t=this.peek();return t.type==="identifier"||t.type==="string"?this.parseName():null}parseNumber(){let t=this.consume("number")??this.consume("int");return t?Number(t.value):0}parseBoolean(){let t=this.consume("boolean");return t?t.value==="true":!1}parseVersion(){let t=this.consume("number")??this.consume("int");if(!t)return null;let e=[t.value];for(;this.matchPunct(".");){this.consumePunct(".");let s=this.consume("number")??this.consume("int");if(!s)break;e.push(s.value)}return{value:e.join("."),end:this.previous()}}parseBlock(t){let e=[],s=this.consumePunct("{");for(;!this.isAtEnd()&&!this.matchPunct("}");){let c=t();c?e.push(c):this.advance()}let n=this.consumePunct("}")??this.previous();return{items:e,end:n??s}}literalFromToken(t){let e=t.value;return t.type==="boolean"?{type:"Literal",literalType:"boolean",value:t.value==="true",raw:e,span:f(t,t)}:t.type==="null"?{type:"Literal",literalType:"null",value:null,raw:e,span:f(t,t)}:t.type==="string"?{type:"Literal",literalType:"string",value:t.value,raw:e,span:f(t,t)}:t.type==="color"?{type:"Literal",literalType:"color",value:t.value,raw:e,span:f(t,t)}:t.type==="duration"?{type:"Literal",literalType:"duration",value:De(t.value),raw:e,span:f(t,t)}:t.type==="percent"?{type:"Literal",literalType:"percent",value:Number(t.value.replace("%","")),raw:e,span:f(t,t)}:{type:"Literal",literalType:t.type==="int"?"int":"number",value:Number(t.value),raw:e,span:f(t,t)}}emptyLiteral(t){return{type:"Literal",literalType:"null",value:null,raw:"null",span:f(t,t)}}emptyTarget(t){return{type:"TargetNode",ref:"*",span:f(t,t)}}emptyAction(t){return{type:"ActionCall",name:"",args:[],span:f(t,t)}}emptyEvent(t){return{type:"EventSpec",kind:"click",span:f(t,t)}}makeName(t){return{type:"Name",value:t.value,kind:t.type==="string"?"string":"identifier",span:f(t,t)}}isTargetKeyword(t){return t.type==="keyword"&&["node","edge","subgraph","css","id","text","group","union","intersect","except"].includes(t.value)}matchKeyword(t){let e=this.peek();return e.type==="keyword"&&e.value===t}matchOperator(t){let e=this.peek();return e.type==="operator"&&e.value===t}matchPunct(t){let e=this.peek();return e.type==="punct"&&e.value===t}consumeKeyword(t){let e=this.peek();return e.type==="keyword"&&e.value===t?this.advance():(this.error(e,`keyword '${t}'`),null)}consumePunct(t){let e=this.peek();return e.type==="punct"&&e.value===t?this.advance():(this.error(e,`symbol '${t}'`),null)}consume(t){let e=this.peek();return e.type===t?this.advance():(this.error(e,t),null)}error(t,e){if(t.type==="eof"){this.diagnostics.push({message:`Unexpected end of input, expected ${e}.`,severity:"error",span:f(t,t),code:"parse/unexpected-eof"});return}this.diagnostics.push({message:`Unexpected '${t.image||t.value}', expected ${e}.`,severity:"error",span:f(t,t),code:"parse/unexpected-token"})}advance(){return this.isAtEnd()||(this.index+=1),this.tokens[this.index-1]}peek(){return this.tokens[this.index]}peekNext(){return this.tokens[this.index+1]}previous(){return this.tokens[Math.max(0,this.index-1)]}isAtEnd(){return this.peek().type==="eof"}};le.KEYWORD_ITEM_PARSERS={diagram:t=>t.parseDiagramDecl(),runtime:t=>t.parseRuntimeDecl(),selectors:t=>t.parseSelectorsDecl(),styles:t=>t.parseStylesDecl(),let:t=>t.parseConstDecl(),scene:t=>t.parseSceneDecl(),binding:t=>t.parseBindingDecl(),use:t=>t.parsePluginDecl(),meta:t=>t.parseMetaDecl()};var pe=le;function f(r,t){return{start:r.start,end:t.end}}function De(r){return r.endsWith("ms")?Number(r.replace("ms","")):r.endsWith("s")?Number(r.replace("s",""))*1e3:r.endsWith("m")?Number(r.replace("m",""))*6e4:Number(r)}function je(r){let t=[];r.version!==Ge&&r.version!=="1"&&t.push({message:`MPD version '${r.version}' differs from supported version ${Ge}.`,severity:"warning",span:r.span,code:"validate/version-mismatch"});for(let n of r.body){if(n.type==="SceneDecl"){let c=new Set;for(let i of n.items)if(i.type==="StepDecl"){let a=i.name.value;c.has(a)?t.push({message:`Duplicate step name '${a}' in scene '${n.name.value}'.`,severity:"error",span:i.span,code:"validate/duplicate-step"}):c.add(a)}}n.type==="UnknownBlock"&&t.push({message:`Unknown block '${n.name}'.`,severity:"warning",span:n.span,code:"validate/unknown-block"})}let e=n=>{switch(n.type){case"TargetEdge":{let c=n.ref;typeof c=="object"&&(c.from==="*"||c.to==="*")&&t.push({message:"Edge target cannot use '*' in edge tuple.",severity:"error",span:n.span,code:"validate/malformed-target"});break}case"TargetCss":case"TargetId":case"TargetText":{(n.selector??n.id??n.text??"")||t.push({message:"Target string cannot be empty.",severity:"error",span:n.span,code:"validate/malformed-target"});break}case"TargetGroup":case"TargetUnion":case"TargetIntersect":n.targets.forEach(e);break;case"TargetExcept":e(n.left),e(n.right);break;case"BinaryExpr":e(n.left),e(n.right);break;case"UnaryExpr":e(n.argument);break;case"ObjectExpr":n.entries.forEach(c=>e(c.value));break;case"ArrayExpr":n.items.forEach(e);break;case"CallExpr":n.args.forEach(c=>e(c.value));break;case"Literal":case"VarRef":case"TargetNode":case"TargetSubgraph":break;default:break}},s=n=>{if(!n||typeof n!="object")return;switch(n.type){case"StepDecl":{n.statements.forEach(s);break}case"SceneDecl":{n.items.forEach(s);break}case"FocusStmt":e(n.target);break;case"LetStmt":e(n.value);break;case"AssertStmt":e(n.condition);break;case"DoStmt":n.action.args.forEach(i=>e(i.value));break;case"BindingDecl":n.rules.forEach(s);break;case"BindingRule":{let i=n;i.when&&e(i.when),i.statements.forEach(s);break}case"ConstDecl":e(n.value);break;case"MetaDecl":n.entries.forEach(i=>e(i.value));break;default:break}};return r.body.forEach(s),t}function We(r){return r.length?r.map(t=>{let e=t.span?`(${t.span.start.line}:${t.span.start.column})`:"",s=t.code?` [${t.code}]`:"";return`${t.severity.toUpperCase()}: ${t.message} ${e}${s}`.trim()}).join(`
`):"No diagnostics."}var Ue=r=>{if(r.ast)return r.ast;if(r.mpdText&&r.options?.parseMpd)return r.options.parseMpd(r.mpdText);throw new z("presentMermaid requires ast or mpdText with parseMpd","MPF_INVALID_PRESENT_OPTIONS")},Dn=async r=>{let t=Ue(r),s=await(r.options?.diagram??xe()).render({mountEl:r.mountEl,mermaidText:r.mermaidText}),n=r.options?.camera??fe(s),c=r.options?.overlay??ye(),i=new ce({diagram:s,camera:n,overlay:c,ast:t,actionHandlers:r.options?.actionHandlers,errorPolicy:r.options?.errorPolicy??"haltOnError",hooks:r.options?.hooks});return await i.init({diagram:s}),i};export{K as ActionError,z as MPFError,ue as ParseError,fe as createBasicCameraHandle,ye as createBasicOverlayHandle,xe as createMermaidDiagramAdapter,hn as createMockCameraHandle,pn as createMockDiagramHandle,gn as createMockOverlayHandle,We as formatDiagnostics,He as parseMPD,Dn as presentMermaid};
