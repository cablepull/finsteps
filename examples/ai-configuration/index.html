<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finsteps AI Model Configuration</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@11.12.2/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 2rem;
            padding: 2rem;
        }

        .config-panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            height: fit-content;
        }

        .config-section {
            margin-bottom: 2rem;
        }

        .config-section h3 {
            color: #333;
            margin-bottom: 1rem;
            font-size: 1.2rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 0.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #555;
        }

        select, textarea, input[type="text"], input[type="number"], input[type="password"] {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 0.95rem;
            transition: border-color 0.3s ease;
        }

        select:focus, textarea:focus, input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
            font-family: 'Courier New', monospace;
        }

        .model-list {
            background: white;
            border-radius: 6px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .model-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: #f8f9fa;
            border-radius: 6px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .model-item:hover {
            border-color: #667eea;
            transform: translateY(-1px);
        }

        .model-item.selected {
            border-color: #667eea;
            background: #e7f3ff;
        }

        .model-info {
            flex: 1;
        }

        .model-name {
            font-weight: 600;
            color: #333;
        }

        .model-provider {
            font-size: 0.85rem;
            color: #666;
            margin-top: 0.25rem;
        }

        .model-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #28a745;
        }

        .model-status.disabled {
            background: #dc3545;
        }

        .auto-detected-badge {
            font-size: 0.75rem;
            margin-left: 0.5rem;
            opacity: 0.7;
        }

        .chat-panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            height: 600px;
        }

        .chat-header {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: white;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .message {
            margin-bottom: 1.5rem;
        }

        .message.user {
            text-align: right;
        }

        .message-content {
            display: inline-block;
            padding: 0.75rem 1rem;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message.user .message-content {
            background: #667eea;
            color: white;
        }

        .message.assistant .message-content {
            background: #e9ecef;
            color: #333;
        }

        .chat-input {
            background: white;
            border-radius: 6px;
            padding: 1rem;
            display: flex;
            gap: 1rem;
        }

        .chat-input textarea {
            flex: 1;
            margin: 0;
            min-height: 50px;
            border: 2px solid #e9ecef;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-group {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .status-indicator {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .preset-templates {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .template-btn {
            padding: 0.5rem;
            font-size: 0.85rem;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .template-btn:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .config-panel {
                order: 2;
            }
            
            .chat-panel {
                order: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ü§ñ AI Model Configuration</h1>
            <p>Configure and test AI models for Finsteps presentations</p>
        </header>

        <div class="main-content">
            <aside class="config-panel">
                <div class="config-section">
                    <h3>Available Models</h3>
                    <div id="model-list" class="model-list">
                        <div class="loading" id="loading-models"></div>
                    </div>
                </div>

                <div class="config-section">
                    <h3>Model Configuration</h3>
                    <div class="form-group">
                        <label for="model-select">Selected Model:</label>
                        <select id="model-select">
                            <option value="">Select a model...</option>
                        </select>
                    </div>

                    <div class="form-group" id="api-key-group" style="display: none;">
                        <label for="api-key">API Key:</label>
                        <input type="password" id="api-key" placeholder="Enter API key...">
                    </div>

                    <div class="form-group">
                        <label for="temperature">Temperature (0-1):</label>
                        <input type="number" id="temperature" min="0" max="1" step="0.1" value="0.7">
                    </div>

                    <div class="form-group">
                        <label for="max-tokens">Max Tokens:</label>
                        <input type="number" id="max-tokens" min="1" max="8000" value="2048">
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary" id="save-config">Save Config</button>
                        <button class="btn btn-secondary" id="test-connection">Test Connection</button>
                    </div>
                </div>

                <div class="config-section">
                    <h3>Quick Templates</h3>
                    <div class="preset-templates">
                        <button class="template-btn" data-template="generate-mpd">Generate MPD</button>
                        <button class="template-btn" data-template="mermaid-generator">Mermaid Diagram</button>
                        <button class="template-btn" data-template="explain-concept">Explain Concept</button>
                        <button class="template-btn" data-template="code-review">Code Review</button>
                        <button class="template-btn" data-template="creative-presentation">Creative Ideas</button>
                        <div style="grid-column: 1 / -1; margin-top: 0.5rem; font-size: 0.85rem; color: #666;">
                            üí° Templates include BNF grammar and best practices
                        </div>
                    </div>
                </div>

                <div class="config-section">
                    <h3>Ollama Status</h3>
                    <div id="ollama-status">
                        <span class="status-indicator status-warning">Checking...</span>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-success" id="detect-ollama">Detect Models</button>
                        <button class="btn btn-warning" id="pull-model">Pull Model</button>
                    </div>
                </div>
            </aside>

            <main class="chat-panel">
                <div class="chat-header">
                    <h3>üí¨ AI Chat Interface</h3>
                    <div id="current-model-info">
                        <span class="status-indicator status-warning">No model selected</span>
                    </div>
                </div>

                <div class="chat-messages" id="chat-messages">
                    <div class="message assistant">
                        <div class="message-content">
                            üëã Welcome! Select a model and start chatting. I can help you generate MPD code, create Mermaid diagrams, explain concepts, or build presentations.

                            üí° <strong>Try mentioning:</strong> MPD, Mermaid, diagram, flowchart, sequence, class, gantt, state, or presentation to get expert help with BNF grammar included!
                        </div>
                    </div>
                </div>

                <div class="chat-input">
                    <textarea id="chat-input" placeholder="Type your message here..." rows="2"></textarea>
                    <button class="btn btn-primary" id="send-message">Send</button>
                </div>
            </main>
        </div>
    </div>

    <script type="module">
        // Import Finsteps AI module
        import { modelManager } from '../../dist/ai/index.js';

        // Initialize Mermaid
        mermaid.initialize({ startOnLoad: false, theme: 'dark' });

        // Global state
        let currentModel = null;
        let chatHistory = [];

        // DOM elements
        const elements = {
            modelList: document.getElementById('model-list'),
            modelSelect: document.getElementById('model-select'),
            apiKeyGroup: document.getElementById('api-key-group'),
            apiKey: document.getElementById('api-key'),
            temperature: document.getElementById('temperature'),
            maxTokens: document.getElementById('max-tokens'),
            chatMessages: document.getElementById('chat-messages'),
            chatInput: document.getElementById('chat-input'),
            sendButton: document.getElementById('send-message'),
            currentModelInfo: document.getElementById('current-model-info'),
            ollamaStatus: document.getElementById('ollama-status'),
            loadingModels: document.getElementById('loading-models')
        };

        // Initialize the application
        async function init() {
            setupEventListeners();
            await loadModels(); // This will auto-detect Ollama models
            await checkOllamaStatus();
        }

        // Load available models and auto-detect Ollama models
        async function loadModels() {
            try {
                elements.loadingModels.style.display = 'block';
                
                // First, try to auto-detect and add Ollama models
                await autoDetectAndAddOllamaModels();
                
                const models = modelManager.getAvailableModels();
                const modelsHTML = models.map(model => {
                    const isAutoDetected = model.provider === 'ollama' && model.id.startsWith('ollama-');
                    return `
                        <div class="model-item ${model.enabled ? '' : 'disabled'}" data-model-id="${model.id}">
                            <div class="model-info">
                                <div class="model-name">
                                    ${model.name}
                                    ${isAutoDetected ? '<span class="auto-detected-badge">üîç</span>' : ''}
                                </div>
                                <div class="model-provider">${model.provider} ‚Ä¢ ${model.model}</div>
                            </div>
                            <div class="model-status ${model.enabled ? '' : 'disabled'}"></div>
                        </div>
                    `;
                }).join('');

                elements.modelList.innerHTML = modelsHTML;
                
                // Populate model select dropdown
                elements.modelSelect.innerHTML = '<option value="">Select a model...</option>' +
                    models.map(model => `
                        <option value="${model.id}">${model.name} (${model.provider})</option>
                    `).join('');

                elements.loadingModels.style.display = 'none';

            } catch (error) {
                console.error('Failed to load models:', error);
                elements.modelList.innerHTML = '<div class="status-indicator status-error">Failed to load models</div>';
                elements.loadingModels.style.display = 'none';
            }
        }

        // Auto-detect and add Ollama models to the model manager
        async function autoDetectAndAddOllamaModels() {
            try {
                const detectedModels = await modelManager.detectOllamaModels();
                console.log('Detected Ollama models:', detectedModels);
                
                for (const modelName of detectedModels) {
                    // Generate a safe ID from the model name
                    const modelId = `ollama-${modelName.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase()}`;
                    
                    // Check if model already exists
                    if (!modelManager.getModel(modelId)) {
                        // Add the detected model to the manager
                        modelManager.addModel({
                            id: modelId,
                            name: `${modelName} (Ollama)`,
                            provider: 'ollama',
                            model: modelName,
                            baseUrl: 'http://localhost:11434',
                            maxTokens: 4096,
                            temperature: 0.7,
                            enabled: true
                        });
                        console.log(`Added detected Ollama model: ${modelName} as ${modelId}`);
                    }
                }
                
                return detectedModels;
            } catch (error) {
                console.warn('Failed to auto-detect Ollama models:', error);
                return [];
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Model selection
            elements.modelSelect.addEventListener('change', (e) => {
                const modelId = e.target.value;
                if (modelId) {
                    selectModel(modelId);
                } else {
                    currentModel = null;
                    updateModelInfo();
                }
            });

            // Model list click
            elements.modelList.addEventListener('click', (e) => {
                const modelItem = e.target.closest('.model-item');
                if (modelItem) {
                    const modelId = modelItem.dataset.modelId;
                    elements.modelSelect.value = modelId;
                    selectModel(modelId);
                }
            });

            // Chat input
            elements.sendButton.addEventListener('click', sendMessage);
            elements.chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Configuration buttons
            document.getElementById('save-config').addEventListener('click', saveConfiguration);
            document.getElementById('test-connection').addEventListener('click', testConnection);

            // Ollama buttons
            document.getElementById('detect-ollama').addEventListener('click', detectOllamaModels);
            document.getElementById('pull-model').addEventListener('click', pullOllamaModel);

            // Template buttons
            document.querySelectorAll('.template-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const template = e.target.dataset.template;
                    applyTemplate(template);
                });
            });
        }

        // Select a model
        function selectModel(modelId) {
            currentModel = modelManager.getModel(modelId);
            if (!currentModel) {
                showError('Model not found');
                return;
            }

            // Update UI
            document.querySelectorAll('.model-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.querySelector(`[data-model-id="${modelId}"]`)?.classList.add('selected');

            // Show/hide API key field based on provider
            if (currentModel.provider === 'openai' || currentModel.provider === 'anthropic') {
                elements.apiKeyGroup.style.display = 'block';
                elements.apiKey.placeholder = `Enter ${currentModel.provider.toUpperCase()} API key...`;
            } else {
                elements.apiKeyGroup.style.display = 'none';
            }

            // Update configuration fields
            elements.temperature.value = currentModel.temperature || 0.7;
            elements.maxTokens.value = currentModel.maxTokens || 2048;

            updateModelInfo();
        }

        // Update model info display
        function updateModelInfo() {
            if (currentModel) {
                elements.currentModelInfo.innerHTML = `
                    <strong>${currentModel.name}</strong>
                    <span class="status-indicator status-success">Selected</span>
                `;
            } else {
                elements.currentModelInfo.innerHTML = '<span class="status-indicator status-warning">No model selected</span>';
            }
        }

        // Send message to AI
        async function sendMessage() {
            const message = elements.chatInput.value.trim();
            if (!message || !currentModel) {
                if (!currentModel) {
                    showError('Please select a model first');
                }
                return;
            }

            // Check if this is an MPD/Mermaid related request
            const isMPDOrMermaidRequest = /\b(mpd|mermaid|diagram|flowchart|sequence|class|gantt|state|presentation)\b/i.test(message);
            
            // Build message array with system prompt if needed
            let messages = [...chatHistory];
            
            if (isMPDOrMermaidRequest && chatHistory.length === 0) {
                // Add system prompt for new MPD/Mermaid conversations
                messages.unshift({ 
                    role: 'system', 
                    content: getSystemPrompt() 
                });
            }
            
            messages.push({ role: 'user', content: message });

            // Add user message to chat
            addMessageToChat('user', message);
            elements.chatInput.value = '';
            elements.sendButton.disabled = true;
            elements.sendButton.innerHTML = '<div class="loading"></div>';

            try {
                const response = await modelManager.chat({
                    model: currentModel.id,
                    messages: messages,
                    options: {
                        temperature: parseFloat(elements.temperature.value),
                        maxTokens: parseInt(elements.maxTokens.value)
                    }
                });

                const assistantMessage = response.choices[0].message.content;
                addMessageToChat('assistant', assistantMessage, { 
                    showSystemPromptIndicator: isMPDOrMermaidRequest 
                });
                
                // Update history (store actual messages without system prompt for UI)
                chatHistory.push(
                    { role: 'user', content: message },
                    { role: 'assistant', content: assistantMessage }
                );

            } catch (error) {
                showError(`Chat error: ${error.message}`);
                addMessageToChat('assistant', `‚ùå Error: ${error.message}`);
            } finally {
                elements.sendButton.disabled = false;
                elements.sendButton.innerHTML = 'Send';
            }
        }

        // Add message to chat
        function addMessageToChat(role, content, options = {}) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            let contentHtml = `<div class="message-content">${escapeHtml(content)}</div>`;
            
            if (options.showSystemPromptIndicator) {
                contentHtml = `
                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.5rem;">
                        ü§ñ Using MPD/Mermaid system prompt with BNF grammar
                    </div>
                    ${contentHtml}
                `;
            }
            
            messageDiv.innerHTML = contentHtml;
            elements.chatMessages.appendChild(messageDiv);
            elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
        }

        // Save configuration
        function saveConfiguration() {
            if (!currentModel) {
                showError('No model selected');
                return;
            }

            // Update model configuration
            if (currentModel.provider === 'openai' || currentModel.provider === 'anthropic') {
                currentModel.apiKey = elements.apiKey.value;
            }
            currentModel.temperature = parseFloat(elements.temperature.value);
            currentModel.maxTokens = parseInt(elements.maxTokens.value);
            currentModel.enabled = true;

            // Update in model manager
            modelManager.addModel(currentModel);
            
            showSuccess('Configuration saved successfully');
        }

        // Test connection
        async function testConnection() {
            if (!currentModel) {
                showError('No model selected');
                return;
            }

            const button = document.getElementById('test-connection');
            button.disabled = true;
            button.innerHTML = '<div class="loading"></div>';

            try {
                await modelManager.chat({
                    model: currentModel.id,
                    messages: [{ role: 'user', content: 'Hello, this is a connection test.' }],
                    options: { maxTokens: 10 }
                });
                showSuccess('Connection test successful');
            } catch (error) {
                showError(`Connection test failed: ${error.message}`);
            } finally {
                button.disabled = false;
                button.innerHTML = 'Test Connection';
            }
        }

        // Check Ollama status
        async function checkOllamaStatus() {
            try {
                const models = await modelManager.detectOllamaModels();
                if (models.length > 0) {
                    elements.ollamaStatus.innerHTML = `
                        <span class="status-indicator status-success">
                            Connected (${models.length} models: ${models.slice(0, 3).join(', ')}${models.length > 3 ? '...' : ''})
                        </span>
                    `;
                } else {
                    elements.ollamaStatus.innerHTML = `
                        <span class="status-indicator status-warning">
                            Connected (no models detected)
                        </span>
                    `;
                }
            } catch (error) {
                elements.ollamaStatus.innerHTML = `
                    <span class="status-indicator status-error">
                        Not connected (is Ollama running?)
                    </span>
                `;
            }
        }

        // Detect Ollama models
        async function detectOllamaModels() {
            const button = document.getElementById('detect-ollama');
            button.disabled = true;
            button.innerHTML = '<div class="loading"></div>';

            try {
                const detectedModels = await autoDetectAndAddOllamaModels();
                await loadModels(); // Refresh model list
                await checkOllamaStatus();
                showSuccess(`Found and added ${detectedModels.length} Ollama models`);
            } catch (error) {
                showError(`Failed to detect models: ${error.message}`);
            } finally {
                button.disabled = false;
                button.innerHTML = 'Detect Models';
            }
        }

        // Pull Ollama model
        async function pullOllamaModel() {
            const modelName = prompt('Enter model name to pull (e.g., qwen3-coder:30b):');
            if (!modelName) return;

            const button = document.getElementById('pull-model');
            button.disabled = true;
            button.innerHTML = '<div class="loading"></div>';

            try {
                await modelManager.pullOllamaModel(modelName);
                await loadModels(); // Refresh model list
                await checkOllamaStatus();
                showSuccess(`Successfully pulled ${modelName}`);
            } catch (error) {
                showError(`Failed to pull model: ${error.message}`);
            } finally {
                button.disabled = false;
                button.innerHTML = 'Pull Model';
            }
        }

        // Apply template with comprehensive system prompts
        function applyTemplate(templateType) {
            const systemPrompt = getSystemPrompt();
            const templates = {
                'generate-mpd': `${systemPrompt}

Generate a complete MPD presentation for a software architecture diagram. The user will provide a Mermaid diagram, and you need to create MPD code that:

1. Creates an overview step showing the full diagram
2. Adds detail steps for each major component
3. Includes data flow steps showing connections
4. Provides navigation controls (arrow keys, clicks)
5. Adds informative overlay bubbles for context

Requirements:
- Use proper target expressions (dataId, node, edge)
- Include smooth camera animations (fit, reset, pan)
- Add style highlights for focus
- Include helpful overlay text
- Ensure all steps have unique IDs
- Add both keyboard and click navigation

Please generate the MPD code wrapped in a code block with mpd syntax highlighting.`,
                
                'explain-concept': `${systemPrompt}

Explain the concept of microservices architecture as if I'm a software engineering student. Include:

1. Clear definition and core principles
2. Benefits and advantages
3. Challenges and trade-offs
4. Real-world examples
5. When to use vs when not to use
6. Best practices and patterns

Please provide a comprehensive explanation with examples, and if relevant, include a simple Mermaid diagram to illustrate the concept.`,
                
                'code-review': `${systemPrompt}

Review this TypeScript code and provide constructive feedback:

\`\`\`typescript
// paste your code here
\`\`\`

Focus on:
1. Code quality and best practices
2. Performance considerations
3. Type safety improvements
4. Error handling
5. Code organization and readability
6. Potential bugs or edge cases

Provide specific, actionable suggestions with code examples where helpful.`,
                
                'creative-presentation': `${systemPrompt}

Give me creative ideas for a presentation about renewable energy. Include:

1. Compelling title and hook
2. Slide structure and flow
3. Key talking points for each slide
4. Visual suggestions (including Mermaid diagrams where applicable)
5. Engagement strategies
6. Strong conclusion

If including diagrams, provide the Mermaid syntax for them and suggest MPD presentation steps to guide the audience through the visual content.`,
                
                'mermaid-generator': `${systemPrompt}

You are a Mermaid diagram expert. Generate high-quality Mermaid diagrams based on user requirements. Always:

1. Choose the appropriate diagram type (flowchart, sequence, class, etc.)
2. Follow Mermaid syntax best practices
3. Include proper styling and theming
4. Add clear labels and descriptions
5. Ensure the diagram is readable and well-organized

Provide the complete Mermaid code in a code block and explain any design choices made.`
            };

            elements.chatInput.value = templates[templateType] || '';
            elements.chatInput.focus();
        }

        // Get comprehensive system prompt for MPD and Mermaid
        function getSystemPrompt() {
            return `You are an expert in Finsteps, MPD (Mermaid Presentation DSL), and Mermaid diagrams. You have deep knowledge of:

=== MPD (Mermaid Presentation DSL) Grammar ===

MPD is a declarative language for defining interactive presentations over Mermaid diagrams.

PROGRAM STRUCTURE:
\`\`\`mpd
mpd 1.0

deck {
  scene default {
    step overview {
      camera reset();
      overlay bubble(target: dataId("A"), text: "Welcome!");
    }
  }
}
\`\`\`

CORE CONSTRUCTS:
- Deck: Root container for presentation content
- Scene: Groups related steps, can reference specific diagrams  
- Step: Defines presentation state with actions
- Binding: Event-to-action mappings

TARGET EXPRESSIONS:
- node("A") - Node by ID
- edge("A", "B") - Edge between nodes
- dataId("element-id") - Element by data-id attribute
- css(".selector") - CSS selector
- id("element-id") - Element by ID
- text("Label") - Element by text content

ACTIONS:
Camera Actions:
- camera fit(target: dataId("A"), padding: 60, duration: 500)
- camera reset()
- camera zoom(factor: 1.2)
- camera pan(deltaX: 50, deltaY: 0)
- camera fitAll(padding: 40)

Style Actions:
- style highlight(target: dataId("A"))
- style clear()
- style classAdd(target: node("B"), className: "active")
- style classRemove(target: node("B"), className: "inactive")

Overlay Actions:
- overlay bubble(target: dataId("A"), text: "Important note!")
- overlay hide(id: "bubble-1")

Navigation Actions:
- nav.next()
- nav.prev() 
- nav.goto(id: "overview")
- nav.goto(index: 2)
- nav.reset()

BINDINGS:
\`\`\`mpd
binding {
  on click target node("A") {
    do nav.goto(id: "detail");
  }
  on key "ArrowRight" {
    do nav.next();
  }
}
\`\`\`

RUNTIME CONFIGURATION:
\`\`\`mpd
runtime {
  camera {
    engine: "basic";
    bounds: viewport;
  }
  navigation {
    wheelZoom: true;
    dragPan: true;
    startAt: "overview";
  }
}
\`\`\`

=== Mermaid Diagram Types ===

COMMON DIAGRAM TYPES:
1. Flowchart: process flows, decision trees
   \`\`\`mermaid
   flowchart LR
     A[Start] --> B{Decision}
     B -->|Yes| C[Action 1]
     B -->|No| D[Action 2]
   \`\`\`

2. Sequence Diagram: interactions between actors
   \`\`\`mermaid
   sequenceDiagram
     participant A as User
     participant B as System
     A->>B: Request
     B->>A: Response
   \`\`\`

3. Class Diagram: software architecture
   \`\`\`mermaid
   classDiagram
     class User {
       +name: string
       +login()
     }
     User --> Order : places
   \`\`\`

4. State Diagram: state machines
   \`\`\`mermaid
   stateDiagram-v2
     [*] --> Active
     Active --> Inactive
     Inactive --> Active
   \`\`\`

5. Gantt Chart: project timelines
   \`\`\`mermaid
   gantt
     title Project Timeline
     section Phase 1
     Task A : 2024-01-01, 7d
     Task B : 2024-01-08, 3d
   \`\`\`

BEST PRACTICES:
1. Use clear, descriptive IDs for nodes
2. Keep diagrams focused and readable
3. Use appropriate diagram types for the data
4. Include helpful labels and annotations
5. Consider accessibility and color choices
6. Test diagram syntax before using

For MPD presentations:
1. Start with overview, then zoom to details
2. Use consistent navigation patterns
3. Add informative overlay text
4. Ensure smooth transitions between steps
5. Include both keyboard and mouse controls
6. Test the presentation flow

Generate clean, valid code following these specifications.`;
        }

        // Utility functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showError(message) {
            showNotification(message, 'error');
        }

        function showSuccess(message) {
            showNotification(message, 'success');
        }

        function showNotification(message, type) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `status-indicator status-${type}`;
            notification.textContent = message;
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '1000';
            notification.style.padding = '1rem 1.5rem';
            notification.style.borderRadius = '6px';
            notification.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';

            document.body.appendChild(notification);

            // Remove after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Initialize application
        init();
    </script>
</body>
</html>